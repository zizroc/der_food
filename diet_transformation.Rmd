---
title: "Diet Shifts"
author: "Marcus J Thomson"
date: "10/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyr)
library(dplyr)
library(purrr)
library(ggplot2)
library(cowplot)
library(zoo)
library(scales)
library(readr)
library(RColorBrewer)
```

# Dietary Shift Pathways

Here I calculate pathway trajectories from the present food/feed supply patterns to hypothetical future patterns based on demands from the projections calculated in `iep_healthy_food.Rmd`.

```{r}
wd_path <- getwd()
data_path <- paste0(wd_path, "/Data")
```

## FAO Food Balance Data

Read in Food Balance data from FAOSTAT. Source: [FAOSTAT.](http://www.fao.org/faostat/en/#data/FBS)

```{r}
foodbalance_df <- readr::read_csv(
  file = paste0(data_path, "/FoodBalanceSheets_E_All_Data_(Normalized).csv"),
  col_types = cols(
    `Area Code` = col_double(),
    Area = col_character(),
    `Item Code` = col_double(),
    Item = col_character(),
    `Element Code` = col_double(),
    Element = col_character(),
    `Year Code` = col_double(),
    Year = col_double(),
    Unit = col_character(),
    Value = col_double(),
    Flag = col_character()
  )) %>% 
  rename(
    "area_code" = "Area Code",
    "area" = "Area",
    "item_code" = "Item Code",
    "item" = "Item",
    "element_code" = "Element Code",
    "element" = "Element",
    "year_code" = "Year Code",
    "year" = "Year",
    "unit" = "Unit",
    "value" = "Value",
    "flag" = "Flag"
  )
  
```

I made a separate CSV file to map the FAO elements/element codes onto the model_groups I use for this analysis.

```{r}
foodbalance_map <- readr::read_csv(
  file = paste0(data_path, "/Daily Energy Requirements for Humans - food_map.csv"),
  col_types = cols(
    item_code = col_double(),
    item = col_character(),
    model_group1 = col_character(),
    model_group = col_character()
  )
)


```

Select only those elements that have to do with food and food supply.

```{r}

food_elements <- data.frame(
  element <- c("Food", "Food supply"),
  units <- c("1000 t/yr", "kcal/cap/yr"),
  element_code <- c(5142, 664)
)

```

Merge the FAO df with the foodbalance mapper to create clean dfs `food_df` and `feed_df`.

```{r}
food_df <- foodbalance_df %>%
  dplyr::filter(element_code %in% c(5142)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na()

feed_df <- foodbalance_df %>%
  dplyr::filter(element_code %in% c(5521)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na()

```

Aggregate tonnes of food/feed by model_group.

```{r}

food_countries <- food_df %>% 
  dplyr::group_by(area_code, area, year, model_group) %>% 
  dplyr::summarise(tonnes_yr = 1e3*sum(value, na.rm = TRUE), 
                   .groups = "drop")

feed_countries <- feed_df %>% 
  dplyr::group_by(area_code, area, year, model_group) %>% 
  dplyr::summarise(tonnes_yr = 1e3*sum(value, na.rm = TRUE), 
                   .groups = "drop")

```

Let's have a look at world production of food and feed.

```{r}

food_world <- food_countries %>% 
  dplyr::filter(area == "World") 
feed_world <- feed_countries %>% 
  dplyr::filter(area == "World") 

food_grouped_data <- food_world %>% 
  dplyr::mutate(source_group = ifelse(model_group %in% c("beef_lamb_pork", "meat_poultry", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products")), 
                crop_class = "food")

feed_grouped_data <- feed_world %>% 
  dplyr::mutate(source_group = ifelse(model_group %in% c("beef_lamb_pork", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products")), 
                crop_class = "feed")

```

```{r}
food_feed_grouped_data <- food_grouped_data %>% 
  dplyr::bind_rows(feed_grouped_data)
```

Visualise total annual global food and feed supply.

```{r}
p1 <- ggplot(food_feed_grouped_data, 
       aes(x = year, 
           y = tonnes_yr*1e-9)) + 
  geom_col(aes(fill = crop_class), position = "stack", alpha = 0.8) + 
  geom_hline(yintercept = 0, alpha = 0.9) + 
  theme_minimal() + 
  theme(
    legend.position = "top", 
    legend.title = element_blank(), 
    axis.title.x = element_blank()
  ) + 
  scale_x_continuous(breaks = seq(2010,2019,by=1)) + 
  labs(
    title = "Global production of agricultural food and feed", 
    y = "Gt/year", 
    caption = "Data: FAOSTAT FBS (2022)"
  )

p1
```

How does this compare to demand in future?

```{r}
population <- foodbalance_df %>% 
  dplyr::filter(element_code %in% c(511)) %>% 
  dplyr::filter(area == "World") %>% 
  dplyr::select(area, year, value) %>% 
  dplyr::rename(thousand_persons = value)
foodsupply <- foodbalance_df %>% 
  dplyr::filter(element_code %in% c(664)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(food_source = ifelse(model_group %in% c("beef_lamb_pork", "meat_poultry", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products"))) %>% 
  dplyr::filter(area == "World") %>% 
  dplyr::group_by(area, year, unit, food_source) %>% 
  dplyr::summarise(kcal_cap_day = sum(value), 
                   .groups = "drop")

fao_kcal_df <- population %>% 
  dplyr::full_join(foodsupply) %>% 
  dplyr::mutate(M_kcal_per_day = kcal_cap_day*thousand_persons * 1e-3, 
         diet_plan = "FAO", 
         SCENARIO = "FAO") %>% 
  dplyr::select(SCENARIO, diet_plan, year, food_source, M_kcal_per_day)

fao_kcal_diff <- fao_kcal_df %>% 
  dplyr::full_join(all_plans_long %>% 
  dplyr::filter(year >= 2020)) %>% 
  dplyr::mutate(M_kcal_per_day_2018 = ifelse(year == 2018, M_kcal_per_day, NA)) %>% 
  dplyr::group_by(food_source) %>% 
  tidyr::fill(M_kcal_per_day_2018) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(year >= 2018) %>% 
  dplyr::mutate(diff = M_kcal_per_day - M_kcal_per_day_2018, 
                pc_diff = diff/M_kcal_per_day_2018)

fao_kcal_diff <- fao_kcal_diff %>% 
  dplyr::mutate(diet_plan_f = diet_plan)
fao_kcal_diff$diet_plan_f <- factor(fao_kcal_diff$diet_plan_f, levels = c("ELA-PHD", "CNS-CFP", "FDA-SDP"))

# fao_kcal_diff
```

```{r}
cols <-
  c(
    "animal_products" = "#F17EB8",
    # "dairy" = "#DED560",
    "fish_seafood" = "#489ED3",
    "plant_products" = "#EEAF35"
  )
xlabz <- c("ELA", "CNS", "USDA")
labz <-
  c("Animal Products", "Fish and Seafood", "Plant Products")

ymin <- min(fao_kcal_diff$pc_diff)
ymax <- max(fao_kcal_diff$pc_diff)


p2a <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
   scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  scale_x_discrete(labels = xlabz) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP1", y = "Relative to 2018 supply") +
  facet_wrap( ~ year)

p2_legend_only <- cowplot::get_legend(p2a)

p2a <- p2a +
  theme(legend.position = "none")

p2b <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
   aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  scale_x_discrete(labels = xlabz) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)

p2c <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  scale_x_discrete(labels = xlabz) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)

p2d <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  scale_x_discrete(labels = xlabz) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP4", y = "Relative to 2018 supply") +
  facet_wrap( ~ year)

p2e <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  scale_x_discrete(labels = xlabz) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP5") +
  facet_wrap( ~ year)
```

```{r}

p2 <- cowplot::plot_grid(p2a, p2b, p2c, p2d, p2e, p2_legend_only)
p2
```

Plot the same as above with ranges only for SSPs.

```{r}
fao_kcal_diff_ranges <- fao_kcal_diff %>%
  dplyr::filter(diet_plan != "FAO") %>%
  dplyr::group_by(diet_plan_f, year, food_source) %>%
  dplyr::summarise(
    diff_mean = mean(diff, na.rm = TRUE),
    diff_max = max(diff, na.rm = TRUE),
    diff_min = min(diff, na.rm = TRUE),
    pc_diff_mean = mean(pc_diff, na.rm = TRUE),
    pc_diff_max = max(pc_diff, na.rm = TRUE),
    pc_diff_min = min(pc_diff, na.rm = TRUE),
    .groups = "drop"
  )

fao_kcal_diff_ranges
```

```{r}

legend_only_test <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_col(aes(fill = food_source), 
           alpha = 0.8, position = "dodge") +
  scale_fill_manual(values = cols,
                    labels = labz) +
  scale_x_discrete(labels = xlabz) +
  theme(
    legend.title = element_blank(),
    legend.direction = "horizontal"
    ) + 
  facet_wrap(~ year)

p3_legend_only <- cowplot::get_legend(legend_only_test)

p3a <- ggplot(
  fao_kcal_diff_ranges %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)) %>%
    dplyr::filter(food_source == "animal_products"),
  aes(x = diet_plan_f,
      y = pc_diff_mean)
) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") +
  geom_errorbar(
    aes(ymin = pc_diff_min, ymax = pc_diff_max),
    width = 0.1,
    alpha = 0.8,
    position = position_dodge(0.9)
  ) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  scale_fill_manual(values = cols,
                    labels = labz) +
  scale_x_discrete(labels = xlabz) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10), 
                     labels = scales::label_percent(accuracy = 1)) + 
  theme_bw() +
  theme(
     axis.text.y = element_text(
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none",
    panel.grid.major.y = element_line(colour = "grey"),
    panel.grid.minor.y = element_line(colour = "grey"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(), 
    axis.text.x = element_blank(), 
    axis.title.y = element_blank()
  ) + 
  labs(
    subtitle = "Change in demand relative to FAO 2018 supply"
  ) + 
  facet_wrap(~ year)

p3b <- ggplot(
  fao_kcal_diff_ranges %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)) %>%
    dplyr::filter(food_source == "fish_seafood"),
  aes(x = diet_plan_f,
      y = pc_diff_mean)
) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") +
  geom_errorbar(
    aes(ymin = pc_diff_min, ymax = pc_diff_max),
    width = 0.1,
    alpha = 0.8,
    position = position_dodge(0.9)
  ) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  scale_fill_manual(values = cols,
                    labels = labz) +
  scale_x_discrete(labels = xlabz) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10), 
                     labels = scales::label_percent(accuracy = 1)) + 
  theme_bw() +
  theme(
     axis.text.y = element_text(
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none",
    panel.grid.major.y = element_line(colour = "grey"),
    panel.grid.minor.y = element_line(colour = "grey"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(), 
    axis.text.x = element_blank(), 
    axis.title.y = element_blank()
  ) + 
  facet_wrap(~ year)

p3c <- ggplot(
  fao_kcal_diff_ranges %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)) %>%
    dplyr::filter(food_source == "plant_products"),
  aes(x = diet_plan_f,
      y = pc_diff_mean)
) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") +
  geom_errorbar(
    aes(ymin = pc_diff_min, ymax = pc_diff_max),
    width = 0.1,
    alpha = 0.8,
    position = position_dodge(0.9)
  ) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  scale_fill_manual(values = cols,
                    labels = labz) +
  scale_x_discrete(labels = xlabz) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10), 
                     labels = scales::label_percent(accuracy = 1)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      size = 10
    ), 
     axis.text.y = element_text(
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none",
    panel.grid.major.y = element_line(colour = "grey"),
    panel.grid.minor.y = element_line(colour = "grey"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) + 
  labs(
    y = "Relative to 2018 supply"
  ) + 
  facet_wrap(~ year)
```

```{r}

cowplot::plot_grid(p3a, p3b, p3c, p3_legend_only, ncol = 1, rel_heights = c(1, 0.8, 0.9, 0.2))

```

```{r}

ymin <- -5
ymax <- 6

p3a <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-6)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
   scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP1", y = "Tkcal/day over 2018 supply") +
  facet_wrap( ~ year)

p3_legend_only <- cowplot::get_legend(p3a)

p3a <- p3a +
  theme(legend.position = "none")

p3b <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
   aes(x = diet_plan_f,
      y = diff * 1e-6)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)

p3c <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-6)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)

p3d <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-6)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP4", y = "Tkcal/day over 2018 supply") +
  facet_wrap( ~ year)

p3e <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-6)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP5") +
  facet_wrap( ~ year)
```

```{r}

p3 <- cowplot::plot_grid(p3a, p3b, p3c, p3d, p3e, p3_legend_only)
p3
```

```{r}
tmp1 <- food_feed_grouped_data %>% 
  dplyr::group_by(area, year, crop_class) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(SCENARIO = "FAO", 
                diet_plan_f = factor("FAO")) %>% 
  dplyr::select(SCENARIO, year, diet_plan_f, crop_class, tonnes_yr)
tmp2 <- global_crop_demand_food_feed_diff %>% 
  dplyr::select(SCENARIO, year, diet_plan_f, crop_class, tonnes_yr) %>% 
  dplyr::filter(year >= 2020)

tmp3 <- full_join(tmp1, tmp2)

ggplot(tmp1,  
      aes(x = year, y = tonnes_yr)) + 
  geom_col(aes(fill = crop_class), position = "stack") + 
  coord_cartesian(ylim = c(0, 1.2e10))

ggplot(tmp2 %>% 
        dplyr::filter(diet_plan_f == "ELA-PHD", SCENARIO == "SSP3_v9_130115"), 
      aes(x = year, y = tonnes_yr)) + 
  geom_col(aes(fill = crop_class), position = "stack") + 
  coord_cartesian(ylim = c(0, 1.2e10))

ggplot(tmp3 %>% 
         dplyr::filter(diet_plan_f %in% c("FAO", "FDA-SDP"), SCENARIO == "SSP3_v9_130115"), 
       aes(x = year, y = tonnes_yr)) + 
  geom_col(aes(fill = crop_class), position = "stack") + 
  coord_cartesian(xlim = c(2014, 2100))
```

```{r}
diet_diffs <- tmp3 %>% 
  dplyr::mutate(tonnes_yr_2018 = ifelse(year == 2018, tonnes_yr, NA)) %>% 
  dplyr::group_by(crop_class) %>% 
  tidyr::fill(tonnes_yr_2018) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(year >= 2018) %>% 
  dplyr::mutate(diff = tonnes_yr - tonnes_yr_2018, 
                pc_diff = diff/tonnes_yr_2018)
```

```{r}
# diet_diffs
```

```{r}
cols <- data.frame(
  food = "#EEAF35", 
  feed = "#F17EB8"
)
labz <- c("food", "feed")

# ymax <- (max(global_crop_demand_food_feed_diff$diff) + 0.05 * max(global_crop_demand_food_feed_diff$diff)) * 1e-9
# ymin <- 0

ymax <- 0.9
ymin <- -0.55 


p2a <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  #  scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP1", y = "Relative to 2018 demand") +
  facet_wrap( ~ year)

labz <- c("food", "feed")
p2_legend_only <- cowplot::get_legend(p2a)

p2a <- p2a +
  theme(legend.position = "none")

p2b <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
   aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)

p2c <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)

p2d <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP4") +
  facet_wrap( ~ year)

p2e <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP5", y = "Relative to 2018 demand") +
  facet_wrap( ~ year)
```

Axis arrows

```{r}
mitigate_arrow <- ggplot(data = data.frame(x = c(0,1), y = c(0,1)), 
       aes(x = x, y = y)) + 
  annotate("segment", x = 0, xend = 0, y = 0, yend = 1, arrow = arrow()) + 
  annotate("text", x = -0.02, y = 0.5, label = "Socio-economic challenges for mitigation", size = 4, angle = 90) + 
  theme_minimal() + 
  theme(
    axis.title = element_blank(), 
    axis.text = element_blank(), 
    panel.grid = element_blank()
  ) + 
  coord_cartesian(xlim = c(-0.04,0.04), y = c(0, 1))

adapt_arrow <- ggplot(data = data.frame(x = c(0,1), y = c(0,1)), 
       aes(x = x, y = y)) + 
  annotate("segment", x = 0, xend = 1, y = 0, yend = 0, arrow = arrow()) + 
  annotate("text", x = 0.5, y = 0.025, label = "Socio-economic challenges for adaptation", size = 4) + 
  theme_minimal() + 
  theme(
    axis.title = element_blank(), 
    axis.text = element_blank(), 
    panel.grid = element_blank()
  ) + 
  coord_cartesian(xlim = c(0,1), y = c(-0.04, 0.04))

# mitigate_arrow
# adapt_arrow
```

```{r}

# p2 <- cowplot::plot_grid(p2a, p2b, p2c, p2d, p2e, p2_legend_only)
pa <- plot_grid(p2e, p2a, ncol = 1)
pb <- plot_grid(p2_legend_only, p2b, NA, ncol = 1, rel_heights = c(0.5, 1, 0.5))
pc <- plot_grid(p2c, p2d, ncol = 1)

p2 <- cowplot::plot_grid(pa, pb, pc, ncol = 3)
cowplot::plot_grid(mitigate_arrow, p2, NA, adapt_arrow, ncol = 2, rel_widths = c(0.1, 0.9), rel_heights = c(0.9, 0.1))
```

```{r}
cols <- data.frame(
  food = "#EEAF35", 
  feed = "#F17EB8"
)
labz <- c("food", "feed")

diets <- c("ELA", "CNS", "USDA")

# ymax <- (max(global_crop_demand_food_feed_diff$diff) + 0.05 * max(global_crop_demand_food_feed_diff$diff)) * 1e-9
# ymin <- 0

ymax <- 3.5
ymin <- -3 


p3a <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-9)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  scale_x_discrete(labels = diets) + 
  #  scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5, 
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP1", y = "Gt over 2018 demand") +
  facet_wrap( ~ year)

p3_legend_only <- cowplot::get_legend(p3a)

p3a <- p3a +
  theme(legend.position = "none")

p3b <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
   aes(x = diet_plan_f,
      y = diff * 1e-9)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  scale_x_discrete(labels = diets) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5, 
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)

p3c <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-9)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  scale_x_discrete(labels = diets) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5, 
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)

p3d <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-9)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  scale_x_discrete(labels = diets) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5, 
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP4") +
  facet_wrap( ~ year)

p3e <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-9)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  scale_x_discrete(labels = diets) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5, 
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP5", y = "Gt over 2018 demand") +
  facet_wrap( ~ year)
```

```{r}

pa <- plot_grid(p3e, p3a, ncol = 1)
pb <- plot_grid(p3_legend_only, p3b, NA, ncol = 1, rel_heights = c(0.5, 1, 0.5))
pc <- plot_grid(p3c, p3d, ncol = 1)

p3 <- cowplot::plot_grid(pa, pb, pc, ncol = 3)
cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_widths = c(0.1, 0.9), rel_heights = c(0.9, 0.1))

# p3 <- cowplot::plot_grid(p3a, p3b, p3c, p3d, p3e, p3_legend_only)
# p3
```

Relative change.

```{r}
ymax <- 0.9
ymin <- -0.6


p4a <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  scale_x_discrete(labels = diets) + 
  #  scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5, 
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP1", y = "Change over 2018 supply") +
  facet_wrap( ~ year)

p4_legend_only <- cowplot::get_legend(p4a)

p4a <- p4a +
  theme(legend.position = "none")

p4b <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
   aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  scale_x_discrete(labels = diets) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5, 
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)

p4c <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  scale_x_discrete(labels = diets) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5, 
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)

p4d <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  scale_x_discrete(labels = diets) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5, 
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP4") +
  facet_wrap( ~ year)

p4e <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  scale_x_discrete(labels = diets) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5, 
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP5", y = "Change over 2018 supply") +
  facet_wrap( ~ year)

```

```{r}

pa <- plot_grid(p4e, p4a, ncol = 1)
pb <- plot_grid(p4_legend_only, p4b, NA, ncol = 1, rel_heights = c(0.5, 1, 0.5))
pc <- plot_grid(p4c, p4d, ncol = 1)

p3 <- cowplot::plot_grid(pa, pb, pc, ncol = 3)
cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_widths = c(0.1, 0.9), rel_heights = c(0.9, 0.1))

# p3 <- cowplot::plot_grid(p3a, p3b, p3c, p3d, p3e, p3_legend_only)
# p3
```

Return to the projections computed earlier. Recall: the projections were based on a bottom-up calculation of food and feed weight based on caloric demands for healthy diets, under the five SSPs and three diet plans.

Merge the data with the projections computed earlier.

```{r}
food_feed_data_scenario <- food_feed_grouped_data %>% 
  dplyr::mutate(SCENARIO = "FAOSTAT", 
                diet_plan = "FAO-FBdata") %>% 
  dplyr::group_by(SCENARIO, diet_plan, year, crop_class) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::bind_rows(
    global_crop_demand_food_feed %>%
  dplyr::select(-tonnes_day)
  )

```

To test the skill of the bottom-up calculation, compare to the food balance data. I run a short check of the data with a visualisation below.

```{r}
compare <- global_crop_demand_food_feed %>% 
  dplyr::select(-tonnes_day) %>% 
  dplyr::bind_rows(food_grouped_data %>% 
  group_by(year) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(diet_plan = "FAO-FB", 
                crop_class = "food", 
                SCENARIO = "FAO_FoodBalance_data") %>% 
  dplyr::select(SCENARIO, diet_plan, year, crop_class, tonnes_yr))


```

The plotted points appear roughly in line with the healthy "US-style" diet from the FDA.

```{r}

p2 <- ggplot(data = food_feed_data_scenario %>% 
         dplyr::filter(SCENARIO != "FAOSTAT", 
                       crop_class == "food"), 
       aes(x = year, 
           y = tonnes_yr)) + 
  geom_line(aes(colour = diet_plan)) + 
  geom_point(data = food_feed_data_scenario %>% 
         dplyr::filter(SCENARIO == "FAOSTAT", 
                       crop_class == "food") %>% 
           dplyr::select(-SCENARIO), 
         aes(x = year, 
             y = tonnes_yr), 
         size = 0.5, 
         shape = 3) + 
  facet_wrap(~SCENARIO)

p2

```

Shift diets by 2050 and by 2075, for each SSP.

Shift by 2050. Interpolate lowest acceleration pathway for each food/feed type to its target value.

1.  Linearly extrapolate data values from 2014-18 to 2022.
2.  Find the lowest-energy trajectory from 2022 to the target year, 2050 or 2075. The lowest energy should have the constraints: (i) lowest second derivative wrt time; (ii) first derivative that equals the slope of the line at 2022; (iii) passes through the appropriate values at 2022 and 2050. A spline should be appropriate.

Recode country names and merge with regions.

```{r}
Food_countries <- food_countries %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::select(-area) %>% 
  dplyr::left_join(loc_map_reduced, by = "fao_countrycode")

Feed_countries <- feed_countries %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::select(-area) %>% 
  dplyr::left_join(loc_map_reduced, by = "fao_countrycode")
```

Do some cleanup first because some ISOa3 codes are not included.

```{r}
food_2014_2018_data <- Food_countries %>% 
  dplyr::filter(year >= 2014 & year <= 2018) %>% 
  dplyr::select(year, model_group, tonnes_yr, iso_alpha3) %>%
  tidyr::drop_na()

feed_2014_2018_data <- Feed_countries %>% 
  dplyr::filter(year >= 2014 & year <= 2018) %>%
  dplyr::select(year, model_group, tonnes_yr, iso_alpha3) %>%
  tidyr::drop_na()
```

Fit linear models to data and predict to extrapolate to 2022. NB: In some cases, the fitter projects negative production values. These are zeroed out.

```{r}
yrs <- data.frame(year = seq(2019, 2022, by = 1))

food_2019_2022_lm <- food_2014_2018_data %>%
  dplyr::group_by(iso_alpha3, model_group) %>%
  tidyr::nest() %>%
  dplyr::mutate(models = lapply(data, function(df)
    lm(tonnes_yr ~ year, data = df))) %>%
  dplyr::mutate(lm_pred = map(models, ~ predict(., yrs))) %>%
  # dplyr::mutate(lm_pred = map(models, ~predict(., yrs))) %>%
  dplyr::ungroup() %>%
  tidyr::unnest(cols = c(lm_pred)) %>%
  dplyr::select(iso_alpha3, model_group, lm_pred) %>%
  dplyr::mutate(year = rep(seq(2019, 2022, by = 1), 2288)) %>%
  dplyr::rename(tonnes_yr = lm_pred) %>%
  dplyr::mutate(tonnes_yr = ifelse(tonnes_yr < 0, 0, tonnes_yr))
 
```

Do something similar for feed: mean values are fine -- the fitter is throwing rank-deficient fit warnings from some instances.

```{r, warning=FALSE}
feed_2019_2022_lm <- feed_2014_2018_data %>%
  dplyr::group_by(iso_alpha3, model_group) %>%
  tidyr::nest() %>%
  dplyr::mutate(
    models_lm = lapply(data, function(df) lm(tonnes_yr ~ year, data = df)), 
    lm_pred = map(models_lm, ~predict(., yrs))) %>%
  # dplyr::mutate(lm_pred = map(models, ~predict(., yrs))) %>%
  dplyr::ungroup() %>%
  tidyr::unnest(cols = c(lm_pred)) %>%
  dplyr::select(iso_alpha3, model_group, lm_pred) %>%
  dplyr::mutate(year = rep(seq(2019, 2022, by = 1), 1306)) %>%
  dplyr::rename(tonnes_yr = lm_pred)

```

Bind to make harmonized (historical and future projected) food and feed dfs
```{r}
food_2014_2022_est <- food_2014_2018_data %>% 
  bind_rows(food_2019_2022_lm)

feed_2014_2022_est <- feed_2014_2018_data %>% 
  bind_rows(feed_2019_2022_lm)
```

Use crop weight of food and crop ingredient weight of feed from earlier. We will only use the data for years 2023 and after.

```{r}
# # save(food_weight, file = paste0(data_path, "food_weight.Rdata"))
# load(file = paste0(data_path, "food_weight.Rdata")) #food_weight
# 
# # save(feed_ingredient_demand_summary, file = paste0(data_path, "feed_ingredient_demand_summary.Rdata"))
# load(file = paste0(data_path, "feed_ingredient_demand_summary.Rdata")) #feed_ingredient_demand_summary

```

```{r}
food_proj <- food_weight %>%
  dplyr::mutate(tonnes_yr = tonnes_day_food * 365) %>%
  dplyr::select(SCENARIO,
                iso_alpha3,
                subregionname,
                diet_plan,
                year,
                model_group,
                tonnes_yr) %>%
  dplyr::bind_rows(
    live_food_weight %>%
      dplyr::mutate(tonnes_yr = tonnes_day_food * 365) %>%
      dplyr::select(
        SCENARIO,
        iso_alpha3,
        subregionname,
        diet_plan,
        year,
        model_group,
        tonnes_yr
      )
  ) %>%
  dplyr::mutate(scenario = ifelse(
    SCENARIO == "SSP1_v9_130115",
    "SSP1",
    ifelse(
      SCENARIO == "SSP2_v9_130115",
      "SSP2",
      ifelse(
        SCENARIO == "SSP3_v9_130115",
        "SSP3",
        ifelse(SCENARIO == "SSP4d_v9_130115",
               "SSP4",
               "SSP5")
      )
    )
  )) %>% 
  dplyr::select(-SCENARIO) %>% 
  dplyr::filter(year > 2022)

feed_proj <- feed_ingredient_demand_summary %>% 
  dplyr::mutate(tonnes_yr = tonnes_day*365) %>% 
  dplyr::select(-tonnes_day) %>%
  dplyr::mutate(scenario = ifelse(
    SCENARIO == "SSP1_v9_130115",
    "SSP1",
    ifelse(
      SCENARIO == "SSP2_v9_130115",
      "SSP2",
      ifelse(
        SCENARIO == "SSP3_v9_130115",
        "SSP3",
        ifelse(SCENARIO == "SSP4d_v9_130115",
               "SSP4",
               "SSP5")
      )
    )
  )) %>% 
  dplyr::select(-SCENARIO) %>% 
  dplyr::filter(year > 2022)

# food_proj
# feed_proj
```

Set a target year

```{r}
netzero_target_year <- 2050
```

Confirm continuity between ISO codes so countries represented in 2022 are there in 2023, etc. Fill dummy values in for scenario and diet_plan for the FAO data. These are required for continuity in the spline fitter.

### For food pathways

```{r}
years_tmp <- food_2014_2022_est %>% distinct(year) %>% pull(year)
countries_tmp <- food_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- food_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")


empty_set <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp)
names(empty_set) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario")

```

```{r}
food_2014_2022_est_tmp <- food_2014_2022_est %>%
  full_join(empty_set, by = c("year", "model_group", "iso_alpha3")) %>%
  mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr))

```

Do the same for `pathways` data frame representing values between 2023 and the target year to be filled by the spline values.

```{r}
years_tmp <- seq(2023, netzero_target_year - 1, by = 1)
countries_tmp <- food_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- food_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
tonnes_yr_tmp <- NA

pathways_tmp <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
names(pathways_tmp) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario", "tonnes_yr")
```

Merge the FAO-derived data with the empty pathways data frame.

```{r}
food_data_pathways <- food_2014_2022_est_tmp %>% 
  full_join(pathways_tmp, by = c("year", "model_group", "tonnes_yr", "iso_alpha3", "diet_plan", "scenario"))

head(food_data_pathways)
```

And the same for `food_targets`, the data frame for values at and above the target year.

```{r}
years_tmp <- seq(netzero_target_year, 2080, by = 5)
countries_tmp <- food_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- food_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
tonnes_yr_tmp <- NA

targets_tmp <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
names(targets_tmp) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario", "tonnes_yr")
```

```{r}

food_targets <- food_proj %>%
  dplyr::filter(year >= netzero_target_year, year <= 2080) %>%
  dplyr::full_join(
    targets_tmp,
    by = c(
      "iso_alpha3",
      "diet_plan",
      "year",
      "model_group",
      "tonnes_yr",
      "scenario"
    )
  ) %>%
  dplyr::mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr)) %>%
  dplyr::filter(!is.na(subregionname)) %>%
  dplyr::select(-subregionname) %>%
  dplyr::mutate(model_group = ifelse(
    model_group == "cereal",
    "cereals",
    ifelse(
      model_group %in% c("bovine_meat", "sus_meat", "caprine_meat"),
      "beef_lamb_pork",
      ifelse(
        model_group == "cereal",
        "cereals",
        ifelse(
          model_group == "bovine_dairy",
          "dairy",
          ifelse(model_group == "fish",
                 "fish_seafood",
                 model_group)
        )
      )
    )
  )) %>%
  dplyr::filter(model_group != "meat_poultry")
  
head(food_targets)

```

Confirm that all countries represented in `data_pathways` are represented in `targets`. For the spline interpolation to work, there must be tie points for all countries, diet_plans, and scenarios at 2022 and the `netzero_target_year`.

```{r}
data_countries <- food_data_pathways %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)
targ_countries <- food_targets %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)

shared_countries <- intersect(data_countries, targ_countries)

food_2014_2022_est_clean <- food_data_pathways %>% 
  dplyr::filter(iso_alpha3 %in% shared_countries)
food_targets_clean <- food_targets %>% 
  dplyr::filter(iso_alpha3 %in% shared_countries)

```

Merge the time series together into a `harmonized_food_data_targets` data frame to run the interpolation on.

```{r}

harmonized_food_data_targets <- food_2014_2022_est_clean %>%
  dplyr::full_join(food_targets_clean, by = c("year", "model_group", "tonnes_yr", "iso_alpha3", "diet_plan", "scenario")) %>% 
  dplyr::arrange(year)

```

Interpolate shift pathways between the FAO food balance data (and linearly interpolated values to 2022 based on the FAO data) and target year values using a spline with all values as tie-points.

```{r}

food_pathways_tmp <- harmonized_food_data_targets %>% 
  # dplyr::filter(year >= 2018) %>% 
  dplyr::group_by(model_group, scenario, diet_plan, iso_alpha3) %>%
  dplyr::mutate(tonnes_yr_interp = stats::spline(
    x = year,
    y = tonnes_yr,
    xout = year,
    ties = "ordered"
  )$y) %>%
  ungroup()

food_pathways <- food_pathways_tmp %>%
  dplyr::select(-tonnes_yr) %>%
  dplyr::rename(tonnes_yr = tonnes_yr_interp)

```

In some cases, this method predicts negative demand values (e.g., Venezuela). In the VEN case, the initial decline in supply was so rapid, that the spline makes a practically unreasonable fit. The number of these unreasonable values amount to just 0.88% of the total number of values; but the number of their associated model_group, country, diet_plan and scenario combinations pathways amount to 8.5% of all possible combinations (hence pathways). In any case, their associated model_group, country, diet_plan and scenario combinations are thrown out of the data set.

```{r}

combos_to_drop <- food_pathways %>% 
  dplyr::filter(tonnes_yr < 0) %>% 
  dplyr::distinct(model_group, iso_alpha3, diet_plan, scenario) %>% 
  dplyr::mutate(keep = "nope")


food_pathways_clean <- food_pathways %>% 
  dplyr::left_join(combos_to_drop) %>%
  dplyr::filter(is.na(keep)) %>% 
  dplyr::select(-keep)

```

```{r}
ggplot(food_pathways %>% dplyr::filter(scenario == "SSP2", diet_plan == "ELA-PHD", model_group == "beef_lamb_pork"), aes(x = year, y = tonnes_yr)) + geom_point()
```

### For feed

```{r}
years_tmp <- feed_2014_2022_est %>% distinct(year) %>% pull(year)
countries_tmp <- feed_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- feed_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")


empty_set <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp)
names(empty_set) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario")

```

```{r}
feed_2014_2022_est_tmp <- feed_2014_2022_est %>%
  full_join(empty_set, by = c("year", "model_group", "iso_alpha3")) %>%
  mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr))

```

Do the same for `feed_pathways` data frame representing values between 2023 and the target year to be filled by the spline values.

```{r}
years_tmp <- seq(2023, netzero_target_year - 1, by = 1)
countries_tmp <- feed_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- feed_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
tonnes_yr_tmp <- NA

pathways_tmp <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
names(pathways_tmp) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario", "tonnes_yr")
```

Merge the FAO-derived data with the empty pathways data frame.

```{r}
feed_data_pathways <- feed_2014_2022_est_tmp %>% 
  full_join(pathways_tmp, by = c("year", "model_group", "tonnes_yr", "iso_alpha3", "diet_plan", "scenario"))

head(feed_data_pathways)
```

And the same for `feed_targets`, the data frame for values at and above the target year.

```{r}
years_tmp <- seq(netzero_target_year, 2080, by = 5)
countries_tmp <-
  feed_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <-
  feed_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
tonnes_yr_tmp <- NA

targets_tmp <-
  expand.grid(
    years_tmp,
    countries_tmp,
    model_groups_tmp,
    diet_plans_tmp,
    scenarios_tmp,
    tonnes_yr_tmp
  )
names(targets_tmp) <-
  c("year",
    "iso_alpha3",
    "model_group",
    "diet_plan",
    "scenario",
    "tonnes_yr")
```

```{r}
feed_targets <- feed_proj %>% 
  dplyr::filter(year >= netzero_target_year, year <= 2080) %>% 
  dplyr::full_join(targets_tmp) %>% 
    dplyr::filter(!is.na(subregionname)) %>% 
  dplyr::mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr)) %>% 
  dplyr::select(-subregionname) %>%
  dplyr::mutate(model_group = ifelse(
    model_group == "cereal",
    "cereals",
    ifelse(
      model_group %in% c("bovine_meat", "sus_meat", "caprine_meat"),
      "beef_lamb_pork",
      ifelse(
        model_group == "cereal",
        "cereals",
        ifelse(
          model_group == "bovine_dairy",
          "dairy",
          ifelse(model_group == "fish",
                 "fish_seafood",
                 model_group)
        )
      )
    )
  ))
  
head(feed_targets)
```

Confirm that all countries represented in `data_pathways` are represented in `targets`. For the spline interpolation to work, there must be tie points for all countries, diet_plans, and scenarios at 2022 and 2050.

```{r}
data_countries <- feed_data_pathways %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)
targ_countries <- feed_targets %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)

shared_countries <- intersect(data_countries, targ_countries)

feed_2014_2022_est_clean <- feed_data_pathways %>% 
  dplyr::filter(iso_alpha3 %in% shared_countries)
feed_targets_clean <- feed_targets %>% 
  dplyr::filter(iso_alpha3 %in% shared_countries)

```

Merge into harmonized data frame.

```{r}

harmonized_feed_data_targets <- feed_2014_2022_est_clean %>%
  dplyr::full_join(feed_targets_clean, by = c("year", "model_group", "tonnes_yr", "iso_alpha3", "diet_plan", "scenario")) %>% 
  dplyr::arrange(year)

```

Interpolate shift pathways between the FAO food balance data (and linearly interpolated values to 2022 based on the FAO data) and target year values using a spline with all values as tie-points.

```{r}

feed_pathways_tmp <- harmonized_feed_data_targets %>%
  group_by(model_group, scenario, diet_plan, iso_alpha3) %>%
  mutate(tonnes_yr_interp = stats::spline(
    x = year,
    y = tonnes_yr,
    xout = year,
    ties = "ordered"
  )$y) %>%
  ungroup()

feed_pathways <- feed_pathways_tmp %>%
  dplyr::select(-tonnes_yr) %>%
  dplyr::rename(tonnes_yr = tonnes_yr_interp)

```

In some cases, this method predicts negative demand values (e.g., Venezuela). In the VEN case, the initial decline in supply was so rapid, that the spline makes a practically unreasonable fit. The number of these unreasonable values amount to just 0.88% of the total number of values; but the number of their associated model_group, country, diet_plan and scenario combinations pathways amount to 8.5% of all possible combinations (hence pathways). In any case, their associated model_group, country, diet_plan and scenario combinations are thrown out of the data set.

```{r}

combos_to_drop <- feed_pathways %>% 
  dplyr::filter(tonnes_yr < 0) %>% 
  dplyr::distinct(model_group, iso_alpha3, diet_plan, scenario) %>% 
  dplyr::mutate(keep = "nope")


feed_pathways_clean <- feed_pathways %>% 
  dplyr::left_join(combos_to_drop) %>%
  dplyr::filter(is.na(keep)) %>% 
  dplyr::select(-keep)

```

## Visualization

Let's take a quick look at what cereals for food and feed will look like for all countries under SSP2.
```{r}
ggplot(food_pathways_clean %>% 
         dplyr::filter(scenario == "SSP2", model_group == "cereals"), 
       aes(x = year, 
           y = 1e-6*tonnes_yr)) + 
  geom_area(aes(fill = iso_alpha3)) + 
  theme_minimal() + 
  theme(
    legend.position = "none"
  ) + 
  labs(
    y = "Mt/yr"
  ) + 
  facet_wrap(~diet_plan) 

ggplot(feed_pathways_clean %>% 
         dplyr::filter(scenario == "SSP2", model_group == "cereals"), 
       aes(x = year, 
           y = 1e-6*tonnes_yr)) + 
  geom_area(aes(fill = iso_alpha3)) + 
  theme_minimal() + 
  theme(
    legend.position = "none"
  ) + 
  labs(
    y = "Mt/yr"
  ) + 
  facet_wrap(~diet_plan) 
```

This looks reasonable.

Combine food and feed pathways.

```{r}

food_tmp <- food_pathways_clean %>% 
  dplyr::mutate(kt_yr_food = ifelse(!is.nan(tonnes_yr), 
                                    tonnes_yr*1e-3, 
                                    0))
feed_tmp <- feed_pathways_clean %>% 
  dplyr::mutate(kt_yr_feed = ifelse(!is.nan(tonnes_yr), 
                                    tonnes_yr*1e-3, 
                                    0))

food_feed_pathways_clean <- food_tmp %>% 
  dplyr::full_join(feed_tmp) %>% 
  dplyr::mutate(kt_yr_food = ifelse(!is.na(kt_yr_food), 
                                    kt_yr_food, 
                                    0), 
                kt_yr_feed = ifelse(!is.na(kt_yr_feed), 
                                    kt_yr_feed, 
                                    0)) %>% 
  dplyr::mutate(kt_yr = kt_yr_food + kt_yr_feed) %>% 
  dplyr::group_by(year, model_group, iso_alpha3, diet_plan, scenario) %>% 
  dplyr::summarise(kt_yr = sum(kt_yr, na.rm = TRUE), 
                   .groups = "drop")
  # dplyr::mutate(kt_yr = rowSums(across(.cols = kt_yr_food:kt_yr_feed), na.rm = TRUE))

```

To visualise these data, I will aggregate food types into animal products, plant products and fish-seafood.

```{r}
food_feed_pathways_agg <- food_feed_pathways_clean %>% 
  dplyr::mutate(food_group = ifelse(model_group %in% c("beef_lamb_pork", "chicken_poultry", "dairy", "eggs"), 
                                    "animal products", 
                                    ifelse(model_group %in% c("fish_seafood"), 
                                           "fish & seafood", 
                                           "plant products"))) %>% 
  dplyr::group_by(year, iso_alpha3, diet_plan, scenario, food_group) %>% 
  dplyr::summarise(kt_yr = sum(kt_yr, na.rm = "TRUE"), 
                   .groups = "drop")

```

```{r}

food_feed_pathways_agg <- food_feed_pathways_agg %>% 
  dplyr::mutate(diet_plan_f = factor(diet_plan, levels = c("ELA-PHD", "CNS-CFP", "FDA-SDP")))

```

Plot the combined global food and feed pathways would look like, with products categorised as animal, plant and fish & seafood products.
```{r}

cols <-
  c(
    "animal products" = "#F17EB8",
    # "dairy" = "#DED560",
    "fish & seafood" = "#489ED3",
    "plant products" = "#EEAF35"
  )
xlabz <- c("CNS-CFP" = "CFP", "ELA-PHD" = "ELA", "FDA-SDP" = "USDA")
labz <-
  c("Animal Products", "Fish and Seafood", "Plant Products")

p3_ssp1 <- ggplot(food_feed_pathways_agg %>% 
               dplyr::group_by(year, diet_plan_f, scenario, food_group) %>% 
               dplyr::summarise(kt_yr = sum(kt_yr, na.rm = TRUE), 
                                .groups = "drop") %>% 
         filter(scenario == "SSP1"), aes(x = year)) +
                      # diet_plan == "ELA-PHD"), aes(x = year)) + 
  geom_hline(yintercept = 0, alpha = 0.8) + 
  geom_area(aes(y = 1e-6*kt_yr, 
                fill = food_group), 
            alpha = 0.8) + 
  geom_vline(xintercept = 2050, alpha = 0.5, linetype = 2, colour = "darkblue") + 
   scale_fill_manual(
    values = cols, 
    labels = labz
  ) +
  theme_minimal() + 
  theme(
    legend.position = "right", 
    legend.title = element_blank(), 
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.55, hjust = 0.9), 
    axis.text.y = element_text(size = 7), 
    axis.title.x = element_text(size = 8), 
    axis.title.y = element_text(size = 8), 
    strip.text = element_text(size = 8)
  ) + 
  labs(
    title = "SSP1", 
    x = "year", 
    y = "billion tonnes"
  ) +
  facet_grid(~diet_plan_f,
             labeller = as_labeller(xlabz)) + 
  coord_cartesian(ylim = c(0, 12.5))

p3_legend_only <- cowplot::get_legend(p3_ssp1)
 
p3_ssp1 <- p3_ssp1 +
  theme(legend.position = "none")

p3_ssp2 <- ggplot(food_feed_pathways_agg %>% 
               dplyr::group_by(year, diet_plan_f, scenario, food_group) %>% 
               dplyr::summarise(kt_yr = sum(kt_yr, na.rm = TRUE), 
                                .groups = "drop") %>% 
         filter(scenario == "SSP2"), aes(x = year)) +
  geom_hline(yintercept = 0, alpha = 0.8) + 
  geom_area(aes(y = 1e-6*kt_yr, 
                fill = food_group), 
            alpha = 0.8) + 
  geom_vline(xintercept = 2050, alpha = 0.5, linetype = 2, colour = "darkblue") + 
   scale_fill_manual(
    values = cols
  ) +
  theme_minimal() + 
  theme(
    legend.position = "none", 
    legend.title = element_blank(), 
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.55, hjust = 0.9), 
    axis.text.y = element_text(size = 7), 
    axis.title.x = element_blank(), 
    axis.title.y = element_blank(), 
    strip.text = element_text(size = 8)
  ) +
  labs(
    title = "SSP2"
  ) + 
  facet_grid(~diet_plan_f,
             labeller = as_labeller(xlabz)) + 
  coord_cartesian(ylim = c(0, 12.5))

p3_ssp3 <- ggplot(food_feed_pathways_agg %>% 
               dplyr::group_by(year, diet_plan_f, scenario, food_group) %>% 
               dplyr::summarise(kt_yr = sum(kt_yr, na.rm = TRUE), 
                                .groups = "drop") %>% 
         filter(scenario == "SSP3"), aes(x = year)) +
  geom_hline(yintercept = 0, alpha = 0.8) + 
  geom_area(aes(y = 1e-6*kt_yr, 
                fill = food_group), 
            alpha = 0.8) + 
  geom_vline(xintercept = 2050, alpha = 0.5, linetype = 2, colour = "darkblue") + 
   scale_fill_manual(
    values = cols
  ) +
  theme_minimal() + 
  theme(
    legend.position = "none", 
    legend.title = element_blank(), 
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.55, hjust = 0.9), 
    axis.text.y = element_text(size = 7), 
    axis.title.x = element_blank(), 
    axis.title.y = element_blank(), 
    strip.text = element_text(size = 8)
  ) + 
  labs(
    title = "SSP3"
  ) +
  facet_grid(~diet_plan_f,
             labeller = as_labeller(xlabz)) + 
  coord_cartesian(ylim = c(0, 12.5))

p3_ssp4 <- ggplot(food_feed_pathways_agg %>% 
               dplyr::group_by(year, diet_plan_f, scenario, food_group) %>% 
               dplyr::summarise(kt_yr = sum(kt_yr, na.rm = TRUE), 
                                .groups = "drop") %>% 
         filter(scenario == "SSP4"), aes(x = year)) +
  geom_hline(yintercept = 0, alpha = 0.8) + 
  geom_area(aes(y = 1e-6*kt_yr, 
                fill = food_group), 
            alpha = 0.8) + 
  geom_vline(xintercept = 2050, alpha = 0.5, linetype = 2, colour = "darkblue") + 
   scale_fill_manual(
    values = cols
    # ,
    # labels = labz
  ) +
  theme_minimal() + 
  theme(
    legend.position = "none", 
    legend.title = element_blank(), 
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.55, hjust = 0.9), 
    axis.text.y = element_text(size = 7), 
    axis.title.x = element_text(size = 8), 
    axis.title.y = element_blank(), 
    strip.text = element_text(size = 8)
  ) + 
  labs(
    title = "SSP4", 
    x = "year"
  ) +
  facet_grid(~diet_plan_f,
             labeller = as_labeller(xlabz)) + 
  coord_cartesian(ylim = c(0, 12.5))

p3_ssp5 <- ggplot(food_feed_pathways_agg %>% 
               dplyr::group_by(year, diet_plan_f, scenario, food_group) %>% 
               dplyr::summarise(kt_yr = sum(kt_yr, na.rm = TRUE), 
                                .groups = "drop") %>% 
         filter(scenario == "SSP5"), aes(x = year)) +
  geom_hline(yintercept = 0, alpha = 0.8) + 
  geom_area(aes(y = 1e-6*kt_yr, 
                fill = food_group), 
            alpha = 0.8) + 
  geom_vline(xintercept = 2050, alpha = 0.5, linetype = 2, colour = "darkblue") + 
   scale_fill_manual(
    values = cols
  ) +
  theme_minimal() + 
  theme(
    legend.position = "none", 
    legend.title = element_blank(), 
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.55, hjust = 0.9), 
    axis.text.y = element_text(size = 7), 
    axis.title.x = element_blank(), 
    axis.title.y = element_text(size = 8), 
    strip.text = element_text(size = 8)
  ) + 
  labs(
    title = "SSP5", 
    y = "billion tonnes"
  ) +
  facet_grid(~diet_plan_f,
             labeller = as_labeller(xlabz)) + 
  coord_cartesian(ylim = c(0, 12.5))

```


```{r}
pa <- plot_grid(p3_ssp5, p3_ssp1, ncol = 1)
pb <- plot_grid(p3_legend_only, p3_ssp2, NA, ncol = 1, rel_heights = c(0.5, 1, 0.5))
pc <- plot_grid(p3_ssp3, p3_ssp4, ncol = 1)

p3 <- cowplot::plot_grid(pa, pb, pc, ncol = 3)

cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_widths = c(0.1, 0.9), rel_heights = c(0.9, 0.1))

grDevices::jpeg(filename = "Plots/figure_5.jpg", 
               width = 750, 
               height = 500, 
               units = "px", 
               quality = 1)
cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_widths = c(0.1, 0.9), rel_heights = c(0.9, 0.1))
dev.off()

```

# For different target years

Set a target year

```{r}

# Food_feed_pathways <-
#   data.frame(
#     year = NA,
#     food_group = NA, 
#     iso_alpha3 = NA,
#     diet_plan = NA,
#     scenario = NA,
#     kt_yr = NA, 
#     kt_yr_fit = NA, 
#     kt_yr_se = NA, 
#     target_year = NA
#   )

for (year in seq(2045, 2065, by = 5)) {

  netzero_target_year <- year
  
  # For food pathways
  years_tmp <- food_feed_pathways_clean %>% filter(year <= 2022) %>% distinct(year) %>% pull(year)
  countries_tmp <-
    food_feed_pathways_clean %>% filter(year <= 2022) %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
  model_groups_tmp <-
    food_feed_pathways_clean %>% filter(year <= 2022) %>% distinct(model_group) %>% pull(model_group)
  diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
  scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
  
  empty_set <-
    expand.grid(years_tmp,
                countries_tmp,
                model_groups_tmp,
                diet_plans_tmp,
                scenarios_tmp)
  names(empty_set) <-
    c("year", "iso_alpha3", "model_group", "diet_plan", "scenario")
  rm(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp)
  
  food_feed_2014_2022_est <- food_2014_2022_est %>%
    dplyr::bind_rows(feed_2014_2022_est) %>%
    dplyr::group_by(year, model_group, iso_alpha3) %>%
    dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE),
                     .groups = "drop") %>%
    full_join(empty_set, by = c("year", "model_group", "iso_alpha3")) %>%
    mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr))
  
  # Do the same for `pathways` data frame representing values between 2023 and the target year to be filled by the spline values.
  years_tmp <- seq(2023, netzero_target_year - 1, by = 1)
  countries_tmp <-
    food_feed_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
  model_groups_tmp <-
    food_feed_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
  diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
  scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
  tonnes_yr_tmp <- NA
  
  pathways_tmp <-
    expand.grid(
      years_tmp,
      countries_tmp,
      model_groups_tmp,
      diet_plans_tmp,
      scenarios_tmp,
      tonnes_yr_tmp
    )
  names(pathways_tmp) <-
    c("year",
      "iso_alpha3",
      "model_group",
      "diet_plan",
      "scenario",
      "tonnes_yr")
  rm(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
  
  # Merge the FAO-derived data with the empty pathways data frame.
  food_feed_data_pathways <- food_feed_2014_2022_est %>%
    full_join(
      pathways_tmp
    )
  
  # And the same for `food_targets`, the data frame for values at and above the target year.
  years_tmp <- seq(netzero_target_year, 2080, by = 5)
  countries_tmp <-
    food_feed_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
  model_groups_tmp <-
    food_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
  diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
  scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
  tonnes_yr_tmp <- NA
  
  targets_tmp <-
    expand.grid(
      years_tmp,
      countries_tmp,
      model_groups_tmp,
      diet_plans_tmp,
      scenarios_tmp,
      tonnes_yr_tmp
    )
  names(targets_tmp) <-
    c("year",
      "iso_alpha3",
      "model_group",
      "diet_plan",
      "scenario",
      "tonnes_yr")
    rm(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
  
  #food and feed projections to establish targets
  food_feed_proj <- food_proj %>% 
    dplyr::bind_rows(feed_proj) %>% 
    dplyr::group_by(iso_alpha3, subregionname, diet_plan, year, model_group, scenario) %>% 
    dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                     .groups = "drop")
  
  food_feed_targets <- food_feed_proj %>%
    dplyr::filter(year >= netzero_target_year, year <= 2080) %>%
    dplyr::full_join(targets_tmp) %>%
    # dplyr::mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr)) %>%
    dplyr::filter(!is.na(subregionname)) %>%
    dplyr::select(-subregionname)
  
  data_countries <-
    food_feed_data_pathways %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)
  targ_countries <-
    food_feed_targets %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)
  
  shared_countries <- intersect(data_countries, targ_countries)
  
  food_feed_2014_2022_est_clean <- food_feed_data_pathways %>%
    dplyr::filter(iso_alpha3 %in% shared_countries)
  food_feed_targets_clean <- food_feed_targets %>%
    dplyr::filter(iso_alpha3 %in% shared_countries)
  
  rm(data_countries, targ_countries, shared_countries)
  
  # Merge the time series together into a `harmonized_food_data_targets` data frame to run the interpolation on.
  harmonized_food_feed_data_targets <- food_feed_2014_2022_est_clean %>%
    dplyr::full_join(food_targets_clean) %>%
    dplyr::arrange(year)
  
  harmonized_food_feed_data_targets_agg <- harmonized_food_feed_data_targets %>% 
  dplyr::mutate(food_group = ifelse(model_group %in% c("beef_lamb_pork", "chicken_poultry", "dairy", "eggs"), 
                                    "animal products", 
                                    ifelse(model_group %in% c("fish_seafood"), 
                                           "fish & seafood", 
                                           "plant products"))) %>% 
  dplyr::group_by(year, iso_alpha3, diet_plan, scenario, food_group) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = FALSE), 
                   .groups = "drop")
  
  # Interpolate shift pathways between the FAO food balance data (and linearly interpolated values to 2022 based on the FAO data) and target year values using a spline with all values as tie-points.
  # fn <- function(x, y) {
  #   spline(x, y)
  # }
  # 
  # yrs <- data.frame(year = seq(2019, 2022, by = 1))

  # dplyr::mutate(models = lapply(data, function(df)
  #   lm(tonnes_yr ~ year, data = df))) %>%
  # dplyr::mutate(lm_pred = map(models, ~ predict(., yrs))) %>%
  # dplyr::ungroup() %>%
  # tidyr::unnest(cols = c(lm_pred)) %>%
 
    
    
  food_feed_pathways_tmp <-
    harmonized_food_feed_data_targets_agg %>%
    dplyr::mutate(kt_yr = 1e-3 * tonnes_yr) %>%
    dplyr::select(-tonnes_yr) %>%
    dplyr::group_by(food_group, scenario, diet_plan, iso_alpha3) %>% 
    # filter(iso_alpha3 == "USA") %>% 
    tidyr::nest() %>%
    dplyr::mutate(splined = map(data, ~ mgcv::gam(kt_yr ~ s(
      year, k = 5, bs = "tp"
    ), data = .x))) %>%
    dplyr::mutate(augment_spline = map2(splined, data, ~ broom::augment(.x, newdata = .y))) %>%
    tidyr::unnest(augment_spline) %>%
    dplyr::ungroup()
  
    print(paste(netzero_target_year, timestamp(prefix = "--", suffix = "--"), sep = " | "))
  
    # dplyr::mutate(kt_yr_interp = spline(
    #   x = year,
    #   y = kt_yr,
    #   xout = year,
    #   ties = "ordered"
    # )$y) %>%
    # ungroup()
  
  food_feed_pathways <- food_feed_pathways_tmp %>% 
    dplyr::select(-data, -splined) %>% 
    dplyr::rename(
         kt_yr_fit = `.fitted`, 
      kt_yr_se = `.se.fit`, 
    ) %>% 
    dplyr::mutate(
      target_year = netzero_target_year
    )
  
  rm(food_feed_pathways_tmp, netzero_target_year)
  
  if(year == 2045) {
     Food_feed_pathways <- food_feed_pathways
  } else {
    Food_feed_pathways <- Food_feed_pathways %>% 
      dplyr::bind_rows(food_feed_pathways)
  }
  
}

```

Can investigate whether this is working with a quick test.
```{r}
ggplot(
  Food_feed_pathways %>% filter(
    iso_alpha3 == "USA",
    food_group == "animal products",
    scenario == "SSP3",
    diet_plan == "CNS-CFP", 
    target_year == 2065
  ),
  aes(x = year)
) +
  geom_line(aes(y = kt_yr)) +
  geom_line(aes(y = kt_yr_fit), colour = "blue") 
```

# Pathway Rates of Change

Now take first and second differences from pathways.
```{r}

Food_feed_pathways_curves <- Food_feed_pathways %>% 
  dplyr::filter(year >= 2023) %>% 
  dplyr::mutate(allowed = ifelse(year < target_year, 
                                 TRUE, 
                                 FALSE)) %>% 
  dplyr::filter(allowed != FALSE) %>% 
  dplyr::select(-allowed) %>% 
  dplyr::group_by(food_group, iso_alpha3, diet_plan, scenario, target_year) %>% 
  dplyr::mutate(
    diff1 = kt_yr_fit - lag(kt_yr_fit, n = 1L), 
    diff2 = diff1 - lag(diff1, n = 1L)
  ) %>% 
  dplyr::ungroup()

```

The `Food_feed_pathways_curves` df contains pathway ROCs, diff1, and dROCs, diff2 (pathway curvature).
```{r}
# Food_feed_pathways_curves %>% filter(!year %in% c(2023, 2024))
```

# Historical food balances

From FAO Food Balance data sheets.
```{r}
fb_hist_df <-
  readr::read_csv(
    file = paste0(
      data_path,
      "/FoodBalanceSheetsHistoric_E_All_Data_(Normalized).csv"
    ),
    col_types = cols(
      `Area Code` = col_double(),
      Area = col_character(),
      `Item Code` = col_double(),
      Item = col_character(),
      `Element Code` = col_double(),
      Element = col_character(),
      `Year Code` = col_double(),
      Year = col_double(),
      Unit = col_character(),
      Value = col_double(),
      Flag = col_character()
    )
  )
```

Standardize the header names.
```{r}
Fb_hist_df <- fb_hist_df %>% 
  dplyr::rename(area_code = `Area Code`, 
                area = Area, 
                item_code = `Item Code`, 
                element_code = `Element Code`, 
                value = Value, 
                unit = Unit,
                element = Element, 
                item = Item, 
                year = Year) %>% 
  dplyr::select(area_code, area, item_code, item, element_code, element, year, unit, value)
```

Map food model groups to the historical data.
```{r}
food_hist_df <- Fb_hist_df %>%
  dplyr::filter(element_code %in% c(5142)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na()

feed_hist_df <- Fb_hist_df %>%
  dplyr::filter(element_code %in% c(5521)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na()

```

Aggregate tonnes of food/feed by model_group.
```{r}

food_hist_countries <- food_hist_df %>% 
  dplyr::group_by(area_code, area, year, model_group) %>% 
  dplyr::summarise(kt_yr = sum(value, na.rm = TRUE), 
                   .groups = "drop")

feed_hist_countries <- feed_hist_df %>% 
  dplyr::group_by(area_code, area, year, model_group) %>% 
  dplyr::summarise(kt_yr = sum(value, na.rm = TRUE), 
                   .groups = "drop")

food_feed_hist_countries <- food_hist_countries %>% 
  dplyr::bind_rows(feed_hist_countries) %>% 
  dplyr::group_by(area_code, area, year, model_group) %>% 
  dplyr::summarise(kt_yr = sum(kt_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(food_group = ifelse(model_group %in% c("beef_lamb_pork", "chicken_poultry", "dairy", "eggs"), 
                                    "animal products", 
                                    ifelse(model_group %in% c("fish_seafood"), 
                                           "fish & seafood", 
                                           "plant products"))) %>% 
  dplyr::group_by(year, area_code, area, food_group) %>% 
  dplyr::summarise(kt_yr = sum(kt_yr, na.rm = "TRUE"), 
                   .groups = "drop")

```

Take first and second differences of the (smoothed) historical data. (I am smoothing the data by taking 3 year rolling means.)
```{r}

food_feed_curv <- food_feed_hist_countries %>%
  dplyr::group_by(area_code, area, food_group) %>%
  dplyr::arrange(year) %>%
  dplyr::mutate(kt_yr_smoothed = zoo::rollapply(kt_yr, 3, mean, fill = NA)) %>%
  dplyr::mutate(diff1 = kt_yr_smoothed - lag(kt_yr_smoothed, 1L),
                diff2 = diff1 - lag(diff1, 1L)) %>%
  dplyr::ungroup() %>%
  tidyr::drop_na() 

```

Map these to geographic subregions (groupings of countries that follow FAO pattern, sometimes continental-scale, sometimes sub-continental, sometimes super-continental).
```{r}

food_feed_curv_regions <- food_feed_curv %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::select(-area) %>% 
  dplyr::left_join(loc_map_reduced) %>% 
  tidyr::drop_na()

```

```{r}
p1 <- ggplot(food_feed_curv_regions,
             aes(x = year,
                 y = abs(diff2))) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_point(aes(colour = subregionname), alpha = 0.5) +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  labs(
    title = "Historical crop production absolute acceleration (pathway curvature)",
    subtitle = "Source: FAOSTAT (2022)",
    x = "year",
    y = "absolute curvature (kt/yr/yr)"
  )

p1
```
## Distributions

Find out how ROC distributions change globally, for all food types, scenarios, target years, and countries, as a function of diet plan.

```{r}
hist_density_averages <- Food_feed_curv_regions %>% 
  dplyr::select(-kt_yr, -diff2) %>% 
  dplyr::mutate(roc_sign = ifelse(diff1 > 0, 
                                  "pos", 
                                  ifelse(diff1 < 0, 
                                         "neg", 
                                         NA))) %>% 
  tidyr::drop_na() %>% 
  dplyr::group_by(food_group, roc_sign) %>% 
  dplyr::summarise(diff1_ave = mean(diff1, na.rm = TRUE), 
                   .groups = "drop")

pathway_density_averages <- Food_feed_pathways_curves %>% 
  dplyr::select(-kt_yr, -diff2) %>% 
  dplyr::mutate(roc_sign = ifelse(diff1 > 0, 
                                  "pos", 
                                  ifelse(diff1 < 0, 
                                         "neg", 
                                         NA))) %>% 
  tidyr::drop_na() %>% 
  dplyr::group_by(diet_plan, food_group, scenario, target_year, roc_sign) %>% 
  dplyr::summarise(diff1_ave = mean(diff1, na.rm = TRUE), 
                   .groups = "drop") 

pathway_density_ensemble_means <- pathway_density_averages %>% 
  dplyr::group_by(food_group, roc_sign) %>% 
  dplyr::summarise(diff1_em = mean(diff1_ave, na.rm = TRUE, 
                                   .groups = "drop"))

```


```{r}
cols <-
  c(
    "animal products" = "#F17EB8",
    "fish & seafood" = "#489ED3",
    "plant products" = "#EEAF35"
  )

p2_pos <- ggplot(Food_feed_pathways_curves %>% 
         dplyr::filter(diff1 > 0), 
       mapping = aes(x = diff1)) + 
  geom_density(mapping = aes(fill = food_group), 
               alpha = 0.4, 
               colour = NA) + 
  geom_density(data = Food_feed_curv_regions %>% 
         dplyr::filter(diff1 > 0), 
               mapping = aes(x = diff1), 
               fill = NA, 
         inherit.aes = FALSE) + 
  geom_vline(data = pathway_density_averages %>% 
               dplyr::filter(roc_sign == "pos"), 
             mapping = aes(xintercept = diff1_ave, 
                 colour = food_group), 
             linetype = 1, 
             alpha = 0.1) + 
  geom_vline(data = hist_density_averages %>% 
               dplyr::filter(roc_sign == "pos"), 
             mapping = aes(xintercept = diff1_ave), 
             linetype = 2) + 
   geom_vline(data = pathway_density_ensemble_means %>% 
               dplyr::filter(roc_sign == "pos"), 
             mapping = aes(xintercept = diff1_em), 
                 colour = "blue", 
             linetype = 4) + 
  scale_fill_manual(
    values = cols
  ) +
  scale_colour_manual(
    values = cols
  ) +
  theme_bw() + 
  theme(
    legend.position = "top", 
    legend.title = element_blank()
  ) +
  scale_x_log10(
    breaks = scales::trans_breaks("log10", function(x)
      10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(10 ^
                                                                 .x))
  ) + 
  labs(
    title = "Positive ROC values", 
    x = "ROC (kt/yr)", 
    tag = "A"
  ) + 
  coord_cartesian(xlim = c(1e-2, 1e4)) + 
  facet_wrap(~food_group)

p2_leg <- cowplot::get_legend(p2_pos) 

p2_pos <- p2_pos + 
  theme(
    legend.position = "none"
  )

p2_neg <- ggplot(Food_feed_pathways_curves %>% 
         dplyr::filter(diff1 < 0), 
       aes(x = abs(diff1))) + 
  geom_density(aes(fill = food_group), 
               alpha = 0.4, 
               colour = NA) + 
  geom_density(data = Food_feed_curv_regions %>% 
         dplyr::filter(diff1 < 0), 
               aes(x = abs(diff1)), 
               fill = NA) + 
  geom_vline(data = pathway_density_averages %>% 
               dplyr::filter(roc_sign == "neg"), 
             aes(xintercept = abs(diff1_ave), 
                 colour = food_group), 
             linetype = 1, 
             alpha = 0.1) + 
  geom_vline(data = hist_density_averages %>% 
               dplyr::filter(roc_sign == "neg"), 
             aes(xintercept = abs(diff1_ave)), 
             linetype = 2) + 
   geom_vline(data = pathway_density_ensemble_means %>% 
               dplyr::filter(roc_sign == "neg"), 
             aes(xintercept = abs(diff1_em)), 
                 colour = "blue", 
             linetype = 4) + 
  scale_fill_manual(
    values = cols
  ) +
  scale_colour_manual(
    values = cols
  ) +
  theme_bw() + 
  theme(
    legend.position = "none"
  ) + 
  scale_x_log10(
    breaks = scales::trans_breaks("log10", function(x)
      10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(-10 ^
                                                                 .x))
  ) + 
  coord_cartesian(xlim = c(1e-2, 1e4)) + 
  labs(
    title = "Negative ROC values", 
    x = "ROC (kt/yr)", 
    tag = "B"
  ) + 
  facet_wrap(~food_group)


cowplot::plot_grid(p2_pos, p2_neg, p2_leg, ncol = 1, rel_heights = c(0.45, 0.45, 0.1)) 
grDevices::jpeg(filename = "Plots/figure_6_SI.jpg", 
               width = 800, 
               height = 500, 
               units = "px", 
               quality = 1)
cowplot::plot_grid(p2_pos, p2_neg, p2_leg, ncol = 1, rel_heights = c(0.45, 0.45, 0.1)) 
dev.off()

```



Pathways and FAO historical data.

```{r}
Food_feed_pathways_curves_regions <- Food_feed_pathways_curves %>% 
  dplyr::full_join(loc_map_reduced, by = "iso_alpha3") %>% 
  dplyr::filter(!is.na(target_year))
Food_feed_curv_regions <- food_feed_curv_regions %>% 
  dplyr::mutate(diet_plan = "FAO data", 
                scenario = "FAO data")
```


```{r}

scenar = "SSP3"

rate_palette <- RColorBrewer::brewer.pal(name="Blues", n=9)[5:9]

p_rate_pos <- ggplot(
  data = Food_feed_pathways_curves %>%
    dplyr::filter(diff1 >= 0) %>%
    dplyr::filter(abs(diff1) > threshold_rate, 
                  scenario == scenar),
  mapping = aes(x = diff1)
) +
  geom_density(aes(fill = as.factor(target_year), 
                   colour = as.factor(target_year)), 
               alpha = 0.8, 
               size = 1) + 
  geom_line(
    data = rate_pos_fao_data,
    mapping = aes(x = diff1, y = density), 
    size = 1.1, 
    alpha = 0.8, 
    colour = "red", 
    inherit.aes = FALSE
  ) +
  scale_fill_manual(values = rate_palette) +
  scale_color_manual(values = rate_palette) + 
  geom_vline(xintercept = threshold_rate, 
             linetype = 2, 
             colour = "firebrick", 
             alpha = 0.5) + 
  theme_minimal() + 
  theme(
    legend.title = element_blank(), 
    legend.position = "top", 
    axis.text.x = element_text(angle = 90, 
                               size = 7)
  ) + 
  labs(
    subtitle = paste0(scenar, ", year-to-year positive rate of change"), 
    x = "ROC (kt/yr)", 
    y = "density"
  ) + 
  coord_cartesian(xlim = c(0, 5e4)) +
  facet_wrap(~ diet_plan)

p_rate_legend <- cowplot::get_legend(p_rate_pos)

p_rate_pos <- p_rate_pos + 
  theme(
    legend.position = "none"
  )

p_rate_neg <- ggplot(
  data = Food_feed_pathways_curves %>%
    dplyr::filter(diff1 < 0) %>%
    dplyr::filter(abs(diff1) > threshold_rate, 
                  scenario == scenar),
  mapping = aes(x = diff1)
) +
  geom_density(aes(fill = as.factor(target_year), 
                   colour = as.factor(target_year)), 
               alpha = 0.8, 
               size = 1) + 
  geom_line(
    data = rate_neg_fao_data,
    mapping = aes(x = -diff1, y = density), 
    size = 1.1, 
    alpha = 0.8, 
    colour = "red", 
    inherit.aes = FALSE
  ) +
  scale_fill_manual(values = rate_palette) +
  scale_color_manual(values = rate_palette) + 
  geom_vline(xintercept = -threshold_rate, 
             linetype = 2, 
             colour = "firebrick", 
             alpha = 0.5) + 
  scale_x_reverse() + 
  theme_minimal() + 
  theme(
    legend.position = "none",
    legend.title = element_blank(), 
    axis.text.x = element_text(angle = 90, 
                               size = 7)
  ) + 
  labs(
    subtitle = paste0(scenar, ", year-to-year negative rate of change"), 
    x = "ROC (kt/yr)", 
    y = "density"
  ) + 
  coord_cartesian(xlim = c(0, -5e4)) +
  facet_wrap(~ diet_plan)


p_rate_pos_pathways <- ggplot_build(p_rate_pos)
p_rate_neg_pathways <- ggplot_build(p_rate_neg)

rate_pos_pathways <- p_rate_pos_pathways$data[[1]] %>%
  dplyr::mutate(diet_plan = ifelse(PANEL == 1,
                                   "CNS-CFP",
                                   ifelse(PANEL == 2,
                                          "ELA-PHD",
                                          "FDA-SDP")), 
                target_year = ifelse(fill == "#6BAED6", 
                                     2045, 
                                     ifelse(fill == "#4292C6", 
                                            2050, 
                                            ifelse(fill == "#2171B5", 
                                                   2055, 
                                                   ifelse(fill == "#08519C", 
                                                          2060, 
                                                                 2065)))), 
                diff1 = x, 
                scenario = scenar, 
                type = "pathway") %>% 
  dplyr::select(type, scenario, diet_plan, target_year, diff1, density) %>% 
  dplyr::mutate(density_rescaled = 1e4*density)

rate_neg_pathways <- p_rate_neg_pathways$data[[1]] %>%
  dplyr::mutate(diet_plan = ifelse(PANEL == 1,
                                   "CNS-CFP",
                                   ifelse(PANEL == 2,
                                          "ELA-PHD",
                                          "FDA-SDP")), 
                target_year = ifelse(fill == "#6BAED6", 
                                     2045, 
                                     ifelse(fill == "#4292C6", 
                                            2050, 
                                            ifelse(fill == "#2171B5", 
                                                   2055, 
                                                   ifelse(fill == "#08519C", 
                                                          2060, 
                                                                 2065)))), 
                diff1 = x, 
                scenario = scenar, 
                type = "pathway") %>% 
  dplyr::select(type, scenario, diet_plan, target_year, diff1, density)

```

```{r}
ggplot(
  data = rate_pos_pathways,
  mapping = aes(x = diff1, 
                y = density)) +
  geom_area(aes(fill = as.factor(target_year), 
                   colour = as.factor(target_year)), 
               alpha = 0.8, 
               size = 1) + 
  geom_line(
    data = rate_pos_fao_data,
    mapping = aes(x = diff1, y = density), 
    size = 1.1, 
    alpha = 0.8, 
    colour = "red", 
    inherit.aes = FALSE
  ) +
  scale_fill_manual(values = rate_palette) +
  scale_color_manual(values = rate_palette) + 
  geom_vline(xintercept = threshold_rate, 
             linetype = 2, 
             colour = "firebrick", 
             alpha = 0.5) + 
  # scale_y_log10() + 
  theme_minimal() + 
  theme(
    legend.position = "none",
    legend.title = element_blank(), 
    axis.text.x = element_text(angle = 90, 
                               size = 7)
  ) + 
  labs(
    subtitle = paste0(scenar, ", year-to-year positive rate of change"), 
    x = "ROC (kt/yr)", 
    y = "density"
  ) + 
  # coord_cartesian(xlim = c(0, 3.5e4)) +
  scale_x_log10(
    breaks = scales::trans_breaks("log10", function(x)
      10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(10 ^
                                                                 .x))
  ) +
  facet_wrap(~ diet_plan)
```


Use normalized histograms to do this test.

```{r}
diff1_hist <- Food_feed_curv_regions %>% 
  dplyr::arrange(diff1) %>% 
  dplyr::pull(diff1) %>% 
  na.omit()

diff2_hist <- Food_feed_curv_regions %>% 
  dplyr::arrange(diff2) %>% 
  dplyr::pull(diff2) %>% 
  na.omit()

```

Histogram these.

```{r}

p_fao_hist_diff1 <- ggplot(data.frame(values = diff1_hist), 
              aes(x = values)) + 
  geom_histogram(binwidth = 500)

fao_hist_data_diff1 <- ggplot_build(p_fao_hist_diff1)$data[[1]]

fao_hist_diff1_df <- fao_hist_data_diff1 %>% 
  dplyr::select(
    x, 
    count
  )


p_fao_hist_diff2 <- ggplot(data.frame(values = diff2_hist), 
              aes(x = values)) + 
  geom_histogram(binwidth = 100)

fao_hist_data_diff2 <- ggplot_build(p_fao_hist_diff2)$data[[1]]

fao_hist_diff2_df <- fao_hist_data_diff2 %>% 
  dplyr::select(
    x, 
    count
  )


```

```{r}

test <- expand.grid(
  scenario = c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5"),
  target_year = seq(2045, 2065, by = 5),
  diet_plan = c("ELA-PHD", "CNS-CFP", "FDA-SDP")
)

test <- data.frame(
  test, 
  index = seq(1, dim(test)[1], by = 1)
)

```

First differences. (This will throw some warnings about removing rows containing non-finite values.)

```{r, warning=FALSE}
# p_path_ls <- list()
Path_diff1_df <- data.frame()
for(scen in c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")) {
  for (yr in seq(2045, 2065, by = 5)) {
    for (diet in c("ELA-PHD", "CNS-CFP", "FDA-SDP")) {
      p_path <- ggplot(
        data = Food_feed_pathways_curves %>%
          dplyr::filter(diet_plan == diet,
                        scenario == scen,
                        target_year == yr),
        aes(x = diff1)
      ) +
        geom_histogram(binwidth = 500)
      
      path_data <- ggplot_build(p_path)$data[[1]]
      path_df <- path_data %>%
        dplyr::select(x,
                      count) %>% 
        dplyr::mutate(
          scenario = scen, 
          diet_plan = diet, 
          target_year = yr
        )
      
      # j <- test %>% 
      #   dplyr::filter(diet_plan == diet,
      #                   scenario == scen,
      #                   target_year == yr) %>% 
      #   dplyr::pull(index)
      # 
      # p_path_ls[[j]] <- p_path
      
      Path_diff1_df <- Path_diff1_df %>% 
        dplyr::bind_rows(path_df)
      
      rm(path_df, path_data)
    }
  }
}


```

Second differences.

```{r, warning=FALSE}
# p_path_ls <- list()
Path_diff2_df <- data.frame()
for(scen in c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")) {
  for (yr in seq(2045, 2065, by = 5)) {
    for (diet in c("ELA-PHD", "CNS-CFP", "FDA-SDP")) {
      p_path <- ggplot(
        data = Food_feed_pathways_curves %>%
          dplyr::filter(diet_plan == diet,
                        scenario == scen,
                        target_year == yr),
        aes(x = diff2)
      ) +
        geom_histogram(binwidth = 100)
      
      path_data <- ggplot_build(p_path)$data[[1]]
      path_df <- path_data %>%
        dplyr::select(x,
                      count) %>% 
        dplyr::mutate(
          scenario = scen, 
          diet_plan = diet, 
          target_year = yr
        )
      
      # j <- test %>% 
      #   dplyr::filter(diet_plan == diet,
      #                   scenario == scen,
      #                   target_year == yr) %>% 
      #   dplyr::pull(index)
      # 
      # p_path_ls[[j]] <- p_path
      
      Path_diff2_df <- Path_diff2_df %>% 
        dplyr::bind_rows(path_df)
      
      rm(path_df, path_data)
    }
  }
}


```

Normalise for area under histograms. I.e., find densities for discrete x-values.

All values

```{r}
# first differences
fao_hist_diff1_norm_df <- fao_hist_diff1_df %>% 
  # filter(x != 0) %>%
  mutate(counts_norm = count/sum(count), 
         cdf = cumsum(counts_norm))

Path_diff1_norm_df <- Path_diff1_df %>% 
  # filter(x != 0) %>%
  group_by(scenario, diet_plan, target_year) %>% 
  dplyr::mutate(counts_norm = count/sum(count), 
         cdf = cumsum(counts_norm)) %>% 
  dplyr::ungroup()

# second differences
fao_hist_diff2_norm_df <- fao_hist_diff2_df %>% 
  # filter(x != 0) %>%
  mutate(counts_norm = count/sum(count), 
         cdf = cumsum(counts_norm))

Path_diff2_norm_df <- Path_diff2_df %>% 
  # filter(x != 0) %>%
  group_by(scenario, diet_plan, target_year) %>% 
  dplyr::mutate(counts_norm = count/sum(count), 
         cdf = cumsum(counts_norm)) %>% 
  dplyr::ungroup()
```

```{r}
Path_diff1_norm_df <- Path_diff1_norm_df %>% 
  dplyr::mutate(diet_plan_f = ifelse(diet_plan == "ELA-PHD", 
                                     "ELA", 
                                     ifelse(diet_plan == "CNS-CFP", 
                                            "CNS", 
                                            "USDA")))
Path_diff1_norm_df$diet_plan_f <- factor(Path_diff1_norm_df$diet_plan_f, levels = c("ELA", "CNS", "USDA"))
```



```{r}

Path_diff1_norm_df <- Path_diff1_norm_df %>% 
  dplyr::mutate(
    diet_plan = if_else(diet_plan == "ELA-PHD", 
                          "ELA", 
                          if_else(diet_plan == "CNS-CFP", 
                                  "CNS", 
                                  "USDA"))
  )

Path_diff1_norm_df$diet_plan_f <- factor(Path_diff1_norm_df$diet_plan, levels = c("ELA", "CNS", "USDA"))

```


```{r}
fao_hist_diff1_pos <- fao_hist_diff1_norm_df %>% 
  filter(x >= 0) %>% 
  summarise(test = mean(counts_norm*x, 
                     na.rm = TRUE))

fao_hist_diff1_neg <- fao_hist_diff1_norm_df %>% 
  filter(x < 0) %>% 
  summarise(test = mean(counts_norm*x, 
                     na.rm = TRUE))

path_diff1_pos <- Path_diff1_norm_df %>% 
  filter(x >= 0) %>% 
  group_by(scenario, diet_plan_f, target_year) %>% 
  summarise(test = mean(counts_norm*x, 
                     na.rm = TRUE), 
            .groups = "drop")

path_diff1_neg <- Path_diff1_norm_df %>% 
  filter(x < 0) %>% 
  group_by(scenario, diet_plan_f, target_year) %>% 
  summarise(test = mean(counts_norm*x, 
                     na.rm = TRUE), 
            .groups = "drop")
```

```{r}

rate_palette <- brewer.pal(name="Blues", n=9)[5:9]

p_diff1_pos <- ggplot(path_diff1_pos, 
       aes(x = target_year, 
           y = test)) + 
  geom_line(aes(colour = scenario), 
            size = 1.2, 
            alpha = 0.7) + 
  geom_hline(yintercept = fao_hist_diff1_pos$test, 
             colour = "firebrick", 
             size = 1.1, 
             alpha = 0.8) + 
  theme_minimal() + 
  theme(
    legend.title = element_blank(), 
    legend.position = "top", 
    axis.text.x = element_text(angle = 0, 
                               vjust = 0.5), 
    axis.title.x = element_blank(), 
    axis.title.y = element_text(size = 8), 
    panel.spacing = unit(2, "lines")
  ) + 
  annotate("text", 
           label = "historical", 
           x = 2063, 
           y = 2, 
           size = 3, 
           colour = "#322F2E") + 
  labs(
    tag = "A", 
    subtitle = "Positive ROC values", 
    y = "mean ROC (kt/yr)"
  ) + 
  scale_colour_manual(values = rate_palette) + 
  scale_y_continuous(labels = scales::label_number(accuracy = 0.01)) + 
  facet_wrap(~ diet_plan_f)

p_legend <- cowplot::get_legend(p_diff1_pos)
 
p_diff1_pos <- p_diff1_pos +
  theme(legend.position = "none")

p_diff1_neg <- ggplot(path_diff1_neg, 
       aes(x = target_year, 
           y = test)) + 
  geom_line(aes(colour = scenario), 
            size = 1.2, 
            alpha = 0.7) + 
  geom_hline(yintercept = fao_hist_diff1_neg$test, 
             colour = "firebrick", 
             size = 1.1, 
             alpha = 0.8) + 
  theme_minimal() + 
  theme(
    legend.position = "none", 
    axis.text.x = element_text(angle = 0, 
                               vjust = 0.5), 
    axis.title.x = element_text(margin = margin(t = 10), 
                                size = 9), 
    axis.title.y = element_text(size = 8), 
    panel.spacing = unit(2, "lines")
  ) + 
  annotate("text", 
           label = "historical", 
           x = 2063, 
           y = -0.8, 
           size = 3, 
           colour = "#322F2E") + 
  labs(
    tag = "B", 
    subtitle = "Negative ROC values", 
    x = "target year to reach the dietary goal", 
    y = "mean ROC (kt/yr)"
  ) + 
  scale_colour_manual(values = rate_palette) + 
  scale_y_continuous(labels = scales::label_number(accuracy = 0.01))  + 
  facet_wrap(~ diet_plan_f)
```


```{r}
grDevices::jpeg(filename = "Plots/figure_6.jpg", 
               width = 500, 
               height = 300, 
               units = "px", 
               quality = 1)
cowplot::plot_grid(p_legend, p_diff1_pos,p_diff1_neg, ncol = 1, rel_heights = c(0.1, 0.8, 0.85))

dev.off()
```


```{r}
# readr::write_csv(Food_feed_pathways_curves, file = "~/Data/food_feed_pathways.csv")
# readr::write_csv(Food_feed_curv_regions, file = "~/Data/food_feed_fao_historical.csv")

```

