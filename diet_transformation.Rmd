---
title: "Diet Shifts"
author: "Marcus J Thomson"
date: "10/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyr)
library(dplyr)
library(purrr)
library(ggplot2)
library(cowplot)
library(zoo)
library(scales)
library(readr)
library(RColorBrewer)
```

# Dietary Shift Pathways

Here I calculate pathway trajectories from the present food/feed supply patterns to hypothetical future patterns based on demands from the projections calculated in `iep_healthy_food.Rmd`.

```{r}
wd_path <- getwd()
data_path <- paste0(wd_path, "/Data")
```

## FAO Food Balance Data

Read in Food Balance data from FAOSTAT. Source: [FAOSTAT.](http://www.fao.org/faostat/en/#data/FBS)

```{r}
foodbalance_df <- readr::read_csv(
  file = paste0(data_path, "/FoodBalanceSheets_E_All_Data_(Normalized).csv"),
  col_types = cols(
    `Area Code` = col_double(),
    Area = col_character(),
    `Item Code` = col_double(),
    Item = col_character(),
    `Element Code` = col_double(),
    Element = col_character(),
    `Year Code` = col_double(),
    Year = col_double(),
    Unit = col_character(),
    Value = col_double(),
    Flag = col_character()
  )) %>% 
  rename(
    "area_code" = "Area Code",
    "area" = "Area",
    "item_code" = "Item Code",
    "item" = "Item",
    "element_code" = "Element Code",
    "element" = "Element",
    "year_code" = "Year Code",
    "year" = "Year",
    "unit" = "Unit",
    "value" = "Value",
    "flag" = "Flag"
  )
  
```

I made a separate CSV file to map the FAO elements/element codes onto the model_groups I use for this analysis.

```{r}
foodbalance_map <- readr::read_csv(
  file = paste0(data_path, "/Daily Energy Requirements for Humans - food_map.csv"),
  col_types = cols(
    item_code = col_double(),
    item = col_character(),
    model_group1 = col_character(),
    model_group = col_character()
  )
)
```

Select only those elements that have to do with food and food supply.

```{r}

food_elements <- data.frame(
  element <- c("Food", "Food supply"),
  units <- c("1000 t/yr", "kcal/cap/yr"),
  element_code <- c(5142, 664)
)

```

Merge the FAO df with the foodbalance mapper to create clean dfs `food_df` and `feed_df`.

```{r}
food_df <- foodbalance_df %>%
  dplyr::filter(element_code %in% c(5142)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na()

feed_df <- foodbalance_df %>%
  dplyr::filter(element_code %in% c(5521)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na()

```

Aggregate tonnes of food/feed by model_group. This also aggregates crops (plant products), animal products, and fish & marine products.
```{r}

food_countries <- food_df %>% 
  dplyr::group_by(area_code, area, year, model_group) %>% 
  dplyr::summarise(tonnes_yr = 1e3*sum(value, na.rm = TRUE), 
                   .groups = "drop")

feed_countries <- feed_df %>% 
  dplyr::group_by(area_code, area, year, model_group) %>% 
  dplyr::summarise(tonnes_yr = 1e3*sum(value, na.rm = TRUE), 
                   .groups = "drop")

```

Let's have a look at world production of food and feed. I group animal, plant and fish/seafood products.

```{r}

food_world <- food_countries %>% 
  dplyr::filter(area == "World") 
feed_world <- feed_countries %>% 
  dplyr::filter(area == "World") 

food_grouped_data <- food_world %>% 
  dplyr::mutate(source_group = ifelse(model_group %in% c("beef_lamb_pork", "meat_poultry", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products")), 
                crop_class = "food")

feed_grouped_data <- feed_world %>% 
  dplyr::mutate(source_group = ifelse(model_group %in% c("beef_lamb_pork", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products")), 
                crop_class = "feed")

```

Bind food and feed dfs.

```{r}
food_feed_grouped_data <- food_grouped_data %>% 
  dplyr::bind_rows(feed_grouped_data)
```

Visualize total annual global food and feed supply.

```{r}
p1 <- ggplot(food_feed_grouped_data, 
       aes(x = year, 
           y = tonnes_yr*1e-9)) + 
  geom_col(aes(fill = crop_class), position = "stack", alpha = 0.8) + 
  geom_hline(yintercept = 0, alpha = 0.9) + 
  theme_minimal() + 
  theme(
    legend.position = "top", 
    legend.title = element_blank(), 
    axis.title.x = element_blank()
  ) + 
  scale_x_continuous(breaks = seq(2010,2019,by=1)) + 
  labs(
    title = "Global production of agricultural food and feed", 
    y = "Gt/year", 
    caption = "Data: FAOSTAT FBS (2022)"
  )

p1
```


<!-- Recall FAOSTAT data. -->

<!-- ```{r} -->
<!-- # total population - both sexes -->
<!-- pop_fao <- foodbalance_df %>% filter(element_code == 511 & item_code == 2501) %>%  -->
<!--   dplyr::mutate(pop_M = value * 1e-3) %>%  -->
<!--   dplyr::select(area_code, area, year, pop_M) -->

<!-- # food supply (kcal/capita/day) -->
<!-- kcal_fao <- foodbalance_df %>% filter(element_code == 664 & item_code == 2901) %>%  -->
<!--   dplyr::mutate(kcal_cap_day = value) %>%  -->
<!--   dplyr::select(area_code, area, year, kcal_cap_day) -->

<!-- daily_Mkcal_demand_fao0 <- pop_fao %>%  -->
<!--   dplyr::full_join(kcal_fao) %>%  -->
<!--   dplyr::mutate(Mkcal_demand_day_FAO = kcal_cap_day * pop_M) %>%  -->
<!--   dplyr::rename(fao_countrycode = area_code) -->

<!-- ``` -->

<!-- Map the country IDs. -->

<!-- ```{r} -->
<!-- daily_Mkcal_demand_fao <- daily_Mkcal_demand_fao0 %>%  -->
<!--   dplyr::left_join(loc_map_reduced) %>%  -->
<!--   dplyr::select(iso_alpha3, fao_countrycode, year, pop_M, kcal_cap_day, Mkcal_demand_day_FAO) -->
<!-- ``` -->

<!-- Subset the 2018 FAO values only. -->

<!-- ```{r} -->
<!-- daily_Mkcal_demand_fao_2018 <- daily_Mkcal_demand_fao %>%  -->
<!--   dplyr::filter(year == 2018) %>%  -->
<!--   dplyr::select(-year) -->
<!-- ``` -->


Based on population and MDER demands by education/activity-level, calculate the total daily caloric demand for (healthy) humans.

```{r}
kcal_demand_by_country <- ssp2_kcal_edu %>% 
  dplyr::group_by(SCENARIO, REGION, year) %>% 
  dplyr::summarise(Mkcal_demand_day_proj = sum(kcal_mean * millions), 
                   population_M = sum(millions), 
                   .groups = "drop") %>%
  dplyr::mutate(scenario = ifelse(
    SCENARIO == "SSP1_v9_130115",
    "SSP1",
    ifelse(
      SCENARIO == "SSP2_v9_130115",
      "SSP2",
      ifelse(
        SCENARIO == "SSP3_v9_130115",
        "SSP3",
        ifelse(
          SCENARIO == "SSP4d_v9_130115",
          "SSP4",
          ifelse(SCENARIO == "SSP5_v9_130115",
                 "SSP5",
                 NA)
        )
      )
    )
  )) %>% 
  dplyr::select(-SCENARIO) %>% 
  dplyr::rename(iso_alpha3 = REGION)
```

Take the year 2020 as the baseline, and calculate changes in kcal demand over time.

```{r}
kcal_demand_proj_diff <- kcal_demand_by_country %>% 
  dplyr::filter(year >= 2020) %>% 
  dplyr::group_by(year, scenario) %>% 
  dplyr::summarise(Mkcal_demand_day_proj = sum(Mkcal_demand_day_proj, na.rm = TRUE), 
                   population_M = sum(population_M, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(Mkcal_demand_day_proj_2020 = ifelse(year == 2020, 
                                                    Mkcal_demand_day_proj, 
                                                    NA), 
                population_M_2020 = ifelse(year == 2020, 
                                                    population_M, 
                                                    NA)) %>% 
  tidyr::fill(Mkcal_demand_day_proj_2020:population_M_2020, .direction = "updown") %>% 
  dplyr::mutate(Tkcal_diff = (Mkcal_demand_day_proj - Mkcal_demand_day_proj_2020) * 1e-6, 
                Tkcal_diff_pc = Tkcal_diff/((Mkcal_demand_day_proj_2020) * 1e-6), 
                pop_diff = population_M - population_M_2020, 
                pop_diff_pc = pop_diff/population_M_2020)
  
```

Clean and elongate.

```{r}
diff_long <- kcal_demand_proj_diff %>% 
  dplyr::select(year, scenario, Tkcal_diff_pc, pop_diff_pc) %>% 
  tidyr::pivot_longer(., cols = Tkcal_diff_pc:pop_diff_pc) %>% 
  dplyr::mutate(label = ifelse(name == "Tkcal_diff_pc", 
                               "caloric demand", 
                               "population"))
```


Change in total global caloric demand, taking 2020 (from the modeled MDER) as the base year. I will include this in SI, showing the effect of demographics on demand for calories over time. Note that in the highest-growth case, SSP3, caloric demand and population remain tightly bound for the entire time series; and for the lowest growth case, SSP1, they decouple over time. This is because the lower growth cases are reaching "peak-child" earlier, and the higher education cases is reducing demand through reduced manual labor.

```{r}
p2a <- ggplot(diff_long, 
       aes(x = year, 
           y = value)) + 
  geom_hline(yintercept = 0, alpha = 0.8) + 
  geom_line(aes(colour = scenario, 
                linetype = label), 
            size = 1, 
            alpha = 0.8) + 
  theme_minimal() + 
  scale_y_continuous(labels = scales::percent) + 
  theme(
    legend.title = element_blank(), 
    axis.title.x = element_blank()
  ) + 
  labs(
    y = "Relative change from 2020 value"
  )
```

Save to disk.

```{r}
p2a
grDevices::jpeg(filename = "Plots/figure_S1c.jpg",
               width = 750,
               height = 500,
               units = "px",
               quality = 1)
p2a
dev.off()
```


```{r}
kcal_demand_proj_diff %>% 
  dplyr::filter(year %in% c(2050, 2075)) %>% 
  dplyr::select(-Mkcal_demand_day_proj, -population_M, -Mkcal_demand_day_proj_2020, -population_M_2020) %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise(Tkcal_diff_max = max(Tkcal_diff), 
                   Tkcal_diff_min = min(Tkcal_diff), 
                   Tkcal_diff_pc_max = max(Tkcal_diff_pc), 
                   Tkcal_diff_pc_min = min(Tkcal_diff_pc), 
                   .groups = "drop")
```


To make this clear I'll display the data similarly to the manuscript figures.

```{r}
ymin <- 0
ymax <- 0.5

p2a <- ggplot(diff_long %>% 
         dplyr::filter(year %in% c(2025, 2050, 2075)) %>% 
           dplyr::filter(scenario == "SSP1"), 
       aes(x = as.factor(year), 
           y = value)) + 
  geom_col(aes(fill = label), 
           alpha = 0.8, 
           position = "dodge") + 
  geom_hline(yintercept = 0, alpha = 0.8, size = 0.4) + 
  scale_fill_manual(values = c(scales::muted("deepskyblue"), scales::muted("magenta4"))) + 
  theme_bw() + 
  theme(
    legend.title = element_blank(), 
    axis.title.x = element_blank(), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) + 
  labs(
    title = "SSP1", 
      y = "Relative change from 2020 value"
  ) + 
  scale_y_continuous(label = scales::percent) + 
  coord_cartesian(ylim = c(ymin, ymax))

p2a_legend <- cowplot::get_legend(p2a)

p2a <- p2a + 
  theme(
    legend.position = "none"
  )

p2b <- ggplot(diff_long %>% 
         dplyr::filter(year %in% c(2025, 2050, 2075)) %>% 
           dplyr::filter(scenario == "SSP2"), 
       aes(x = as.factor(year), 
           y = value)) + 
  geom_col(aes(fill = label), 
           alpha = 0.8, 
           position = "dodge") + 
  geom_hline(yintercept = 0, alpha = 0.8, size = 0.4) + 
  scale_fill_manual(values = c(scales::muted("deepskyblue"), scales::muted("magenta4"))) + 
  theme_bw() + 
  theme(
    legend.position = "none", 
    legend.title = element_blank(), 
    axis.title.x = element_blank(), 
    axis.title.y = element_blank(), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank()
  ) + 
  labs(
    title = "SSP2"
  ) + 
  scale_y_continuous(label = scales::percent) + 
  coord_cartesian(ylim = c(ymin, ymax))

p2c <- ggplot(diff_long %>% 
         dplyr::filter(year %in% c(2025, 2050, 2075)) %>% 
           dplyr::filter(scenario == "SSP3"), 
       aes(x = as.factor(year), 
           y = value)) + 
  geom_col(aes(fill = label), 
           alpha = 0.8, 
           position = "dodge") + 
  geom_hline(yintercept = 0, alpha = 0.8, size = 0.4) + 
  scale_fill_manual(values = c(scales::muted("deepskyblue"), scales::muted("magenta4"))) + 
  theme_bw() + 
  theme(
    legend.position = "none", 
    legend.title = element_blank(), 
    axis.title.x = element_blank(), 
    axis.title.y = element_blank(), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank()
  ) + 
  labs(
    title = "SSP3"
  ) + 
  scale_y_continuous(label = scales::percent) + 
  coord_cartesian(ylim = c(ymin, ymax))

p2d <- ggplot(diff_long %>% 
         dplyr::filter(year %in% c(2025, 2050, 2075)) %>% 
           dplyr::filter(scenario == "SSP4"), 
       aes(x = as.factor(year), 
           y = value)) + 
  geom_col(aes(fill = label), 
           alpha = 0.8, 
           position = "dodge") + 
  geom_hline(yintercept = 0, alpha = 0.8, size = 0.4) + 
  scale_fill_manual(values = c(scales::muted("deepskyblue"), scales::muted("magenta4"))) + 
  theme_bw() + 
  theme(
    legend.position = "none", 
    legend.title = element_blank(), 
    axis.title.x = element_blank(), 
    axis.title.y = element_blank(), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank()
  ) + 
  labs(
    title = "SSP4"
  ) + 
  scale_y_continuous(label = scales::percent) + 
  coord_cartesian(ylim = c(ymin, ymax))

p2e <- ggplot(diff_long %>% 
         dplyr::filter(year %in% c(2025, 2050, 2075)) %>% 
           dplyr::filter(scenario == "SSP5"), 
       aes(x = as.factor(year), 
           y = value)) + 
  geom_col(aes(fill = label), 
           alpha = 0.8, 
           position = "dodge") + 
  geom_hline(yintercept = 0, alpha = 0.8, size = 0.4) + 
  scale_fill_manual(values = c(scales::muted("deepskyblue"), scales::muted("magenta4"))) + 
  theme_bw() + 
  theme(
    legend.position = "none", 
    legend.title = element_blank(), 
    axis.title.x = element_blank(), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) + 
  labs(
    title = "SSP5", 
      y = "Relative change from 2020 value"
  ) + 
  scale_y_continuous(label = scales::percent) + 
  coord_cartesian(ylim = c(ymin, ymax))

```

In several of these cases, I am going to arrange the results in the adaptation-mitigation matrix commonly used for the SSPs. Some annotation for this follows.

```{r}
mitigate_arrow <- ggplot(data = data.frame(x = c(0,1), y = c(0,1)), 
       aes(x = x, y = y)) + 
  annotate("segment", x = 0, xend = 0, y = 0, yend = 1, arrow = arrow()) + 
  annotate("text", x = -0.02, y = 0.5, label = "Socio-economic challenges for mitigation", size = 4, angle = 90) + 
  theme_minimal() + 
  theme(
    axis.title = element_blank(), 
    axis.text = element_blank(), 
    panel.grid = element_blank()
  ) + 
  coord_cartesian(xlim = c(-0.04,0.04), y = c(0, 1))

adapt_arrow <- ggplot(data = data.frame(x = c(0,1), y = c(0,1)), 
       aes(x = x, y = y)) + 
  annotate("segment", x = 0, xend = 1, y = 0, yend = 0, arrow = arrow()) + 
  annotate("text", x = 0.5, y = 0.025, label = "Socio-economic challenges for adaptation", size = 4) + 
  theme_minimal() + 
  theme(
    axis.title = element_blank(), 
    axis.text = element_blank(), 
    panel.grid = element_blank()
  ) + 
  coord_cartesian(xlim = c(0,1), y = c(-0.04, 0.04))
```

Ordinate plot grobs and save to disk.

```{r}
pa <- cowplot::plot_grid(p2e, p2a, ncol = 1)
pb <- cowplot::plot_grid(p2a_legend, p2b, NA, ncol = 1, rel_heights = c(0.5, 1, 0.5))
pc <- cowplot::plot_grid(p2c, p2d, ncol = 1)

pd <- cowplot::plot_grid(pa, pb, pc, ncol = 3)
pe <- cowplot::plot_grid(mitigate_arrow, pd, NA, adapt_arrow, ncol = 2, rel_heights = c(0.9,0.1), rel_widths = c(0.1, 0.9))

grDevices::jpeg(filename = "Plots/figure_S1d.jpg",
               width = 750,
               height = 500,
               units = "px",
               quality = 1)
pe
dev.off()
```



<!-- Map the `kcal_demand_by_country` to geographic IDs and join to the FAO data for 2018. Then take the difference between projected kcal demand and FAO kcal supply. Ignore values earlier than 2020. -->

<!-- ```{r} -->
<!-- tmp <- kcal_demand_by_country %>%  -->
<!--   dplyr::left_join(loc_map_reduced) %>%  -->
<!--   dplyr::left_join(daily_Mkcal_demand_fao_2018) -->

<!-- Tkcal_diff_by_country <- tmp %>%  -->
<!--   dplyr::filter(year >= 2020) %>%  -->
<!--   dplyr::mutate(Tkcal_diff = (Mkcal_demand_day_proj - Mkcal_demand_day_FAO) * 1e-6) %>%  -->
<!--   dplyr::select(scenario, year, iso_alpha3, Mkcal_demand_day_proj, Mkcal_demand_day_FAO, Tkcal_diff) -->

<!-- ``` -->

<!-- The global total values are: -->

<!-- ```{r} -->
<!-- Tkcal_diff_world <- Tkcal_diff_by_country %>%  -->
<!--   dplyr::group_by(scenario, year) %>%  -->
<!--   dplyr::summarise(Mkcal_proj_total = sum(Mkcal_demand_day_proj, na.rm = TRUE),  -->
<!--                    Mkcal_FAO_total = sum(Mkcal_demand_day_FAO, na.rm = TRUE),  -->
<!--                    Tkcal_diff_total = sum(Tkcal_diff, na.rm = TRUE),  -->
<!--                    .groups = "drop") %>%  -->
<!--   dplyr::mutate(Tkcal_diff_total_pc = Tkcal_diff_total/Mkcal_FAO_total) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- ggplot(Tkcal_diff_world,  -->
<!--        aes(x = year,  -->
<!--            y = Tkcal_diff_total_pc)) +  -->
<!--   geom_hline(yintercept = 0, alpha = 0.9) +  -->
<!--   geom_line(aes(colour = scenario)) +  -->
<!--   theme_minimal() +  -->
<!--   scale_y_continuous(labels = scales::percent) -->
<!-- ``` -->


# Comparison analysis: historical supply to future demand

How does the supply compare to expected demand in future? 

```{r}
population <- foodbalance_df %>% 
  dplyr::filter(element_code %in% c(511)) %>% 
  dplyr::filter(area == "World") %>% 
  dplyr::select(area, year, value) %>% 
  dplyr::rename(thousand_persons = value)

foodsupply <- foodbalance_df %>% 
  dplyr::filter(element_code %in% c(664)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(food_source = ifelse(model_group %in% c("beef_lamb_pork", "meat_poultry", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products"))) %>% 
  dplyr::filter(area == "World") %>% 
  dplyr::group_by(area, year, unit, food_source) %>% 
  dplyr::summarise(kcal_cap_day = sum(value), 
                   .groups = "drop")

fao_kcal_df <- population %>% 
  dplyr::full_join(foodsupply) %>% 
  dplyr::mutate(M_kcal_per_day = kcal_cap_day*thousand_persons * 1e-3, 
         diet_plan = "FAO", 
         SCENARIO = "FAO") %>% 
  dplyr::select(SCENARIO, diet_plan, year, food_source, M_kcal_per_day)

fao_kcal_diff <- fao_kcal_df %>% 
  dplyr::full_join(all_plans_long %>% 
  dplyr::filter(year >= 2020)) %>% 
  dplyr::mutate(M_kcal_per_day_2018 = ifelse(year == 2018, M_kcal_per_day, NA)) %>% 
  dplyr::group_by(food_source) %>% 
  tidyr::fill(M_kcal_per_day_2018) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(year >= 2018) %>% 
  dplyr::mutate(diff = M_kcal_per_day - M_kcal_per_day_2018, 
                pc_diff = diff/M_kcal_per_day_2018)

fao_kcal_diff <- fao_kcal_diff %>%
  dplyr::mutate(diet_plan_f = ifelse(
    diet_plan == "ELA-PHD",
    "ELA",
    ifelse(
      diet_plan == "CNS-CFP",
      "CNS",
      ifelse(diet_plan == "FDA-SDP",
             "USDA", 
             NA)
    )
  ))

fao_kcal_diff$diet_plan_f <- factor(fao_kcal_diff$diet_plan_f, levels = c("ELA", "CNS", "USDA"))

```

## Caloric demand

Prepare some plot annotations and colour sets.

```{r}
cols <-
  c(
    "animal_products" = "#F17EB8",
    "fish_seafood" = "#489ED3",
    "plant_products" = "#EEAF35"
  )
xlabz <- c("ELA", "CNS", "USDA")
labz <-
  c("Animal Products", "Fish and Seafood", "Plant Products")
```


Plot a comparison of absolute change (increase positive, decrease negative) of total global caloric demand (i.e., 10^12 kcal per day, or Tkcal/day) for animal, plant, and seafood products.

```{r}
ymin <- -4.5
ymax <- 6

p3a <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-6)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
   scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP1", y = "Tkcal/day over 2018 supply") +
  facet_wrap( ~ year)

p3_legend_only <- cowplot::get_legend(p3a)

p3a <- p3a +
  theme(legend.position = "none")

p3b <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
   aes(x = diet_plan_f,
      y = diff * 1e-6)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)

p3c <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-6)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)

p3d <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-6)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP4") +
  facet_wrap( ~ year)

p3e <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-6)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP5", y = "Tkcal/day over 2018 supply") +
  facet_wrap( ~ year)
```

Save this plot to disk.

```{r}
pa <- plot_grid(p3e, p3a, ncol = 1)
pb <- plot_grid(p3_legend_only, p3b, NA, ncol = 1, rel_heights = c(0.5, 1, 0.5))
pc <- plot_grid(p3c, p3d, ncol = 1)

p3 <- cowplot::plot_grid(pa, pb, pc, ncol = 3)
cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_heights = c(0.9,0.1), rel_widths = c(0.1, 0.9))

grDevices::jpeg(filename = "Plots/figure_S2a.jpg", 
               width = 750, 
               height = 500, 
               units = "px", 
               quality = 1)
cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_heights = c(0.9,0.1), rel_widths = c(0.1, 0.9))
dev.off()
```

From the same data, plot relative change to the 2018 baseline (i.e., ratio of change from 2018 supply to 2018 supply). This plot is a little busier because relative changes are not additive, and each column needs to be separate.

```{r}
ymin <- min(fao_kcal_diff$pc_diff)
ymax <- max(fao_kcal_diff$pc_diff)

p2a <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
   scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  scale_x_discrete(labels = xlabz) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP1", y = "Relative to 2018 supply") +
  facet_wrap( ~ year)

p2_legend_only <- cowplot::get_legend(p2a)

p2a <- p2a +
  theme(legend.position = "none")

p2b <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
   aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  scale_x_discrete(labels = xlabz) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)

p2c <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  scale_x_discrete(labels = xlabz) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)

p2d <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  scale_x_discrete(labels = xlabz) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP4") +
  facet_wrap( ~ year)

p2e <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  scale_x_discrete(labels = xlabz) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP5", y = "Relative to 2018 supply") +
  facet_wrap( ~ year)
```

Arrange plots and save to disk.

```{r}
pa <- plot_grid(p2e, p2a, ncol = 1)
pb <- plot_grid(p2_legend_only, p2b, NA, ncol = 1, rel_heights = c(0.5, 1, 0.5))
pc <- plot_grid(p2c, p2d, ncol = 1)

p2 <- cowplot::plot_grid(pa, pb, pc, ncol = 3)
cowplot::plot_grid(mitigate_arrow, p2, NA, adapt_arrow, ncol = 2, rel_heights = c(0.9,0.1), rel_widths = c(0.1, 0.9))

grDevices::jpeg(filename = "Plots/figure_S2b.jpg", 
               width = 750, 
               height = 500, 
               units = "px", 
               quality = 1)
cowplot::plot_grid(mitigate_arrow, p2, NA, adapt_arrow, ncol = 2, rel_heights = c(0.9,0.1), rel_widths = c(0.1, 0.9))
dev.off()
```

## Plot Figure 3

For better clarity, I aggregate the above data into plots that represent the SSPs by error bars.

```{r}
fao_kcal_diff_ranges <- fao_kcal_diff %>%
  dplyr::filter(diet_plan != "FAO") %>%
  dplyr::group_by(diet_plan_f, year, food_source) %>%
  dplyr::summarise(
    diff_mean = mean(diff, na.rm = TRUE),
    diff_max = max(diff, na.rm = TRUE),
    diff_min = min(diff, na.rm = TRUE),
    pc_diff_mean = mean(pc_diff, na.rm = TRUE),
    pc_diff_max = max(pc_diff, na.rm = TRUE),
    pc_diff_min = min(pc_diff, na.rm = TRUE),
    .groups = "drop"
  )

# fao_kcal_diff_ranges
```

This plot consolidates all of the information given above on a single canvas.

```{r}
legend_only_test <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_col(aes(fill = food_source), 
           alpha = 0.8, position = "dodge") +
  scale_fill_manual(values = cols,
                    labels = labz) +
  scale_x_discrete(labels = xlabz) +
  theme(
    legend.title = element_blank(),
    legend.direction = "horizontal"
    ) + 
  facet_wrap(~ year)

p3_legend_only <- cowplot::get_legend(legend_only_test)

p3a <- ggplot(
  fao_kcal_diff_ranges %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)) %>%
    dplyr::filter(food_source == "animal_products"),
  aes(x = diet_plan_f,
      y = diff_mean * 1e-6)
) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") +
  geom_errorbar(
    aes(ymin = diff_min * 1e-6, ymax = diff_max * 1e-6),
    width = 0.1,
    alpha = 0.8,
    position = position_dodge(0.9)
  ) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  scale_fill_manual(values = cols,
                    labels = labz) +
  scale_x_discrete(labels = xlabz) +
  # scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) + 
  theme_bw() +
  theme(
     axis.text.y = element_text(
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none",
    panel.grid.major.y = element_line(colour = "grey"),
    panel.grid.minor.y = element_line(colour = "grey"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(), 
    axis.text.x = element_blank(), 
    axis.title.y = element_blank()
  ) + 
  labs(
    subtitle = "Absolute change in caloric demand", 
    y = "Tkcal/day over 2018 supply"
  ) + 
  facet_wrap(~ year) 

p3b <- ggplot(
  fao_kcal_diff_ranges %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)) %>%
    dplyr::filter(food_source == "fish_seafood"),
  aes(x = diet_plan_f,
      y = diff_mean * 1e-6)
) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") +
  geom_errorbar(
    aes(ymin = diff_min * 1e-6, ymax = diff_max * 1e-6),
    width = 0.1,
    alpha = 0.8,
    position = position_dodge(0.9)
  ) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  scale_fill_manual(values = cols,
                    labels = labz) +
  scale_x_discrete(labels = xlabz) +
  # scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) + 
  theme_bw() +
  theme(
     axis.text.y = element_text(
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none",
    panel.grid.major.y = element_line(colour = "grey"),
    panel.grid.minor.y = element_line(colour = "grey"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(), 
    axis.text.x = element_blank(), 
    axis.title.y = element_blank()
  ) + 
  labs(
    y = "Tkcal/day over 2018 supply"
  ) + 
  facet_wrap(~ year) 

p3c <- ggplot(
  fao_kcal_diff_ranges %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)) %>%
    dplyr::filter(food_source == "plant_products"),
  aes(x = diet_plan_f,
      y = diff_mean * 1e-6)
) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") +
  geom_errorbar(
    aes(ymin = diff_min * 1e-6, ymax = diff_max * 1e-6),
    width = 0.1,
    alpha = 0.8,
    position = position_dodge(0.9)
  ) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  scale_fill_manual(values = cols,
                    labels = labz) +
  scale_x_discrete(labels = xlabz) +
  # scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      size = 10, 
      angle = 90, hjust = 1, vjust = 0.5
    ), 
     axis.text.y = element_text(
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none",
    panel.grid.major.y = element_line(colour = "grey"),
    panel.grid.minor.y = element_line(colour = "grey"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) + 
  labs(
    y = "Tkcal/day over 2018 supply"
  ) + 
  facet_wrap(~ year) 

p3d <- ggplot(
  fao_kcal_diff_ranges %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)) %>%
    dplyr::filter(food_source == "animal_products"),
  aes(x = diet_plan_f,
      y = pc_diff_mean)
) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") +
  geom_errorbar(
    aes(ymin = pc_diff_min, ymax = pc_diff_max),
    width = 0.1,
    alpha = 0.8,
    position = position_dodge(0.9)
  ) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  scale_fill_manual(values = cols,
                    labels = labz) +
  scale_x_discrete(labels = xlabz) +
  scale_y_continuous(labels = scales::percent) + 
  theme_bw() +
  theme(
     axis.text.y = element_text(
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none",
    panel.grid.major.y = element_line(colour = "grey"),
    panel.grid.minor.y = element_line(colour = "grey"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(), 
    axis.text.x = element_blank(), 
    axis.title.y = element_blank()
  ) + 
  labs(
    subtitle = "Relative change in caloric demand", 
    y = "Relative to 2018 supply"
  ) + 
  facet_wrap(~ year)

p3e <- ggplot(
  fao_kcal_diff_ranges %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)) %>%
    dplyr::filter(food_source == "fish_seafood"),
  aes(x = diet_plan_f,
      y = pc_diff_mean)
) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") +
  geom_errorbar(
    aes(ymin = pc_diff_min, ymax = pc_diff_max),
    width = 0.1,
    alpha = 0.8,
    position = position_dodge(0.9)
  ) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  scale_fill_manual(values = cols,
                    labels = labz) +
  scale_x_discrete(labels = xlabz) +
  scale_y_continuous(labels = scales::percent) + 
  theme_bw() +
  theme(
     axis.text.y = element_text(
      size = 7
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none",
    panel.grid.major.y = element_line(colour = "grey"),
    panel.grid.minor.y = element_line(colour = "grey"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(), 
    axis.text.x = element_blank(), 
    axis.title.y = element_blank()
  ) + 
  labs(
    y = "Relative to 2018 supply"
  ) + 
  facet_wrap(~ year)

p3f <- ggplot(
  fao_kcal_diff_ranges %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)) %>%
    dplyr::filter(food_source == "plant_products"),
  aes(x = diet_plan_f,
      y = pc_diff_mean)
) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") +
  geom_errorbar(
    aes(ymin = pc_diff_min, ymax = pc_diff_max),
    width = 0.1,
    alpha = 0.8,
    position = position_dodge(0.9)
  ) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  scale_fill_manual(values = cols,
                    labels = labz) +
  scale_x_discrete(labels = xlabz) +
  scale_y_continuous(labels = scales::percent) + 
  theme_bw() +
  theme(
    axis.text.x = element_text(
      size = 10, 
      angle = 90, hjust = 1, vjust = 0.5
    ), 
     axis.text.y = element_text(
      size = 7
    ), 
    axis.title = element_blank(), 
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none",
    panel.grid.major.y = element_line(colour = "grey"),
    panel.grid.minor.y = element_line(colour = "grey"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  ) + 
  facet_wrap(~ year)

```

I include some annotation.

```{r}
annotate_y1 <- ggplot(data = data.frame(x = c(0,1), y = c(0,1)), 
       aes(x = x, y = y)) + 
  annotate("text", x = -0.02, y = 0.5, label = "Tkcal/day over 2018 supply", size = 3, angle = 90) + 
  theme_minimal() + 
  theme(
    axis.title = element_blank(), 
    axis.text = element_blank(), 
    panel.grid = element_blank()
  ) + 
  coord_cartesian(xlim = c(-0.04,0.04), y = c(0, 1))

annotate_y2 <- ggplot(data = data.frame(x = c(0,1), y = c(0,1)), 
       aes(x = x, y = y)) + 
  annotate("text", x = -0.02, y = 0.5, label = "Relative to 2018 supply", size = 3, angle = 90) + 
  theme_minimal() + 
  theme(
    axis.title = element_blank(), 
    axis.text = element_blank(), 
    panel.grid = element_blank()
  ) + 
  coord_cartesian(xlim = c(-0.04,0.04), y = c(0, 1))
```

Save to disk.

```{r}

pa <- cowplot::plot_grid(p3a, p3b, p3c, ncol = 1, rel_heights = c(0.33, 0.29, 0.37), align = "v")
pb <- cowplot::plot_grid(p3d, p3e, p3f, ncol = 1, rel_heights = c(0.33, 0.29, 0.37), align = "v")

p_tmp <- cowplot::plot_grid(annotate_y1, pa, annotate_y2, pb, ncol = 4, rel_widths = c(0.05, 0.45, 0.05, 0.45))

cowplot::plot_grid(p3_legend_only, p_tmp, ncol = 1, rel_heights = c(0.1,0.9))

grDevices::jpeg(filename = "Plots/figure_3.jpg", 
               width = 750, 
               height = 500, 
               units = "px", 
               quality = 1)
cowplot::plot_grid(p3_legend_only, p_tmp, ncol = 1, rel_heights = c(0.1,0.9))
dev.off()

```

Find maxima and minima.

```{r}
fao_kcal_diff_ranges %>% 
  dplyr::filter(year %in% c(2050, 2075)) %>% 
  dplyr::group_by(year, food_source) %>% 
  dplyr::summarise(diff_max = max(diff_max) * 1e-6, 
                   diff_min = min(diff_min) * 1e-6, 
                   pc_diff_max = max(pc_diff_max), 
                   pc_diff_min = min(pc_diff_min), 
                   .groups = "drop")
```


```{r}
out_fig3 <- fao_kcal_diff %>% 
  dplyr::filter(diet_plan != "FAO") %>% 
  dplyr::group_by(SCENARIO, diet_plan, year) %>% 
  dplyr::summarise(Tkcal_day = sum(M_kcal_per_day * 1e-6), 
                   Tkcal_day_baseline = sum(M_kcal_per_day_2018 * 1e-6), 
                   .groups = "drop") %>% 
  dplyr::mutate(Tkcal_day_diff = Tkcal_day-Tkcal_day_baseline, 
                Tkcal_day_diff_pc = Tkcal_day_diff/Tkcal_day_baseline) %>% 
  dplyr::filter(year %in% c(2025, 2050, 2075))

```


```{r}
out_fig3 <- out_fig3 %>% 
  dplyr::mutate(diet_plan_f = ifelse(diet_plan == "CNS-CFP", 
                                     "CNS", 
                                     ifelse(diet_plan == "ELA-PHD", 
                                            "ELA", 
                                            ifelse(diet_plan == "FDA-SDP", 
                                                   "USDA", 
                                                   NA))))
out_fig3$diet_plan_f <- factor(out_fig3$diet_plan_f, levels = c("ELA", "CNS", "USDA"))
```

```{r}

out_fig3_abs <- out_fig3 %>% 
  dplyr::select(-Tkcal_day_diff_pc) %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise(diff_max = max(Tkcal_day_diff), 
                   diff_min = min(Tkcal_day_diff), 
                   .groups = "drop")

out_fig3_pc <- out_fig3 %>% 
  dplyr::select(-Tkcal_day_diff) %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise(pc_diff_max = max(Tkcal_day_diff_pc), 
                   pc_diff_min = min(Tkcal_day_diff_pc), 
                   .groups = "drop")

out_fig3_abs
out_fig3_pc
```

```{r}
ymin <- min(out_fig3_abs$diff_min)
ymax <- max(out_fig3_abs$diff_max)

p3a <- ggplot(
  out_fig3 %>%
    dplyr::filter(SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = Tkcal_day_diff)
) + 
  geom_col(alpha = 0.8) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP1", y = "Tkcal/day over 2018 supply") +
  facet_wrap( ~ year)

p3b <- ggplot(
  out_fig3 %>%
    dplyr::filter(SCENARIO == "SSP2_v9_130115"),
   aes(x = diet_plan_f,
      y = Tkcal_day_diff)
) +
  geom_col(alpha = 0.8) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)

p3c <- ggplot(
  out_fig3 %>% 
    dplyr::filter(SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = Tkcal_day_diff)
) +
  geom_col(alpha = 0.8) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)

p3d <- ggplot(
  out_fig3 %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = Tkcal_day_diff)
) +
  geom_col(alpha = 0.8) + 
 geom_hline(yintercept = 0, alpha = 0.8) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP4", y = "Tkcal/day over 2018 supply") +
  facet_wrap( ~ year)

p3e <- ggplot(
  out_fig3 %>%
    dplyr::filter(SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = Tkcal_day_diff)
) +
  geom_col(alpha = 0.8) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP5") +
  facet_wrap( ~ year)
```


```{r}
pa <- plot_grid(p3e, p3a, ncol = 1)
pb <- plot_grid(NA, p3b, NA, ncol = 1, rel_heights = c(0.5, 1, 0.5))
pc <- plot_grid(p3c, p3d, ncol = 1)

p3 <- cowplot::plot_grid(pa, pb, pc, ncol = 3)
cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_heights = c(0.9,0.1), rel_widths = c(0.1, 0.9))

# grDevices::jpeg(filename = "Plots/figure_S3c.jpg", 
#                width = 750, 
#                height = 500, 
#                units = "px", 
#                quality = 1)
# cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_heights = c(0.9,0.1), rel_widths = c(0.1, 0.9))
# dev.off()
```

```{r}
ymin <- min(out_fig3_pc$pc_diff_min)
ymax <- max(out_fig3_pc$pc_diff_max)

p3a <- ggplot(
  out_fig3 %>%
    dplyr::filter(SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = Tkcal_day_diff_pc)
) + 
  geom_col(alpha = 0.8) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP1", y = "Relative to 2018 supply") +
  facet_wrap( ~ year) + 
  scale_y_continuous(labels = scales::percent)

p3b <- ggplot(
  out_fig3 %>%
    dplyr::filter(SCENARIO == "SSP2_v9_130115"),
   aes(x = diet_plan_f,
      y = Tkcal_day_diff_pc)
) +
  geom_col(alpha = 0.8) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year) + 
  scale_y_continuous(labels = scales::percent)

p3c <- ggplot(
  out_fig3 %>% 
    dplyr::filter(SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = Tkcal_day_diff_pc)
) +
  geom_col(alpha = 0.8) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year) + 
  scale_y_continuous(labels = scales::percent)

p3d <- ggplot(
  out_fig3 %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = Tkcal_day_diff_pc)
) +
  geom_col(alpha = 0.8) + 
 geom_hline(yintercept = 0, alpha = 0.8) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP4") +
  facet_wrap( ~ year) + 
  scale_y_continuous(labels = scales::percent)

p3e <- ggplot(
  out_fig3 %>%
    dplyr::filter(SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = Tkcal_day_diff_pc)
) +
  geom_col(alpha = 0.8) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP5", y = "Relative to 2018 supply") +
  facet_wrap( ~ year) + 
  scale_y_continuous(labels = scales::percent)
```


```{r}
pa <- plot_grid(p3e, p3a, ncol = 1)
pb <- plot_grid(NA, p3b, NA, ncol = 1, rel_heights = c(0.5, 1, 0.5))
pc <- plot_grid(p3c, p3d, ncol = 1)

p3 <- cowplot::plot_grid(pa, pb, pc, ncol = 3)
cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_heights = c(0.9,0.1), rel_widths = c(0.1, 0.9))

# grDevices::jpeg(filename = "Plots/figure_S3d.jpg", 
#                width = 750, 
#                height = 500, 
#                units = "px", 
#                quality = 1)
# cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_heights = c(0.9,0.1), rel_widths = c(0.1, 0.9))
# dev.off()
```


Harmonize the countries represented. First, countries in the FAO data set.

```{r}
food_hist_tmp <- food_countries %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::full_join(loc_map_reduced) %>% 
  distinct(iso_alpha3) %>% 
  mutate(hist_food = "food")
feed_hist_tmp <- feed_countries %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::full_join(loc_map_reduced) %>% 
  distinct(iso_alpha3) %>% 
  mutate(hist_feed = "feed")

food_feed_hist_tmp <- food_hist_tmp %>% 
  dplyr::full_join(feed_hist_tmp)

```

Then countries in the projected pathways data set.

```{r}
food_proj_tmp <- food_proj %>% distinct(iso_alpha3) %>% mutate(proj_food = "food")
feed_proj_tmp <- feed_proj %>% distinct(iso_alpha3) %>% mutate(proj_feed = "feed")

food_feed_proj_tmp <- food_proj_tmp %>% 
  dplyr::full_join(feed_proj_tmp)
```

Compare these dfs to find shared countries. Then drop non-existing values.

```{r}
iso_list_harmonized <- food_feed_hist_tmp %>% 
  dplyr::full_join(food_feed_proj_tmp) %>% 
  tidyr::drop_na() %>% 
  dplyr::pull(iso_alpha3)
```


# Production Demand Analysis

We next back-out production values (tonnes/year) for plant, animal and fish/marine products, based on assumptions about the edible ratio of crops and animals for food, feed conversion ratios (FCRs) for livestock feed, processing and value chain loss and waste, and feed ingredient mixtures. These were processed in the `iep_healthy_food.Rmd` markdown.

To determine total food and feed consumption, bind projected food crop (`food_weight`), projected livestock & fish for food (`live_food_weight`), and total projected feed (from animal, fish, and plant products, `feed_ingredient_demand_summary`).

```{r}
food_proj <- food_weight %>% 
  dplyr::filter(iso_alpha3 %in% iso_list_harmonized) %>% 
  dplyr::mutate(tonnes_yr = tonnes_day_food * 365) %>%
  dplyr::select(SCENARIO,
                iso_alpha3,
                subregionname,
                diet_plan,
                year,
                model_group,
                tonnes_yr) %>%
  dplyr::bind_rows(
    live_food_weight %>% 
  dplyr::filter(iso_alpha3 %in% iso_list_harmonized) %>%
      dplyr::mutate(tonnes_yr = tonnes_day_food * 365) %>%
      dplyr::select(
        SCENARIO,
        iso_alpha3,
        subregionname,
        diet_plan,
        year,
        model_group,
        tonnes_yr
      )
  ) %>%
  dplyr::mutate(scenario = ifelse(
    SCENARIO == "SSP1_v9_130115",
    "SSP1",
    ifelse(
      SCENARIO == "SSP2_v9_130115",
      "SSP2",
      ifelse(
        SCENARIO == "SSP3_v9_130115",
        "SSP3",
        ifelse(SCENARIO == "SSP4d_v9_130115",
               "SSP4",
               "SSP5")
      )
    )
  )) %>% 
  dplyr::select(-SCENARIO) %>% 
  dplyr::filter(year >= 2025)

feed_proj <- feed_ingredient_demand_summary %>% 
  dplyr::filter(iso_alpha3 %in% iso_list_harmonized) %>% 
  dplyr::mutate(tonnes_yr = tonnes_day*365) %>% 
  dplyr::select(-tonnes_day) %>%
  dplyr::mutate(scenario = ifelse(
    SCENARIO == "SSP1_v9_130115",
    "SSP1",
    ifelse(
      SCENARIO == "SSP2_v9_130115",
      "SSP2",
      ifelse(
        SCENARIO == "SSP3_v9_130115",
        "SSP3",
        ifelse(SCENARIO == "SSP4d_v9_130115",
               "SSP4",
               "SSP5")
      )
    )
  )) %>% 
  dplyr::select(-SCENARIO) %>% 
  dplyr::filter(year >= 2025)

```

Summarise these after classifying as animal, plant and fish/seafood products.

```{r}
food_proj_summary_all_years <- food_proj %>% 
  dplyr::group_by(year, scenario, model_group, diet_plan) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(diet_plan = ifelse(diet_plan == "CNS-CFP", "CNS", ifelse(diet_plan == "ELA-PHD", "ELA", "USDA"))) %>% 
  dplyr::mutate(source_group = ifelse(model_group %in% c("cereals", "legumes", "oils", "roots_tubers", "sugarcrops", "treenuts", "vegetables", "fruits"), 
                                    "plant_products", 
                                    ifelse(model_group %in% c("meat_poultry", "beef_lamb_pork", "chicken_poultry", "dairy", "eggs"), 
                                           "animal_products", 
                                           ifelse(model_group %in% c("fish_seafood"), 
                                                  "fish_seafood", 
                                                  NA)))) %>% 
  dplyr::group_by(year, scenario, diet_plan, source_group) %>% 
  dplyr::summarise(t_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") 

food_proj_summary <- food_proj_summary_all_years %>% 
  dplyr::filter(year %in% c(2025, 2050, 2075))

feed_proj_summary_all_years <- feed_proj %>% 
  dplyr::group_by(year, scenario, model_group, diet_plan) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(diet_plan = ifelse(diet_plan == "CNS-CFP", "CNS", ifelse(diet_plan == "ELA-PHD", "ELA", "USDA"))) %>% 
  dplyr::mutate(source_group = ifelse(model_group %in% c("cereal", "legumes", "oils", "roots_tubers", "sugarcrops", "vegetables", "stimulants", "fruits"), 
                                    "plant_products", 
                                    ifelse(model_group %in% c("bovine_dairy", "bovine_meat", "caprine_meat", "sus_meat", "eggs"), 
                                           "animal_products", 
                                           ifelse(model_group %in% c("fish"), 
                                                  "fish_seafood", 
                                                  NA)))) %>% 
  dplyr::group_by(year, scenario, diet_plan, source_group) %>% 
  dplyr::summarise(t_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop")

feed_proj_summary <- feed_proj_summary_all_years %>% 
  dplyr::filter(year %in% c(2025, 2050, 2075))
```

Bind these projected values to historic values for food and feed.

```{r}
food_hist_summary <- food_countries %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::full_join(loc_map_reduced) %>% 
  dplyr::filter(iso_alpha3 %in% iso_list_harmonized) %>% 
  dplyr::mutate(source_group = ifelse(model_group %in% c("beef_lamb_pork", "meat_poultry", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products"))) %>% 
  dplyr::group_by(year, source_group) %>% 
  dplyr::summarise(t_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::filter(year %in% c(2018))

feed_hist_summary <- feed_countries %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::full_join(loc_map_reduced) %>% 
  dplyr::filter(iso_alpha3 %in% iso_list_harmonized) %>% 
  dplyr::mutate(source_group = ifelse(model_group %in% c("beef_lamb_pork", "meat_poultry", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products"))) %>% 
  dplyr::group_by(year, source_group) %>% 
  dplyr::summarise(t_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::filter(year %in% c(2018))
```

Bind these into summary dfs of food and feed differences in future demand from 2018 supply.

```{r}
food_proj_diff <- food_proj_summary %>% 
  dplyr::full_join(food_hist_summary %>% 
  dplyr::select(-year) %>% 
  dplyr::rename(t_yr_2018 = t_yr)) %>% 
  dplyr::mutate(t_yr_diff = t_yr - t_yr_2018) %>% 
  dplyr::mutate(pc_diff = t_yr_diff/t_yr_2018) %>% 
  dplyr::mutate(crop_class = "food")

feed_proj_diff <- feed_proj_summary %>% 
  dplyr::full_join(feed_hist_summary %>% 
  dplyr::select(-year) %>% 
  dplyr::rename(t_yr_2018 = t_yr)) %>% 
  dplyr::mutate(t_yr_diff = t_yr - t_yr_2018) %>% 
  dplyr::mutate(pc_diff = t_yr_diff/t_yr_2018) %>% 
  dplyr::mutate(crop_class = "feed")

```

Combine both of these to harmonize with how I've written the plotting code below.

```{r}
food_feed_proj_diff <- food_proj_diff %>% 
  dplyr::full_join(feed_proj_diff) %>% 
  dplyr::mutate(diet_plan_f = diet_plan)

food_feed_proj_diff$diet_plan_f <- factor(food_feed_proj_diff$diet_plan, c("ELA", "CNS", "USDA"))
```

First I will plot the total gross weight differences.

```{r}
food_feed_proj_diff_tmp <- food_feed_proj_diff %>% 
  dplyr::group_by(year, scenario, crop_class, diet_plan_f) %>% 
  dplyr::summarise(t_yr = sum(t_yr, na.rm = TRUE), 
                   t_yr_2018 = sum(t_yr_2018, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(t_yr_diff = t_yr - t_yr_2018) %>% 
  dplyr::mutate(pc_diff = t_yr_diff/t_yr_2018)
```

## Plot Figure 4

```{r, warning=FALSE}

food_tmp <- food_feed_proj_diff_tmp %>% 
  dplyr::filter(crop_class == "food")
food_ymin_abs <- min(food_tmp$t_yr_diff) * 1e-9
food_ymax_abs <- max(food_tmp$t_yr_diff) * 1e-9
food_ymin_pc <- min(food_tmp$pc_diff)
food_ymax_pc <- max(food_tmp$pc_diff)

feed_tmp <- food_feed_proj_diff_tmp %>% 
  dplyr::filter(crop_class == "feed")
feed_ymin_abs <- min(feed_tmp$t_yr_diff) * 1e-9
feed_ymax_abs <- max(feed_tmp$t_yr_diff) * 1e-9
feed_ymin_pc <- min(feed_tmp$pc_diff)
feed_ymax_pc <- max(feed_tmp$pc_diff)

p1_food <- ggplot(
  data = food_tmp %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)),
  mapping = aes(x = diet_plan_f,
                y = t_yr_diff * 1e-9)
) +
  geom_col(
    aes(alpha = scenario),
    position = "dodge",
    fill = scales::muted("green"),
    colour = "black",
    size = 0.1
  ) +
  geom_hline(yintercept = 0, alpha = 0.9) +
  scale_fill_manual(labels = labz) +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    axis.text.x = element_text(
      angle = 90,
      hjust = 0.9,
      vjust = 0.5,
      size = 12
    ),
    axis.text.y = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    strip.text = element_text(size = 14)
  ) +
  labs(title = "Food for humans (absolute change)",
       y = "Gt/year above 2018 supply") +
  facet_grid( ~ year) +
  coord_cartesian(ylim = c(food_ymin_abs, food_ymax_abs))

p1_food_legend <- cowplot::get_legend(p1_food)
p1_food <- p1_food +
  theme(legend.position = "none")

p1_feed <- ggplot(
  data = feed_tmp %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)),
  mapping = aes(x = diet_plan_f,
                y = t_yr_diff * 1e-9)
) +
  geom_col(
    aes(alpha = scenario),
    position = "dodge",
    fill = scales::muted("magenta"),
    colour = "black",
    size = 0.1
  ) +
  geom_hline(yintercept = 0, alpha = 0.9) +
  scale_fill_manual(labels = labz) +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    axis.text.x = element_text(
      angle = 90,
      hjust = 0.9,
      vjust = 0.5,
      size = 12
    ),
    axis.text.y = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    strip.text = element_text(size = 14)
  ) +
  labs(title = "Feed for animals (absolute change)",
       y = "Gt/year above 2018 supply") +
  facet_grid( ~ year) +
  coord_cartesian(ylim = c(feed_ymin_abs, feed_ymax_abs))

p1_feed_legend <- cowplot::get_legend(p1_feed)
p1_feed <- p1_feed +
  theme(legend.position = "none")

p1_food_pc <- ggplot(
  data = food_tmp %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)),
  mapping = aes(x = diet_plan_f,
                y = pc_diff)
) +
  geom_col(
    aes(alpha = scenario),
    position = "dodge",
    fill = scales::muted("green"),
    colour = "black",
    size = 0.1
  ) +
  geom_hline(yintercept = 0, alpha = 0.9) +
  scale_fill_manual(labels = labz) +
  theme_bw() +
  theme(
    legend.position = "none",
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    axis.text.x = element_text(
      angle = 90,
      hjust = 0.9,
      vjust = 0.5,
      size = 12
    ),
    axis.text.y = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    strip.text = element_text(size = 14)
  ) +
  labs(title = "Food for humans (relative change)",
       y = "Relative change from 2018") +
  facet_grid( ~ year) +
  coord_cartesian(ylim = c(food_ymin_pc, food_ymax_pc)) + 
  scale_y_continuous(labels = scales::percent)

p1_feed_pc <- ggplot(
  data = feed_tmp %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)),
  mapping = aes(x = diet_plan_f,
                y = pc_diff)
) +
  geom_col(
    aes(alpha = scenario),
    position = "dodge",
    fill = scales::muted("magenta"),
    colour = "black",
    size = 0.1
  ) +
  geom_hline(yintercept = 0, alpha = 0.9) +
  scale_fill_manual(labels = labz) +
  theme_bw() +
  theme(
    legend.position = "none",
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    axis.text.x = element_text(
      angle = 90,
      hjust = 0.9,
      vjust = 0.5,
      size = 12
    ),
    axis.text.y = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    strip.text = element_text(size = 14)
  ) +
  labs(title = "Feed for animals (relative change)",
       y = "Relative change from 2018") +
  facet_grid( ~ year) +
  coord_cartesian(ylim = c(feed_ymin_pc, feed_ymax_pc)) + 
  scale_y_continuous(labels = scales::percent)

```

Save this to disk.

```{r}
pa <- cowplot::plot_grid(p1_food, p1_feed, ncol = 1)
pb <- cowplot::plot_grid(p1_food_legend, p1_feed_legend, ncol = 1)
pc <- cowplot::plot_grid(p1_food_pc, p1_feed_pc, ncol = 1)

cowplot::plot_grid(pa, pb, pc, ncol = 3, rel_widths = c(0.44, 0.1, 0.46))

grDevices::jpeg(filename = "Plots/figure_4.jpg", 
               width = 750, 
               height = 500, 
               units = "px", 
               quality = 1)
cowplot::plot_grid(pa, pb, pc, ncol = 3, rel_widths = c(0.44, 0.1, 0.46))
dev.off()

```

Find maxima and minima.

```{r}
food_feed_proj_diff_tmp %>% 
  dplyr::filter(year %in% c(2050, 2075)) %>% 
  dplyr::group_by(year, crop_class) %>% 
  dplyr::summarise(Gt_diff_max = max(t_yr_diff)*1e-9, 
                   Gt_diff_min = min(t_yr_diff)*1e-9, 
                   pc_diff_max = max(pc_diff), 
                   pc_diff_min = min(pc_diff), 
                   .groups = "drop")
```

## Plot Figure 5

Food and feed demand disaggregated by source.

```{r, warning=FALSE}

food_tmp <- food_feed_proj_diff %>% 
  dplyr::filter(crop_class == "food") %>% 
  dplyr::mutate(source_group = ifelse(source_group == "animal_products", 
                                      "animal", 
                                      ifelse(source_group == "plant_products", 
                                             "plant", 
                                             ifelse(source_group == "fish_seafood", 
                                                    "fish", NA))))

feed_tmp <- food_feed_proj_diff %>% 
  dplyr::filter(crop_class == "feed") %>% 
  dplyr::mutate(source_group = ifelse(source_group == "animal_products", 
                                      "animal", 
                                      ifelse(source_group == "plant_products", 
                                             "plant", 
                                             ifelse(source_group == "fish_seafood", 
                                                    "fish", NA))))

p1_food <- ggplot(
  data = food_tmp %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)),
  mapping = aes(x = diet_plan_f,
                y = t_yr_diff * 1e-9)
) +
  geom_col(
    aes(alpha = scenario),
    position = "dodge",
    fill = scales::muted("green"),
    colour = "black",
    size = 0.1
  ) +
  geom_hline(yintercept = 0, alpha = 0.9) +
  scale_fill_manual(labels = labz) +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    axis.text.x = element_text(
      angle = 90,
      hjust = 0.9,
      vjust = 0.5,
      size = 12
    ),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    strip.text = element_text(size = 11)
  ) +
  labs(title = "Food for humans (absolute change)",
       y = "Gt/year above 2018 supply") +
  facet_grid(source_group ~ year, 
             scales = "free_y") 

p1_food_legend <- cowplot::get_legend(p1_food)
p1_food <- p1_food +
  theme(legend.position = "none")

p1_feed <- ggplot(
  data = feed_tmp %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)),
  mapping = aes(x = diet_plan_f,
                y = t_yr_diff * 1e-9)
) +
  geom_col(
    aes(alpha = scenario),
    position = "dodge",
    fill = scales::muted("magenta"),
    colour = "black",
    size = 0.1
  ) +
  geom_hline(yintercept = 0, alpha = 0.9) +
  scale_fill_manual(labels = labz) +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    axis.text.x = element_text(
      angle = 90,
      hjust = 0.9,
      vjust = 0.5,
      size = 12
    ),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    strip.text = element_text(size = 11)
  ) +
  labs(title = "Feed for animals (absolute change)",
       y = "Gt/year above 2018 supply") +
  facet_grid(source_group ~ year, 
             scales = "free_y") 

p1_feed_legend <- cowplot::get_legend(p1_feed)
p1_feed <- p1_feed +
  theme(legend.position = "none")

p1_food_pc <- ggplot(
  data = food_tmp %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)),
  mapping = aes(x = diet_plan_f,
                y = pc_diff)
) +
  geom_col(
    aes(alpha = scenario),
    position = "dodge",
    fill = scales::muted("green"),
    colour = "black",
    size = 0.1
  ) +
  geom_hline(yintercept = 0, alpha = 0.9) +
  scale_fill_manual(labels = labz) +
  theme_bw() +
  theme(
    legend.position = "none",
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    axis.text.x = element_text(
      angle = 90,
      hjust = 0.9,
      vjust = 0.5,
      size = 12
    ),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    strip.text = element_text(size = 11)
  ) +
  labs(title = "Food for humans (relative change)",
       y = "Relative change from 2018") +
  facet_grid(source_group ~ year, 
             scales = "free_y") + 
  scale_y_continuous(labels = scales::percent)

p1_feed_pc <- ggplot(
  data = feed_tmp %>%
    dplyr::filter(year %in% c(2025, 2050, 2075)),
  mapping = aes(x = diet_plan_f,
                y = pc_diff)
) +
  geom_col(
    aes(alpha = scenario),
    position = "dodge",
    fill = scales::muted("magenta"),
    colour = "black",
    size = 0.1
  ) +
  geom_hline(yintercept = 0, alpha = 0.9) +
  scale_fill_manual(labels = labz) +
  theme_bw() +
  theme(
    legend.position = "none",
    legend.title = element_blank(),
    legend.text = element_text(size = 11),
    axis.text.x = element_text(
      angle = 90,
      hjust = 0.9,
      vjust = 0.5,
      size = 12
    ),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    strip.text = element_text(size = 11)
  ) +
  labs(title = "Feed for animals (relative change)",
       y = "Relative change from 2018") +
  facet_grid(source_group ~ year, 
             scales = "free_y") + 
  scale_y_continuous(labels = scales::percent)

```

Save this to disk.

```{r}
pa <- cowplot::plot_grid(p1_food, p1_feed, ncol = 1, align = "v")
pb <- cowplot::plot_grid(p1_food_legend, p1_feed_legend, ncol = 1, align = "v")
pc <- cowplot::plot_grid(p1_food_pc, p1_feed_pc, ncol = 1, align = "v")

cowplot::plot_grid(pa, pb, pc, ncol = 3, rel_widths = c(0.44, 0.1, 0.46), align = "v")

grDevices::jpeg(filename = "Plots/figure_5.jpg", 
               width = 750, 
               height = 500, 
               units = "px", 
               quality = 1)
cowplot::plot_grid(pa, pb, pc, ncol = 3, rel_widths = c(0.44, 0.1, 0.46), align = "v")
dev.off()

```


```{r}
food_feed_proj_diff %>% 
  dplyr::filter(year == 2075 & source_group == "fish_seafood" & diet_plan == "USDA" & crop_class == "food")
```



```{r}
food_feed_proj_diff %>% 
  dplyr::filter(year %in% c(2050)) %>% 
  dplyr::group_by(year, crop_class, source_group) %>% 
  dplyr::summarise(Gt_diff_max = max(t_yr_diff)*1e-9, 
                   Gt_diff_min = min(t_yr_diff)*1e-9, 
                   pc_diff_max = max(pc_diff), 
                   pc_diff_min = min(pc_diff), 
                   .groups = "drop")
```
Example.

```{r}
food_feed_proj_diff %>% 
  dplyr::filter(year == 2075) %>% 
  dplyr::filter(crop_class == "feed" & source_group == "fish_seafood" & diet_plan == "ELA")
```

Historic (FAO) food/feed supply for 2018.
```{r}
# diet_diffs
fao_food_feed_supply <- food_feed_grouped_data %>% 
  dplyr::filter(year == 2018) %>% 
  dplyr::group_by(crop_class) %>% 
  dplyr::summarise(t_yr_2018 = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop")

ssp_food_feed_demand <- global_crop_demand_food_feed_diff %>%
  dplyr::group_by(SCENARIO, year, diet_plan, crop_class) %>%
  dplyr::summarise(t_yr = sum(tonnes_yr, na.rm = TRUE),
                   .groups = "drop") %>%
  dplyr::mutate(scenario = ifelse(
    SCENARIO == "SSP1_v9_130115",
    "SSP1",
    ifelse(
      SCENARIO == "SSP2_v9_130115",
      "SSP2",
      ifelse(
        SCENARIO == "SSP3_v9_130115",
        "SSP3",
        ifelse(
          SCENARIO == "SSP4d_v9_130115",
          "SSP4",
          ifelse(SCENARIO == "SSP5_v9_130115",
                 "SSP5",
                 NA)
        )
      )
    )
  )) %>%
  dplyr::mutate(diet_plan = ifelse(
    diet_plan == "ELA-PHD",
    "ELA",
    ifelse(
      diet_plan == "CNS-CFP",
      "CNS",
      ifelse(diet_plan == "FDA-SDP",
             "USDA", 
             NA)
    )
  )) %>%
  dplyr::select(-SCENARIO)
```

```{r}
ssp_food_feed_demand$diet_plan_f <- factor(ssp_food_feed_demand$diet_plan, levels = c("ELA", "CNS", "USDA"))
```

# Pathways Analysis

Organize data for pathways analysis.

```{r}
food_proj_2020_2100 <- food_weight %>% 
  dplyr::filter(iso_alpha3 %in% iso_list_harmonized) %>% 
  dplyr::mutate(tonnes_yr = tonnes_day_food * 365) %>%
  dplyr::select(SCENARIO,
                iso_alpha3,
                subregionname,
                diet_plan,
                year,
                model_group,
                tonnes_yr) %>%
  dplyr::bind_rows(
    live_food_weight %>% 
  dplyr::filter(iso_alpha3 %in% iso_list_harmonized) %>%
      dplyr::mutate(tonnes_yr = tonnes_day_food * 365) %>%
      dplyr::select(
        SCENARIO,
        iso_alpha3,
        subregionname,
        diet_plan,
        year,
        model_group,
        tonnes_yr
      )
  ) %>%
  dplyr::mutate(scenario = ifelse(
    SCENARIO == "SSP1_v9_130115",
    "SSP1",
    ifelse(
      SCENARIO == "SSP2_v9_130115",
      "SSP2",
      ifelse(
        SCENARIO == "SSP3_v9_130115",
        "SSP3",
        ifelse(SCENARIO == "SSP4d_v9_130115",
               "SSP4",
               "SSP5")
      )
    )
  )) %>% 
  dplyr::select(-SCENARIO) %>% 
  dplyr::filter(year >= 2020)

feed_proj_2020_2100 <- feed_ingredient_demand_summary %>% 
  dplyr::filter(iso_alpha3 %in% iso_list_harmonized) %>% 
  dplyr::mutate(tonnes_yr = tonnes_day*365) %>% 
  dplyr::select(-tonnes_day) %>%
  dplyr::mutate(scenario = ifelse(
    SCENARIO == "SSP1_v9_130115",
    "SSP1",
    ifelse(
      SCENARIO == "SSP2_v9_130115",
      "SSP2",
      ifelse(
        SCENARIO == "SSP3_v9_130115",
        "SSP3",
        ifelse(SCENARIO == "SSP4d_v9_130115",
               "SSP4",
               "SSP5")
      )
    )
  )) %>% 
  dplyr::select(-SCENARIO) %>% 
  dplyr::filter(year >= 2020)

```



```{r}
future_food_feed_demand_diff <- ssp_food_feed_demand %>% 
  dplyr::left_join(fao_food_feed_supply) %>% 
  dplyr::mutate(t_yr_diff = t_yr-t_yr_2018) %>% 
  dplyr::mutate(pc_diff = t_yr_diff/t_yr_2018) %>% 
  dplyr::ungroup()
```


```{r}
cols <- data.frame(
  food = scales::muted("green"), 
  feed = scales::muted("magenta")
)
labz <- c("food for humans", "feed for animals")

p_food_feed <- ggplot(data = future_food_feed_demand_diff %>% 
         dplyr::filter(year >= 2020), 
       mapping = aes(x = year, 
                     y = t_yr_diff*1e-9)) + 
  geom_hline(yintercept = 0, alpha = 0.9) + 
  geom_area(aes(fill = crop_class), 
            position = "stack", 
            alpha = 0.7) + 
  scale_fill_manual(values = cols, 
                    labels = labz) + 
  theme_bw() + 
  theme(
    legend.position = "top", 
    legend.title = element_blank(), 
    legend.text = element_text(size = 12), 
    axis.text.x = element_text(angle = 90, hjust = 0.9, vjust = 0.5, size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.y = element_text(size = 12), 
    axis.title.x = element_blank(), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    strip.text = element_text(size = 14)
  ) + 
  labs(
    title = "Projected absolute increase in global food & feed demand", 
    y = "Gt/year above 2018 supply"
  ) + 
  facet_grid(diet_plan_f ~ scenario)
# + 
#   scale_x_binned(breaks = seq(2020, 2100, by = 20), 
#                  labels = seq(2020, 2100, by = 20))

p_pc_food_feed <- ggplot(data = future_food_feed_demand_diff %>% 
         dplyr::filter(year >= 2020), 
       mapping = aes(x = year, 
                     y = pc_diff)) + 
  geom_hline(yintercept = 0, alpha = 0.9) + 
  geom_area(aes(fill = crop_class), 
            position = "stack", 
            alpha = 0.7) + 
  scale_fill_manual(values = cols, 
                    labels = labz) + 
  theme_bw() + 
  theme(
    legend.position = "top", 
    legend.title = element_blank(), 
    legend.text = element_text(size = 12), 
    axis.text.x = element_text(angle = 90, hjust = 0.9, vjust = 0.5, size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.y = element_text(size = 12), 
    axis.title.x = element_blank(), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    strip.text = element_text(size = 14)
  ) + 
  labs(
    title = "Projected relative in global food & feed demand", 
    y = "Relative change from 2018 supply"
  ) + 
  facet_grid(diet_plan_f ~ scenario) + 
  scale_y_continuous(labels = scales::percent)

```


```{r}
grDevices::jpeg(filename = "Plots/figure_S4a.jpg", 
               width = 750, 
               height = 500, 
               units = "px", 
               quality = 1)
cowplot::plot_grid(p_food_feed, p_pc_food_feed, ncol = 2, rel_widths = c(0.48,0.52))
dev.off()
p_food_feed
```


<!-- # ```{r, warning=FALSE} -->
<!-- #  -->
<!-- # p1_food <- ggplot( -->
<!-- #   data = future_food_feed_demand_diff %>% -->
<!-- #     dplyr::filter(crop_class == "food") %>% -->
<!-- #     dplyr::filter(year %in% c(2025, 2050, 2075)), -->
<!-- #   mapping = aes(x = diet_plan_f, -->
<!-- #                 y = t_yr_diff * 1e-9) -->
<!-- # ) + -->
<!-- #   geom_col( -->
<!-- #     aes(alpha = scenario), -->
<!-- #     position = "dodge", -->
<!-- #     fill = scales::muted("green"), -->
<!-- #     colour = "black", -->
<!-- #     size = 0.1 -->
<!-- #   ) + -->
<!-- #   geom_hline(yintercept = 0, alpha = 0.9) + -->
<!-- #   scale_fill_manual(labels = labz) + -->
<!-- #   theme_bw() + -->
<!-- #   theme( -->
<!-- #     legend.title = element_blank(), -->
<!-- #     legend.text = element_text(size = 12), -->
<!-- #     axis.text.x = element_text( -->
<!-- #       angle = 90, -->
<!-- #       hjust = 0.9, -->
<!-- #       vjust = 0.5, -->
<!-- #       size = 12 -->
<!-- #     ), -->
<!-- #     axis.text.y = element_text(size = 12), -->
<!-- #     axis.title.y = element_text(size = 12), -->
<!-- #     axis.title.x = element_blank(), -->
<!-- #     panel.grid.major.x = element_blank(), -->
<!-- #     panel.grid.minor.x = element_blank(), -->
<!-- #     strip.text = element_text(size = 14) -->
<!-- #   ) + -->
<!-- #   labs(title = "Food for humans (absolute change)", -->
<!-- #        y = "Gt/year above 2018 supply") + -->
<!-- #   facet_grid( ~ year) + -->
<!-- #   coord_cartesian(ylim = c(min(out$min_diff), max(out$max_diff))) -->
<!-- #  -->
<!-- # p1_food_legend <- cowplot::get_legend(p1_food) -->
<!-- # p1_food <- p1_food + -->
<!-- #   theme(legend.position = "none") -->
<!-- #  -->
<!-- # p1_feed <- ggplot( -->
<!-- #   data = future_food_feed_demand_diff %>% -->
<!-- #     dplyr::filter(crop_class == "feed") %>% -->
<!-- #     dplyr::filter(year %in% c(2025, 2050, 2075)), -->
<!-- #   mapping = aes(x = diet_plan_f, -->
<!-- #                 y = t_yr_diff * 1e-9) -->
<!-- # ) + -->
<!-- #   geom_col( -->
<!-- #     aes(alpha = scenario), -->
<!-- #     position = "dodge", -->
<!-- #     fill = scales::muted("magenta"), -->
<!-- #     colour = "black", -->
<!-- #     size = 0.1 -->
<!-- #   ) + -->
<!-- #   geom_hline(yintercept = 0, alpha = 0.9) + -->
<!-- #   scale_fill_manual(labels = labz) + -->
<!-- #   theme_bw() + -->
<!-- #   theme( -->
<!-- #     legend.title = element_blank(), -->
<!-- #     legend.text = element_text(size = 12), -->
<!-- #     axis.text.x = element_text( -->
<!-- #       angle = 90, -->
<!-- #       hjust = 0.9, -->
<!-- #       vjust = 0.5, -->
<!-- #       size = 12 -->
<!-- #     ), -->
<!-- #     axis.text.y = element_text(size = 12), -->
<!-- #     axis.title.y = element_text(size = 12), -->
<!-- #     axis.title.x = element_blank(), -->
<!-- #     panel.grid.major.x = element_blank(), -->
<!-- #     panel.grid.minor.x = element_blank(), -->
<!-- #     strip.text = element_text(size = 14) -->
<!-- #   ) + -->
<!-- #   labs(title = "Feed for animals (absolute change)", -->
<!-- #        y = "Gt/year above 2018 supply") + -->
<!-- #   facet_grid( ~ year) + -->
<!-- #   coord_cartesian(ylim = c(min(out$min_diff), max(out$max_diff))) -->
<!-- #  -->
<!-- # p1_feed_legend <- cowplot::get_legend(p1_feed) -->
<!-- # p1_feed <- p1_feed + -->
<!-- #   theme(legend.position = "none") -->
<!-- #  -->
<!-- # p1_food_pc <- ggplot( -->
<!-- #   data = future_food_feed_demand_diff %>% -->
<!-- #     dplyr::filter(crop_class == "food") %>% -->
<!-- #     dplyr::filter(year %in% c(2025, 2050, 2075)), -->
<!-- #   mapping = aes(x = diet_plan_f, -->
<!-- #                 y = pc_diff) -->
<!-- # ) + -->
<!-- #   geom_col( -->
<!-- #     aes(alpha = scenario), -->
<!-- #     position = "dodge", -->
<!-- #     fill = scales::muted("green"), -->
<!-- #     colour = "black", -->
<!-- #     size = 0.1 -->
<!-- #   ) + -->
<!-- #   geom_hline(yintercept = 0, alpha = 0.9) + -->
<!-- #   scale_fill_manual(labels = labz) + -->
<!-- #   theme_bw() + -->
<!-- #   theme( -->
<!-- #     legend.position = "none", -->
<!-- #     legend.title = element_blank(), -->
<!-- #     legend.text = element_text(size = 12), -->
<!-- #     axis.text.x = element_text( -->
<!-- #       angle = 90, -->
<!-- #       hjust = 0.9, -->
<!-- #       vjust = 0.5, -->
<!-- #       size = 12 -->
<!-- #     ), -->
<!-- #     axis.text.y = element_text(size = 12), -->
<!-- #     axis.title.y = element_text(size = 12), -->
<!-- #     axis.title.x = element_blank(), -->
<!-- #     panel.grid.major.x = element_blank(), -->
<!-- #     panel.grid.minor.x = element_blank(), -->
<!-- #     strip.text = element_text(size = 14) -->
<!-- #   ) + -->
<!-- #   labs(title = "Food for humans (relative change)", -->
<!-- #        y = "Relative change from 2018") + -->
<!-- #   facet_grid( ~ year) + -->
<!-- #   coord_cartesian(ylim = c(min(out$min_pc_diff), max(out$max_pc_diff))) +  -->
<!-- #   scale_y_continuous(labels = scales::percent) -->
<!-- #  -->
<!-- # p1_feed_pc <- ggplot( -->
<!-- #   data = future_food_feed_demand_diff %>% -->
<!-- #     dplyr::filter(crop_class == "feed") %>% -->
<!-- #     dplyr::filter(year %in% c(2025, 2050, 2075)), -->
<!-- #   mapping = aes(x = diet_plan_f, -->
<!-- #                 y = pc_diff) -->
<!-- # ) + -->
<!-- #   geom_col( -->
<!-- #     aes(alpha = scenario), -->
<!-- #     position = "dodge", -->
<!-- #     fill = scales::muted("magenta"), -->
<!-- #     colour = "black", -->
<!-- #     size = 0.1 -->
<!-- #   ) + -->
<!-- #   geom_hline(yintercept = 0, alpha = 0.9) + -->
<!-- #   scale_fill_manual(labels = labz) + -->
<!-- #   theme_bw() + -->
<!-- #   theme( -->
<!-- #     legend.position = "none", -->
<!-- #     legend.title = element_blank(), -->
<!-- #     legend.text = element_text(size = 12), -->
<!-- #     axis.text.x = element_text( -->
<!-- #       angle = 90, -->
<!-- #       hjust = 0.9, -->
<!-- #       vjust = 0.5, -->
<!-- #       size = 12 -->
<!-- #     ), -->
<!-- #     axis.text.y = element_text(size = 12), -->
<!-- #     axis.title.y = element_text(size = 12), -->
<!-- #     axis.title.x = element_blank(), -->
<!-- #     panel.grid.major.x = element_blank(), -->
<!-- #     panel.grid.minor.x = element_blank(), -->
<!-- #     strip.text = element_text(size = 14) -->
<!-- #   ) + -->
<!-- #   labs(title = "Feed for animals (relative change)", -->
<!-- #        y = "Relative change from 2018") + -->
<!-- #   facet_grid( ~ year) + -->
<!-- #   coord_cartesian(ylim = c(min(out$min_pc_diff), max(out$max_pc_diff))) +  -->
<!-- #   scale_y_continuous(labels = scales::percent) -->
<!-- #  -->
<!-- # ``` -->
<!-- #  -->
<!-- #  -->
<!-- # ```{r} -->
<!-- # pa <- cowplot::plot_grid(p1_food, p1_feed, ncol = 1) -->
<!-- # pb <- cowplot::plot_grid(p1_food_legend, p1_feed_legend, ncol = 1) -->
<!-- # pc <- cowplot::plot_grid(p1_food_pc, p1_feed_pc, ncol = 1) -->
<!-- #  -->
<!-- # cowplot::plot_grid(pa, pb, pc, ncol = 3, rel_widths = c(0.44, 0.1, 0.46)) -->
<!-- #  -->
<!-- # grDevices::jpeg(filename = "Plots/figure_4.jpg",  -->
<!-- #                width = 750,  -->
<!-- #                height = 500,  -->
<!-- #                units = "px",  -->
<!-- #                quality = 1) -->
<!-- # cowplot::plot_grid(pa, pb, pc, ncol = 3, rel_widths = c(0.44, 0.1, 0.46)) -->
<!-- # dev.off() -->
<!-- #  -->
<!-- # ``` -->


<!-- Read maxima and minima for these explicitly. -->
<!-- ```{r} -->
<!-- tmp <- future_food_feed_demand_diff %>% -->
<!--   dplyr::group_by(scenario, year, diet_plan) %>% -->
<!--   dplyr::summarise(t_yr_diff = sum(t_yr_diff, na.rm = TRUE), -->
<!--                    .groups = "drop") -->

<!-- tmp1 <- tmp %>% -->
<!--   dplyr::filter(year == 2050) %>% -->
<!--   dplyr::pull(t_yr_diff) %>% -->
<!--   max(.) * 1e-9 -->

<!-- tmp2 <- tmp %>% -->
<!--   dplyr::filter(year == 2050) %>% -->
<!--   dplyr::pull(t_yr_diff) %>% -->
<!--   min(.) * 1e-9 -->

<!-- tmp3 <- tmp %>% -->
<!--   dplyr::filter(year == 2075) %>% -->
<!--   dplyr::pull(t_yr_diff) %>% -->
<!--   max(.) * 1e-9 -->

<!-- tmp4 <- tmp %>% -->
<!--   dplyr::filter(year == 2075) %>% -->
<!--   dplyr::pull(t_yr_diff) %>% -->
<!--   min(.) * 1e-9 -->

<!-- out <- tibble( -->
<!--   value_diff = c("max","min","max","min"), -->
<!--   year = c(2050,2050,2075,2075),  -->
<!--   t_yr_diff = c(tmp1,tmp2,tmp3,tmp4) -->
<!-- ) -->
<!-- out -->
<!-- ``` -->

Test this. Find differences between the projected demand and FAO supply.
```{r}
tmp1 <- food_feed_grouped_data %>% 
  dplyr::group_by(area, year, crop_class) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(SCENARIO = "FAO", 
                diet_plan_f = factor("FAO")) %>% 
  dplyr::select(SCENARIO, year, diet_plan_f, crop_class, tonnes_yr)
tmp2 <- global_crop_demand_food_feed_diff %>% 
  dplyr::select(SCENARIO, year, diet_plan_f, crop_class, tonnes_yr) %>% 
  dplyr::filter(year >= 2020)

tmp3 <- full_join(tmp1, tmp2)

diet_diffs <- tmp3 %>% 
  dplyr::mutate(tonnes_yr_2018 = ifelse(year == 2018, tonnes_yr, NA)) %>% 
  dplyr::group_by(crop_class) %>% 
  tidyr::fill(tonnes_yr_2018, 
              .direction = "updown") %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(year >= 2018) %>% 
  dplyr::mutate(diff = tonnes_yr - tonnes_yr_2018, 
                pc_diff = diff/tonnes_yr_2018)
```


<!-- ```{r} -->
<!-- cols <- data.frame( -->
<!--   food = "#EEAF35",  -->
<!--   feed = "#F17EB8" -->
<!-- ) -->
<!-- labz <- c("food", "feed") -->

<!-- # ymax <- (max(global_crop_demand_food_feed_diff$diff) + 0.05 * max(global_crop_demand_food_feed_diff$diff)) * 1e-9 -->
<!-- # ymin <- 0 -->

<!-- ymax <- 0.9 -->
<!-- ymin <- -0.55  -->


<!-- p2a <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP1_v9_130115"), -->
<!--   aes(x = diet_plan_f, -->
<!--       y = pc_diff) -->
<!-- ) +  -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   #  scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() +  -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.title = element_blank(),  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_text(size = 7) -->
<!--   ) + -->
<!--   labs(title = "SSP1", y = "Relative to 2018 demand") + -->
<!--   facet_wrap( ~ year) -->

<!-- labz <- c("food", "feed") -->
<!-- p2_legend_only <- cowplot::get_legend(p2a) -->

<!-- p2a <- p2a + -->
<!--   theme(legend.position = "none") -->

<!-- p2b <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP2_v9_130115"), -->
<!--    aes(x = diet_plan_f, -->
<!--       y = pc_diff) -->
<!-- ) + -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   # scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.position = "none",  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_blank() -->
<!--   ) + -->
<!--   labs(title = "SSP2") + -->
<!--   facet_wrap( ~ year) -->

<!-- p2c <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP3_v9_130115"), -->
<!--   aes(x = diet_plan_f, -->
<!--       y = pc_diff) -->
<!-- ) + -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   # scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.position = "none",  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_blank() -->
<!--   ) + -->
<!--   labs(title = "SSP3") + -->
<!--   facet_wrap( ~ year) -->

<!-- p2d <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP4d_v9_130115"), -->
<!--   aes(x = diet_plan_f, -->
<!--       y = pc_diff) -->
<!-- ) + -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   # scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.position = "none",  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_blank() -->
<!--   ) + -->
<!--   labs(title = "SSP4") + -->
<!--   facet_wrap( ~ year) -->

<!-- p2e <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP5_v9_130115"), -->
<!--   aes(x = diet_plan_f, -->
<!--       y = pc_diff) -->
<!-- ) + -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   # scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() +  -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.position = "none",  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_text(size = 7) -->
<!--   ) + -->
<!--   labs(title = "SSP5", y = "Relative to 2018 demand") + -->
<!--   facet_wrap( ~ year) -->
<!-- ``` -->



<!-- ```{r} -->
<!-- cols <- data.frame( -->
<!--   food = "#EEAF35",  -->
<!--   feed = "#F17EB8" -->
<!-- ) -->
<!-- labz <- c("food", "feed") -->

<!-- diets <- c("ELA", "CNS", "USDA") -->

<!-- # ymax <- (max(global_crop_demand_food_feed_diff$diff) + 0.05 * max(global_crop_demand_food_feed_diff$diff)) * 1e-9 -->
<!-- # ymin <- 0 -->

<!-- ymax <- 3.5 -->
<!-- ymin <- -3  -->


<!-- p3a <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP1_v9_130115"), -->
<!--   aes(x = diet_plan_f, -->
<!--       y = diff * 1e-9) -->
<!-- ) +  -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   scale_x_discrete(labels = diets) +  -->
<!--   #  scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() +  -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5,  -->
<!--       size = 7 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.title = element_blank(),  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_text(size = 7) -->
<!--   ) + -->
<!--   labs(title = "SSP1", y = "Gt over 2018 demand") + -->
<!--   facet_wrap( ~ year) -->

<!-- p3_legend_only <- cowplot::get_legend(p3a) -->

<!-- p3a <- p3a + -->
<!--   theme(legend.position = "none") -->

<!-- p3b <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP2_v9_130115"), -->
<!--    aes(x = diet_plan_f, -->
<!--       y = diff * 1e-9) -->
<!-- ) + -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   scale_x_discrete(labels = diets) +  -->
<!--   # scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5,  -->
<!--       size = 7 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.position = "none",  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_blank() -->
<!--   ) + -->
<!--   labs(title = "SSP2") + -->
<!--   facet_wrap( ~ year) -->

<!-- p3c <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP3_v9_130115"), -->
<!--   aes(x = diet_plan_f, -->
<!--       y = diff * 1e-9) -->
<!-- ) + -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   scale_x_discrete(labels = diets) +  -->
<!--   # scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5,  -->
<!--       size = 7 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.position = "none",  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_blank() -->
<!--   ) + -->
<!--   labs(title = "SSP3") + -->
<!--   facet_wrap( ~ year) -->

<!-- p3d <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP4d_v9_130115"), -->
<!--   aes(x = diet_plan_f, -->
<!--       y = diff * 1e-9) -->
<!-- ) + -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   scale_x_discrete(labels = diets) +  -->
<!--   # scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5,  -->
<!--       size = 7 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.position = "none",  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_blank() -->
<!--   ) + -->
<!--   labs(title = "SSP4") + -->
<!--   facet_wrap( ~ year) -->

<!-- p3e <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP5_v9_130115"), -->
<!--   aes(x = diet_plan_f, -->
<!--       y = diff * 1e-9) -->
<!-- ) + -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   scale_x_discrete(labels = diets) +  -->
<!--   # scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() +  -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5,  -->
<!--       size = 7 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.position = "none",  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_text(size = 7) -->
<!--   ) + -->
<!--   labs(title = "SSP5", y = "Gt over 2018 demand") + -->
<!--   facet_wrap( ~ year) -->
<!-- ``` -->

<!-- ```{r} -->

<!-- pa <- plot_grid(p3e, p3a, ncol = 1) -->
<!-- pb <- plot_grid(p3_legend_only, p3b, NA, ncol = 1, rel_heights = c(0.5, 1, 0.5)) -->
<!-- pc <- plot_grid(p3c, p3d, ncol = 1) -->

<!-- p3 <- cowplot::plot_grid(pa, pb, pc, ncol = 3) -->

<!-- grDevices::jpeg(filename = "Plots/figure_S4a.jpg",  -->
<!--                width = 750,  -->
<!--                height = 500,  -->
<!--                units = "px",  -->
<!--                quality = 1) -->
<!-- cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_widths = c(0.1, 0.9), rel_heights = c(0.9, 0.1)) -->

<!-- dev.off() -->

<!-- # p3 <- cowplot::plot_grid(p3a, p3b, p3c, p3d, p3e, p3_legend_only) -->
<!-- # p3 -->

<!-- ``` -->

<!-- ```{r} -->
<!-- out <- diet_diffs %>%  -->
<!--   dplyr::filter(!SCENARIO %in% "FAO") %>%  -->
<!--   dplyr::group_by(year, crop_class) %>%  -->
<!--   dplyr::summarise(max_diff = max(diff) * 1e-9,  -->
<!--                 min_diff = min(diff) * 1e-9,  -->
<!--                 max_pc_diff = max(pc_diff),  -->
<!--                 min_pc_diff = min(pc_diff),  -->
<!--                 .groups = "drop") %>%  -->
<!--   dplyr::mutate(across(.cols = max_diff:min_pc_diff, ~ round(.x,2))) %>%  -->
<!--   dplyr::filter(year %in% c(2025, 2050, 2075)) -->
<!-- out -->
<!-- ``` -->


<!-- Relative change. -->

<!-- ```{r} -->
<!-- ymax <- 0.9 -->
<!-- ymin <- -0.6 -->


<!-- p4a <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP1_v9_130115"), -->
<!--   aes(x = diet_plan_f, -->
<!--       y = pc_diff) -->
<!-- ) +  -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   scale_x_discrete(labels = diets) +  -->
<!--   #  scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() +  -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5,  -->
<!--       size = 7 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.title = element_blank(),  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_text(size = 7) -->
<!--   ) + -->
<!--   labs(title = "SSP1", y = "Change over 2018 supply") + -->
<!--   facet_wrap( ~ year) -->

<!-- p4_legend_only <- cowplot::get_legend(p4a) -->

<!-- p4a <- p4a + -->
<!--   theme(legend.position = "none") -->

<!-- p4b <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP2_v9_130115"), -->
<!--    aes(x = diet_plan_f, -->
<!--       y = pc_diff) -->
<!-- ) + -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   scale_x_discrete(labels = diets) +  -->
<!--   # scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5,  -->
<!--       size = 7 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.position = "none",  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_blank() -->
<!--   ) + -->
<!--   labs(title = "SSP2") + -->
<!--   facet_wrap( ~ year) -->

<!-- p4c <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP3_v9_130115"), -->
<!--   aes(x = diet_plan_f, -->
<!--       y = pc_diff) -->
<!-- ) + -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   scale_x_discrete(labels = diets) +  -->
<!--   # scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5,  -->
<!--       size = 7 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.position = "none",  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_blank() -->
<!--   ) + -->
<!--   labs(title = "SSP3") + -->
<!--   facet_wrap( ~ year) -->

<!-- p4d <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP4d_v9_130115"), -->
<!--   aes(x = diet_plan_f, -->
<!--       y = pc_diff) -->
<!-- ) + -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   scale_x_discrete(labels = diets) +  -->
<!--   # scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5,  -->
<!--       size = 7 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.position = "none",  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_blank() -->
<!--   ) + -->
<!--   labs(title = "SSP4") + -->
<!--   facet_wrap( ~ year) -->

<!-- p4e <- ggplot( -->
<!--   diet_diffs %>% -->
<!--     dplyr::filter(year %in% c(2025, 2050, 2075) & -->
<!--                     SCENARIO == "SSP5_v9_130115"), -->
<!--   aes(x = diet_plan_f, -->
<!--       y = pc_diff) -->
<!-- ) + -->
<!--   geom_hline(yintercept = 0, alpha = 0.8) + -->
<!--   geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") +  -->
<!--   scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) +  -->
<!--   scale_x_discrete(labels = diets) +  -->
<!--   # scale_fill_manual( -->
<!--   #   values = cols, -->
<!--   #   labels = labz -->
<!--   # ) +  -->
<!--   scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +  -->
<!--   coord_cartesian(ylim = c(ymin, ymax)) + -->
<!--   theme_bw() +  -->
<!--   theme( -->
<!--     axis.text.x = element_text( -->
<!--       angle = 90, -->
<!--       hjust = 0, -->
<!--       vjust = 0.5,  -->
<!--       size = 7 -->
<!--     ), -->
<!--     axis.ticks.x = element_blank(), -->
<!--     axis.title.x = element_blank(), -->
<!--     legend.position = "none",  -->
<!--     panel.grid.major.y = element_line(colour = "grey"),  -->
<!--     panel.grid.minor.y = element_line(colour = "grey"),  -->
<!--     panel.grid.major.x = element_blank(),  -->
<!--     panel.grid.minor.x = element_blank(),  -->
<!--     axis.title.y = element_text(size = 7) -->
<!--   ) + -->
<!--   labs(title = "SSP5", y = "Change over 2018 supply") + -->
<!--   facet_wrap( ~ year) -->

<!-- ``` -->

<!-- ```{r} -->

<!-- pa <- plot_grid(p4e, p4a, ncol = 1) -->
<!-- pb <- plot_grid(p4_legend_only, p4b, NA, ncol = 1, rel_heights = c(0.5, 1, 0.5)) -->
<!-- pc <- plot_grid(p4c, p4d, ncol = 1) -->

<!-- p3 <- cowplot::plot_grid(pa, pb, pc, ncol = 3) -->
<!-- cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_widths = c(0.1, 0.9), rel_heights = c(0.9, 0.1)) -->

<!-- grDevices::jpeg(filename = "Plots/figure_S4b.jpg",  -->
<!--                width = 750,  -->
<!--                height = 500,  -->
<!--                units = "px",  -->
<!--                quality = 1) -->
<!-- cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_widths = c(0.1, 0.9), rel_heights = c(0.9, 0.1)) -->
<!-- dev.off() -->

<!-- # p3 <- cowplot::plot_grid(p3a, p3b, p3c, p3d, p3e, p3_legend_only) -->
<!-- # p3 -->
<!-- ``` -->






Return to the projections computed earlier. Recall: the projections were based on a bottom-up calculation of food and feed weight based on caloric demands for healthy diets, under the five SSPs and three diet plans.

Merge the data with the projections computed earlier.

```{r}
food_feed_data_scenario <- food_feed_grouped_data %>% 
  dplyr::mutate(SCENARIO = "FAOSTAT", 
                diet_plan = "FAO-FBdata") %>% 
  dplyr::group_by(SCENARIO, diet_plan, year, crop_class) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::bind_rows(
    global_crop_demand_food_feed %>%
  dplyr::select(-tonnes_day)
  )

```

To test the skill of the bottom-up calculation, compare to the food balance data. I run a short check of the data with a visualisation below.

```{r}
compare <- global_crop_demand_food_feed %>% 
  dplyr::select(-tonnes_day) %>% 
  dplyr::bind_rows(food_grouped_data %>% 
  group_by(year) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(diet_plan = "FAO-FB", 
                crop_class = "food", 
                SCENARIO = "FAO_FoodBalance_data") %>% 
  dplyr::select(SCENARIO, diet_plan, year, crop_class, tonnes_yr))


```



```{r}

p2 <- ggplot(data = food_feed_data_scenario %>% 
         dplyr::filter(SCENARIO != "FAOSTAT", 
                       crop_class == "food"), 
       aes(x = year, 
           y = tonnes_yr)) + 
  geom_line(aes(colour = diet_plan)) + 
  geom_point(data = food_feed_data_scenario %>% 
         dplyr::filter(SCENARIO == "FAOSTAT", 
                       crop_class == "food") %>% 
           dplyr::select(-SCENARIO), 
         aes(x = year, 
             y = tonnes_yr), 
         size = 0.5, 
         shape = 3) + 
  facet_wrap(~SCENARIO)

p2

```

Shift diets by 2050 and by 2075, for each SSP.

Shift by 2050. Interpolate lowest acceleration pathway for each food/feed type to its target value.

1.  Linearly extrapolate data values from 2014-18 to 2022.
2.  Find the lowest-energy trajectory from 2022 to the target year, 2050 or 2075. The lowest energy should have the constraints: (i) lowest second derivative wrt time; (ii) first derivative that equals the slope of the line at 2022; (iii) passes through the appropriate values at 2022 and 2050. A spline should be appropriate.

Recode country names and merge with regions.

```{r}
Food_countries <- food_countries %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::select(-area) %>% 
  dplyr::left_join(loc_map_reduced, by = "fao_countrycode") %>% 
  dplyr::filter(iso_alpha3 %in% iso_list_harmonized) # also include only those countries represented across data sets

Feed_countries <- feed_countries %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::select(-area) %>% 
  dplyr::left_join(loc_map_reduced, by = "fao_countrycode") %>% 
  dplyr::filter(iso_alpha3 %in% iso_list_harmonized)
```

Do some cleanup first because some ISOa3 codes are not included.

```{r}
food_2014_2018_data <- Food_countries %>% 
  dplyr::filter(year >= 2014 & year <= 2018) %>% 
  dplyr::select(year, model_group, tonnes_yr, iso_alpha3) %>%
  tidyr::drop_na()

feed_2014_2018_data <- Feed_countries %>% 
  dplyr::filter(year >= 2014 & year <= 2018) %>%
  dplyr::select(year, model_group, tonnes_yr, iso_alpha3) %>%
  tidyr::drop_na()
```

Fit linear models to data and predict to extrapolate to 2022. NB: In some cases, the fitter projects negative production values. These are zeroed out.

```{r}
yrs <- data.frame(year = seq(2019, 2022, by = 1))

food_2019_2022_lm <- food_2014_2018_data %>%
  dplyr::group_by(iso_alpha3, model_group) %>%
  tidyr::nest() %>%
  dplyr::mutate(models = lapply(data, function(df)
    lm(tonnes_yr ~ year, data = df))) %>%
  dplyr::mutate(lm_pred = map(models, ~ predict(., yrs))) %>%
  # dplyr::mutate(lm_pred = map(models, ~predict(., yrs))) %>%
  dplyr::ungroup() %>%
  tidyr::unnest(cols = c(lm_pred)) %>%
  dplyr::select(iso_alpha3, model_group, lm_pred) %>%
  dplyr::mutate(year = rep(seq(2019, 2022, by = 1), 2223)) %>%
  dplyr::rename(tonnes_yr = lm_pred) %>%
  dplyr::mutate(tonnes_yr = ifelse(tonnes_yr < 0, 0, tonnes_yr))
 
```

Do something similar for feed: mean values are fine -- the fitter is throwing rank-deficient fit warnings from some instances.

```{r, warning=FALSE}
feed_2019_2022_lm <- feed_2014_2018_data %>%
  dplyr::group_by(iso_alpha3, model_group) %>%
  tidyr::nest() %>%
  dplyr::mutate(
    models_lm = lapply(data, function(df) lm(tonnes_yr ~ year, data = df)), 
    lm_pred = map(models_lm, ~predict(., yrs))) %>%
  # dplyr::mutate(lm_pred = map(models, ~predict(., yrs))) %>%
  dplyr::ungroup() %>%
  tidyr::unnest(cols = c(lm_pred)) %>%
  dplyr::select(iso_alpha3, model_group, lm_pred) %>%
  dplyr::mutate(year = rep(seq(2019, 2022, by = 1), 1273)) %>%
  dplyr::rename(tonnes_yr = lm_pred)

```

Bind to make harmonized (historical and future projected) food and feed dfs
```{r}
food_2014_2022_est <- food_2014_2018_data %>% 
  bind_rows(food_2019_2022_lm)

feed_2014_2022_est <- feed_2014_2018_data %>% 
  bind_rows(feed_2019_2022_lm)
```

Use crop weight of food and crop ingredient weight of feed from earlier. We will only use the data for years 2023 and after.

```{r}
# # save(food_weight, file = paste0(data_path, "food_weight.Rdata"))
# load(file = paste0(data_path, "food_weight.Rdata")) #food_weight
# 
# # save(feed_ingredient_demand_summary, file = paste0(data_path, "feed_ingredient_demand_summary.Rdata"))
# load(file = paste0(data_path, "feed_ingredient_demand_summary.Rdata")) #feed_ingredient_demand_summary

```

<!-- To determine total food and feed consumption, bind projected food crop (`food_weight`), projected livestock & fish for food (`live_food_weight`), and total projected feed (from animal, fish, and plant products, `feed_ingredient_demand_summary`). -->

<!-- ```{r} -->
<!-- food_proj <- food_weight %>% -->
<!--   dplyr::mutate(tonnes_yr = tonnes_day_food * 365) %>% -->
<!--   dplyr::select(SCENARIO, -->
<!--                 iso_alpha3, -->
<!--                 subregionname, -->
<!--                 diet_plan, -->
<!--                 year, -->
<!--                 model_group, -->
<!--                 tonnes_yr) %>% -->
<!--   dplyr::bind_rows( -->
<!--     live_food_weight %>% -->
<!--       dplyr::mutate(tonnes_yr = tonnes_day_food * 365) %>% -->
<!--       dplyr::select( -->
<!--         SCENARIO, -->
<!--         iso_alpha3, -->
<!--         subregionname, -->
<!--         diet_plan, -->
<!--         year, -->
<!--         model_group, -->
<!--         tonnes_yr -->
<!--       ) -->
<!--   ) %>% -->
<!--   dplyr::mutate(scenario = ifelse( -->
<!--     SCENARIO == "SSP1_v9_130115", -->
<!--     "SSP1", -->
<!--     ifelse( -->
<!--       SCENARIO == "SSP2_v9_130115", -->
<!--       "SSP2", -->
<!--       ifelse( -->
<!--         SCENARIO == "SSP3_v9_130115", -->
<!--         "SSP3", -->
<!--         ifelse(SCENARIO == "SSP4d_v9_130115", -->
<!--                "SSP4", -->
<!--                "SSP5") -->
<!--       ) -->
<!--     ) -->
<!--   )) %>%  -->
<!--   dplyr::select(-SCENARIO) %>%  -->
<!--   dplyr::filter(year > 2022) -->

<!-- feed_proj <- feed_ingredient_demand_summary %>%  -->
<!--   dplyr::mutate(tonnes_yr = tonnes_day*365) %>%  -->
<!--   dplyr::select(-tonnes_day) %>% -->
<!--   dplyr::mutate(scenario = ifelse( -->
<!--     SCENARIO == "SSP1_v9_130115", -->
<!--     "SSP1", -->
<!--     ifelse( -->
<!--       SCENARIO == "SSP2_v9_130115", -->
<!--       "SSP2", -->
<!--       ifelse( -->
<!--         SCENARIO == "SSP3_v9_130115", -->
<!--         "SSP3", -->
<!--         ifelse(SCENARIO == "SSP4d_v9_130115", -->
<!--                "SSP4", -->
<!--                "SSP5") -->
<!--       ) -->
<!--     ) -->
<!--   )) %>%  -->
<!--   dplyr::select(-SCENARIO) %>%  -->
<!--   dplyr::filter(year > 2022) -->

<!-- # food_proj -->
<!-- # feed_proj -->
<!-- ``` -->

Set a target year

```{r}
netzero_target_year <- 2050
```

Confirm continuity between ISO codes so countries represented in 2022 are there in 2023, etc. Fill dummy values in for scenario and diet_plan for the FAO data. These are required for continuity in the spline fitter.

### Food pathways

```{r}
years_tmp <- food_2014_2022_est %>% distinct(year) %>% pull(year)
countries_tmp <- food_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- food_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")


empty_set <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp)
names(empty_set) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario")

```

```{r}
food_2014_2022_est_tmp <- food_2014_2022_est %>%
  full_join(empty_set, by = c("year", "model_group", "iso_alpha3")) %>%
  mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr))

```

Do the same for `pathways` data frame representing values between 2023 and the target year to be filled by the spline values.

```{r}
years_tmp <- seq(2023, netzero_target_year - 1, by = 1)
countries_tmp <- food_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- food_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
tonnes_yr_tmp <- NA

pathways_tmp <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
names(pathways_tmp) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario", "tonnes_yr")
```

Merge the FAO-derived data with the empty pathways data frame.

```{r}
food_data_pathways <- food_2014_2022_est_tmp %>% 
  full_join(pathways_tmp, by = c("year", "model_group", "tonnes_yr", "iso_alpha3", "diet_plan", "scenario"))

head(food_data_pathways)
```

And the same for `food_targets`, the data frame for values at and above the target year.

```{r}
years_tmp <- seq(netzero_target_year, 2080, by = 5)
countries_tmp <- food_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- food_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
tonnes_yr_tmp <- NA

targets_tmp <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
names(targets_tmp) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario", "tonnes_yr")
```

```{r}

food_targets <- food_proj_2020_2100 %>%
  dplyr::filter(year >= netzero_target_year, year <= 2080) %>%
  dplyr::full_join(
    targets_tmp,
    by = c(
      "iso_alpha3",
      "diet_plan",
      "year",
      "model_group",
      "tonnes_yr",
      "scenario"
    )
  ) %>%
  dplyr::mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr)) %>%
  dplyr::filter(!is.na(subregionname)) %>%
  dplyr::select(-subregionname) %>%
  dplyr::mutate(model_group = ifelse(
    model_group == "cereal",
    "cereals",
    ifelse(
      model_group %in% c("bovine_meat", "sus_meat", "caprine_meat"),
      "beef_lamb_pork",
      ifelse(
        model_group == "cereal",
        "cereals",
        ifelse(
          model_group == "bovine_dairy",
          "dairy",
          ifelse(model_group == "fish",
                 "fish_seafood",
                 model_group)
        )
      )
    )
  )) %>%
  dplyr::filter(model_group != "meat_poultry")
  
head(food_targets)

```

Confirm that all countries represented in `data_pathways` are represented in `targets`. For the spline interpolation to work, there must be tie points for all countries, diet_plans, and scenarios at 2022 and the `netzero_target_year`.

```{r}
data_countries <- food_data_pathways %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)
targ_countries <- food_targets %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)

shared_countries <- intersect(data_countries, targ_countries)

food_2014_2022_est_clean <- food_data_pathways %>% 
  dplyr::filter(iso_alpha3 %in% shared_countries)
food_targets_clean <- food_targets %>% 
  dplyr::filter(iso_alpha3 %in% shared_countries)

```

Merge the time series together into a `harmonized_food_data_targets` data frame to run the interpolation on.

```{r}

harmonized_food_data_targets <- food_2014_2022_est_clean %>%
  dplyr::full_join(food_targets_clean, by = c("year", "model_group", "tonnes_yr", "iso_alpha3", "diet_plan", "scenario")) %>% 
  dplyr::arrange(year)

```

Interpolate shift pathways between the FAO food balance data (and linearly interpolated values to 2022 based on the FAO data) and target year values using a spline with all values as tie-points.

```{r}

food_pathways_tmp <- harmonized_food_data_targets %>% 
  # dplyr::filter(year >= 2018) %>% 
  dplyr::group_by(model_group, scenario, diet_plan, iso_alpha3) %>%
  dplyr::mutate(tonnes_yr_interp = stats::spline(
    x = year,
    y = tonnes_yr,
    xout = year,
    ties = "ordered"
  )$y) %>%
  ungroup()

food_pathways <- food_pathways_tmp %>%
  dplyr::select(-tonnes_yr) %>%
  dplyr::rename(tonnes_yr = tonnes_yr_interp)

```

In some cases, this method predicts negative demand values (e.g., Venezuela). In the VEN case, the initial decline in supply was so rapid, that the spline makes a practically unreasonable fit. The number of these unreasonable values amount to just 0.88% of the total number of values; but the number of their associated model_group, country, diet_plan and scenario combinations pathways amount to 8.5% of all possible combinations (hence pathways). In any case, their associated model_group, country, diet_plan and scenario combinations are thrown out of the data set.

```{r}

combos_to_drop <- food_pathways %>% 
  dplyr::filter(tonnes_yr < 0) %>% 
  dplyr::distinct(model_group, iso_alpha3, diet_plan, scenario) %>% 
  dplyr::mutate(keep = "nope")


food_pathways_clean <- food_pathways %>% 
  dplyr::left_join(combos_to_drop) %>%
  dplyr::filter(is.na(keep)) %>% 
  dplyr::select(-keep)

```

```{r}
ggplot(
  food_pathways %>% dplyr::filter(
    scenario == "SSP2",
    diet_plan == "ELA-PHD",
    model_group == "beef_lamb_pork"
  ),
  aes(x = year, y = tonnes_yr * 1e-9)
) + 
  geom_line(aes(colour = iso_alpha3)) + 
  theme_bw() + 
  theme(
    legend.position = "none"
  ) + 
  labs(
    title = "Country level least-cost pathways to future demand target, by year 2050",
    subtitle = "For: SSP2, ELA diet, beef-lamb-pork products only", 
    x = "year", 
    y = "Gt/yr"
  )
```

### Feed pathways

```{r}
years_tmp <- feed_2014_2022_est %>% distinct(year) %>% pull(year)
countries_tmp <- feed_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- feed_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")


empty_set <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp)
names(empty_set) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario")

```

```{r}
feed_2014_2022_est_tmp <- feed_2014_2022_est %>%
  full_join(empty_set, by = c("year", "model_group", "iso_alpha3")) %>%
  mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr))

```

Do the same for `feed_pathways` data frame representing values between 2023 and the target year to be filled by the spline values.

```{r}
years_tmp <- seq(2023, netzero_target_year - 1, by = 1)
countries_tmp <- feed_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- feed_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
tonnes_yr_tmp <- NA

pathways_tmp <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
names(pathways_tmp) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario", "tonnes_yr")
```

Merge the FAO-derived data with the empty pathways data frame.

```{r}
feed_data_pathways <- feed_2014_2022_est_tmp %>% 
  full_join(pathways_tmp, by = c("year", "model_group", "tonnes_yr", "iso_alpha3", "diet_plan", "scenario"))

head(feed_data_pathways)
```

And the same for `feed_targets`, the data frame for values at and above the target year.

```{r}
years_tmp <- seq(netzero_target_year, 2080, by = 5)
countries_tmp <-
  feed_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <-
  feed_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
tonnes_yr_tmp <- NA

targets_tmp <-
  expand.grid(
    years_tmp,
    countries_tmp,
    model_groups_tmp,
    diet_plans_tmp,
    scenarios_tmp,
    tonnes_yr_tmp
  )
names(targets_tmp) <-
  c("year",
    "iso_alpha3",
    "model_group",
    "diet_plan",
    "scenario",
    "tonnes_yr")
```

```{r}
feed_targets <- feed_proj_2020_2100 %>% 
  dplyr::filter(year >= netzero_target_year, year <= 2080) %>% 
  dplyr::full_join(targets_tmp) %>% 
    dplyr::filter(!is.na(subregionname)) %>% 
  dplyr::mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr)) %>% 
  dplyr::select(-subregionname) %>%
  dplyr::mutate(model_group = ifelse(
    model_group == "cereal",
    "cereals",
    ifelse(
      model_group %in% c("bovine_meat", "sus_meat", "caprine_meat"),
      "beef_lamb_pork",
      ifelse(
        model_group == "cereal",
        "cereals",
        ifelse(
          model_group == "bovine_dairy",
          "dairy",
          ifelse(model_group == "fish",
                 "fish_seafood",
                 model_group)
        )
      )
    )
  ))
  
head(feed_targets)
```

Confirm that all countries represented in `data_pathways` are represented in `targets`. For the spline interpolation to work, there must be tie points for all countries, diet_plans, and scenarios at 2022 and 2050.

```{r}
data_countries <- feed_data_pathways %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)
targ_countries <- feed_targets %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)

shared_countries <- intersect(data_countries, targ_countries)

feed_2014_2022_est_clean <- feed_data_pathways %>% 
  dplyr::filter(iso_alpha3 %in% shared_countries)
feed_targets_clean <- feed_targets %>% 
  dplyr::filter(iso_alpha3 %in% shared_countries)

```

Merge into harmonized data frame.

```{r}

harmonized_feed_data_targets <- feed_2014_2022_est_clean %>%
  dplyr::full_join(feed_targets_clean, by = c("year", "model_group", "tonnes_yr", "iso_alpha3", "diet_plan", "scenario")) %>% 
  dplyr::arrange(year)

```

Interpolate shift pathways between the FAO food balance data (and linearly interpolated values to 2022 based on the FAO data) and target year values using a spline with all values as tie-points.

```{r}

feed_pathways_tmp <- harmonized_feed_data_targets %>%
  group_by(model_group, scenario, diet_plan, iso_alpha3) %>%
  mutate(tonnes_yr_interp = stats::spline(
    x = year,
    y = tonnes_yr,
    xout = year,
    ties = "ordered"
  )$y) %>%
  ungroup()

feed_pathways <- feed_pathways_tmp %>%
  dplyr::select(-tonnes_yr) %>%
  dplyr::rename(tonnes_yr = tonnes_yr_interp)

```

In some cases, this method predicts negative demand values (e.g., Venezuela). In the VEN case, the initial decline in supply was so rapid, that the spline makes a practically unreasonable fit. The number of these unreasonable values amount to just 0.88% of the total number of values; but the number of their associated model_group, country, diet_plan and scenario combinations pathways amount to 8.5% of all possible combinations (hence pathways). In any case, their associated model_group, country, diet_plan and scenario combinations are thrown out of the data set.

```{r}

combos_to_drop <- feed_pathways %>% 
  dplyr::filter(tonnes_yr < 0) %>% 
  dplyr::distinct(model_group, iso_alpha3, diet_plan, scenario) %>% 
  dplyr::mutate(keep = "nope")


feed_pathways_clean <- feed_pathways %>% 
  dplyr::left_join(combos_to_drop) %>%
  dplyr::filter(is.na(keep)) %>% 
  dplyr::select(-keep)

```

## Visualization

Let's take a quick look at what cereals for food and feed will look like for all countries under SSP2.
```{r}
p1 <- ggplot(food_pathways_clean %>% 
         dplyr::filter(scenario == "SSP2", model_group == "cereals"), 
       aes(x = year, 
           y = 1e-9*tonnes_yr)) + 
  geom_area(aes(fill = iso_alpha3)) + 
  geom_vline(xintercept = 2050, alpha = 0.8, linetype = 2) + 
  theme_minimal() + 
  theme(
    legend.position = "none"
  ) + 
  labs(
    title = "Food pathways, target year 2050", 
    subtitle = "For: SSP2, cereals only",
    x = "year", 
    y = "Gt/yr"
  ) + 
  facet_wrap(~diet_plan) 

p2 <- ggplot(feed_pathways_clean %>% 
         dplyr::filter(scenario == "SSP2", model_group == "cereals"), 
       aes(x = year, 
           y = 1e-9*tonnes_yr)) + 
  geom_area(aes(fill = iso_alpha3)) + 
  geom_vline(xintercept = 2050, alpha = 0.8, linetype = 2) + 
  theme_minimal() + 
  theme(
    legend.position = "none"
  ) + 
  labs(
    title = "Feed pathways, target year 2050", 
    subtitle = "For: SSP2, cereals only",
    x = "year", 
    y = "Gt/yr"
  ) + 
  facet_wrap(~diet_plan) 
```


```{r}
cowplot::plot_grid(p1, p2, nrow = 2)
```

This looks reasonable.

Combine food and feed pathways.

```{r}

food_tmp <- food_pathways_clean %>% 
  dplyr::mutate(kt_yr_food = ifelse(!is.nan(tonnes_yr), 
                                    tonnes_yr*1e-3, 
                                    0))
feed_tmp <- feed_pathways_clean %>% 
  dplyr::mutate(kt_yr_feed = ifelse(!is.nan(tonnes_yr), 
                                    tonnes_yr*1e-3, 
                                    0))

food_feed_pathways_clean <- food_tmp %>% 
  dplyr::full_join(feed_tmp) %>% 
  dplyr::mutate(kt_yr_food = ifelse(!is.na(kt_yr_food), 
                                    kt_yr_food, 
                                    0), 
                kt_yr_feed = ifelse(!is.na(kt_yr_feed), 
                                    kt_yr_feed, 
                                    0)) %>% 
  dplyr::mutate(kt_yr = kt_yr_food + kt_yr_feed) %>% 
  dplyr::group_by(year, model_group, iso_alpha3, diet_plan, scenario) %>% 
  dplyr::summarise(kt_yr = sum(kt_yr, na.rm = TRUE), 
                   .groups = "drop")
  # dplyr::mutate(kt_yr = rowSums(across(.cols = kt_yr_food:kt_yr_feed), na.rm = TRUE))

```

To visualise these data, I will aggregate food types into animal products, plant products and fish-seafood.

```{r}
food_feed_pathways_agg <- food_feed_pathways_clean %>% 
  dplyr::mutate(food_group = ifelse(model_group %in% c("beef_lamb_pork", "chicken_poultry", "dairy", "eggs"), 
                                    "animal products", 
                                    ifelse(model_group %in% c("fish_seafood"), 
                                           "fish & seafood", 
                                           "plant products"))) %>% 
  dplyr::group_by(year, iso_alpha3, diet_plan, scenario, food_group) %>% 
  dplyr::summarise(kt_yr = sum(kt_yr, na.rm = "TRUE"), 
                   .groups = "drop")

```

```{r}

food_feed_pathways_agg <- food_feed_pathways_agg %>% 
  dplyr::mutate(diet_plan_f = factor(diet_plan, levels = c("ELA-PHD", "CNS-CFP", "FDA-SDP")))

```

Plot the combined global food and feed pathways would look like, with products categorised as animal, plant and fish & seafood products.
```{r}

cols <-
  c(
    "animal products" = "#F17EB8",
    # "dairy" = "#DED560",
    "fish & seafood" = "#489ED3",
    "plant products" = "#EEAF35"
  )
xlabz <- c("CNS-CFP" = "CFP", "ELA-PHD" = "ELA", "FDA-SDP" = "USDA")
labz <-
  c("Animal Products", "Fish and Seafood", "Plant Products")

p3_ssp1 <- ggplot(food_feed_pathways_agg %>% 
               dplyr::group_by(year, diet_plan_f, scenario, food_group) %>% 
               dplyr::summarise(kt_yr = sum(kt_yr, na.rm = TRUE), 
                                .groups = "drop") %>% 
         filter(scenario == "SSP1"), aes(x = year)) +
                      # diet_plan == "ELA-PHD"), aes(x = year)) + 
  geom_hline(yintercept = 0, alpha = 0.8) + 
  geom_area(aes(y = 1e-6*kt_yr, 
                fill = food_group), 
            alpha = 0.8) + 
  geom_vline(xintercept = 2050, alpha = 0.5, linetype = 2, colour = "darkblue") + 
   scale_fill_manual(
    values = cols, 
    labels = labz
  ) +
  theme_minimal() + 
  theme(
    legend.position = "right", 
    legend.title = element_blank(), 
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.55, hjust = 0.9), 
    axis.text.y = element_text(size = 7), 
    axis.title.x = element_text(size = 8), 
    axis.title.y = element_text(size = 8), 
    strip.text = element_text(size = 8)
  ) + 
  labs(
    title = "SSP1", 
    x = "year", 
    y = "billion tonnes"
  ) +
  facet_grid(~diet_plan_f,
             labeller = as_labeller(xlabz)) + 
  coord_cartesian(ylim = c(0, 12.5))

p3_legend_only <- cowplot::get_legend(p3_ssp1)
 
p3_ssp1 <- p3_ssp1 +
  theme(legend.position = "none")

p3_ssp2 <- ggplot(food_feed_pathways_agg %>% 
               dplyr::group_by(year, diet_plan_f, scenario, food_group) %>% 
               dplyr::summarise(kt_yr = sum(kt_yr, na.rm = TRUE), 
                                .groups = "drop") %>% 
         filter(scenario == "SSP2"), aes(x = year)) +
  geom_hline(yintercept = 0, alpha = 0.8) + 
  geom_area(aes(y = 1e-6*kt_yr, 
                fill = food_group), 
            alpha = 0.8) + 
  geom_vline(xintercept = 2050, alpha = 0.5, linetype = 2, colour = "darkblue") + 
   scale_fill_manual(
    values = cols
  ) +
  theme_minimal() + 
  theme(
    legend.position = "none", 
    legend.title = element_blank(), 
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.55, hjust = 0.9), 
    axis.text.y = element_text(size = 7), 
    axis.title.x = element_blank(), 
    axis.title.y = element_blank(), 
    strip.text = element_text(size = 8)
  ) +
  labs(
    title = "SSP2"
  ) + 
  facet_grid(~diet_plan_f,
             labeller = as_labeller(xlabz)) + 
  coord_cartesian(ylim = c(0, 12.5))

p3_ssp3 <- ggplot(food_feed_pathways_agg %>% 
               dplyr::group_by(year, diet_plan_f, scenario, food_group) %>% 
               dplyr::summarise(kt_yr = sum(kt_yr, na.rm = TRUE), 
                                .groups = "drop") %>% 
         filter(scenario == "SSP3"), aes(x = year)) +
  geom_hline(yintercept = 0, alpha = 0.8) + 
  geom_area(aes(y = 1e-6*kt_yr, 
                fill = food_group), 
            alpha = 0.8) + 
  geom_vline(xintercept = 2050, alpha = 0.5, linetype = 2, colour = "darkblue") + 
   scale_fill_manual(
    values = cols
  ) +
  theme_minimal() + 
  theme(
    legend.position = "none", 
    legend.title = element_blank(), 
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.55, hjust = 0.9), 
    axis.text.y = element_text(size = 7), 
    axis.title.x = element_blank(), 
    axis.title.y = element_blank(), 
    strip.text = element_text(size = 8)
  ) + 
  labs(
    title = "SSP3"
  ) +
  facet_grid(~diet_plan_f,
             labeller = as_labeller(xlabz)) + 
  coord_cartesian(ylim = c(0, 12.5))

p3_ssp4 <- ggplot(food_feed_pathways_agg %>% 
               dplyr::group_by(year, diet_plan_f, scenario, food_group) %>% 
               dplyr::summarise(kt_yr = sum(kt_yr, na.rm = TRUE), 
                                .groups = "drop") %>% 
         filter(scenario == "SSP4"), aes(x = year)) +
  geom_hline(yintercept = 0, alpha = 0.8) + 
  geom_area(aes(y = 1e-6*kt_yr, 
                fill = food_group), 
            alpha = 0.8) + 
  geom_vline(xintercept = 2050, alpha = 0.5, linetype = 2, colour = "darkblue") + 
   scale_fill_manual(
    values = cols
    # ,
    # labels = labz
  ) +
  theme_minimal() + 
  theme(
    legend.position = "none", 
    legend.title = element_blank(), 
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.55, hjust = 0.9), 
    axis.text.y = element_text(size = 7), 
    axis.title.x = element_text(size = 8), 
    axis.title.y = element_blank(), 
    strip.text = element_text(size = 8)
  ) + 
  labs(
    title = "SSP4", 
    x = "year"
  ) +
  facet_grid(~diet_plan_f,
             labeller = as_labeller(xlabz)) + 
  coord_cartesian(ylim = c(0, 12.5))

p3_ssp5 <- ggplot(food_feed_pathways_agg %>% 
               dplyr::group_by(year, diet_plan_f, scenario, food_group) %>% 
               dplyr::summarise(kt_yr = sum(kt_yr, na.rm = TRUE), 
                                .groups = "drop") %>% 
         filter(scenario == "SSP5"), aes(x = year)) +
  geom_hline(yintercept = 0, alpha = 0.8) + 
  geom_area(aes(y = 1e-6*kt_yr, 
                fill = food_group), 
            alpha = 0.8) + 
  geom_vline(xintercept = 2050, alpha = 0.5, linetype = 2, colour = "darkblue") + 
   scale_fill_manual(
    values = cols
  ) +
  theme_minimal() + 
  theme(
    legend.position = "none", 
    legend.title = element_blank(), 
    axis.text.x = element_text(size = 7, angle = 90, vjust = 0.55, hjust = 0.9), 
    axis.text.y = element_text(size = 7), 
    axis.title.x = element_blank(), 
    axis.title.y = element_text(size = 8), 
    strip.text = element_text(size = 8)
  ) + 
  labs(
    title = "SSP5", 
    y = "billion tonnes"
  ) +
  facet_grid(~diet_plan_f,
             labeller = as_labeller(xlabz)) + 
  coord_cartesian(ylim = c(0, 12.5))

```


```{r}
pa <- plot_grid(p3_ssp5, p3_ssp1, ncol = 1)
pb <- plot_grid(p3_legend_only, p3_ssp2, NA, ncol = 1, rel_heights = c(0.5, 1, 0.5))
pc <- plot_grid(p3_ssp3, p3_ssp4, ncol = 1)

p3 <- cowplot::plot_grid(pa, pb, pc, ncol = 3)

cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_widths = c(0.1, 0.9), rel_heights = c(0.9, 0.1))

grDevices::jpeg(filename = "Plots/figure_S3.jpg", 
               width = 750, 
               height = 500, 
               units = "px", 
               quality = 1)
cowplot::plot_grid(mitigate_arrow, p3, NA, adapt_arrow, ncol = 2, rel_widths = c(0.1, 0.9), rel_heights = c(0.9, 0.1))
dev.off()

```

## Food and Feed for several target years

Loop over target years 2045, 2050, 2055, 2060, 2065.

```{r, echo=FALSE}
for (year in seq(2045, 2065, by = 5)) {

  netzero_target_year <- year
  
  # For food pathways
  years_tmp <- food_feed_pathways_clean %>% filter(year <= 2022) %>% distinct(year) %>% pull(year)
  countries_tmp <-
    food_feed_pathways_clean %>% filter(year <= 2022) %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
  model_groups_tmp <-
    food_feed_pathways_clean %>% filter(year <= 2022) %>% distinct(model_group) %>% pull(model_group)
  diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
  scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
  
  empty_set <-
    expand.grid(years_tmp,
                countries_tmp,
                model_groups_tmp,
                diet_plans_tmp,
                scenarios_tmp)
  names(empty_set) <-
    c("year", "iso_alpha3", "model_group", "diet_plan", "scenario")
  rm(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp)
  
  food_feed_2014_2022_est <- food_2014_2022_est %>%
    dplyr::bind_rows(feed_2014_2022_est) %>%
    dplyr::group_by(year, model_group, iso_alpha3) %>%
    dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE),
                     .groups = "drop") %>%
    full_join(empty_set, by = c("year", "model_group", "iso_alpha3")) %>%
    mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr))
  
  # Do the same for `pathways` data frame representing values between 2023 and the target year to be filled by the spline values.
  years_tmp <- seq(2023, netzero_target_year - 1, by = 1)
  countries_tmp <-
    food_feed_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
  model_groups_tmp <-
    food_feed_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
  diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
  scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
  tonnes_yr_tmp <- NA
  
  pathways_tmp <-
    expand.grid(
      years_tmp,
      countries_tmp,
      model_groups_tmp,
      diet_plans_tmp,
      scenarios_tmp,
      tonnes_yr_tmp
    )
  names(pathways_tmp) <-
    c("year",
      "iso_alpha3",
      "model_group",
      "diet_plan",
      "scenario",
      "tonnes_yr")
  rm(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
  
  # Merge the FAO-derived data with the empty pathways data frame.
  food_feed_data_pathways <- food_feed_2014_2022_est %>%
    full_join(
      pathways_tmp
    )
  
  # And the same for `food_targets`, the data frame for values at and above the target year.
  years_tmp <- seq(netzero_target_year, 2080, by = 5)
  countries_tmp <-
    food_feed_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
  model_groups_tmp <-
    food_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
  diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
  scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
  tonnes_yr_tmp <- NA
  
  targets_tmp <-
    expand.grid(
      years_tmp,
      countries_tmp,
      model_groups_tmp,
      diet_plans_tmp,
      scenarios_tmp,
      tonnes_yr_tmp
    )
  names(targets_tmp) <-
    c("year",
      "iso_alpha3",
      "model_group",
      "diet_plan",
      "scenario",
      "tonnes_yr")
    rm(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
  
  #food and feed projections to establish targets
  food_feed_proj <- food_proj_2020_2100 %>% 
    dplyr::bind_rows(feed_proj_2020_2100) %>% 
    dplyr::group_by(iso_alpha3, subregionname, diet_plan, year, model_group, scenario) %>% 
    dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                     .groups = "drop")
  
  food_feed_targets <- food_feed_proj %>%
    dplyr::filter(year >= netzero_target_year, year <= 2080) %>%
    dplyr::full_join(targets_tmp) %>%
    # dplyr::mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr)) %>%
    dplyr::filter(!is.na(subregionname)) %>%
    dplyr::select(-subregionname)
  
  data_countries <-
    food_feed_data_pathways %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)
  targ_countries <-
    food_feed_targets %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)
  
  shared_countries <- intersect(data_countries, targ_countries)
  
  food_feed_2014_2022_est_clean <- food_feed_data_pathways %>%
    dplyr::filter(iso_alpha3 %in% shared_countries)
  food_feed_targets_clean <- food_feed_targets %>%
    dplyr::filter(iso_alpha3 %in% shared_countries)
  
  rm(data_countries, targ_countries, shared_countries)
  
  # Merge the time series together into a `harmonized_food_data_targets` data frame to run the interpolation on.
  harmonized_food_feed_data_targets <- food_feed_2014_2022_est_clean %>%
    dplyr::full_join(food_targets_clean) %>%
    dplyr::arrange(year)
  
  harmonized_food_feed_data_targets_agg <- harmonized_food_feed_data_targets %>% 
  dplyr::mutate(food_group = ifelse(model_group %in% c("beef_lamb_pork", "chicken_poultry", "dairy", "eggs"), 
                                    "animal products", 
                                    ifelse(model_group %in% c("fish_seafood"), 
                                           "fish & seafood", 
                                           "plant products"))) %>% 
  dplyr::group_by(year, iso_alpha3, diet_plan, scenario, food_group) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = FALSE), 
                   .groups = "drop")
  
  # Interpolate shift pathways between the FAO food balance data (and linearly interpolated values to 2022 based on the FAO data) and target year values using a spline with all values as tie-points.
  # fn <- function(x, y) {
  #   spline(x, y)
  # }
  # 
  # yrs <- data.frame(year = seq(2019, 2022, by = 1))

  # dplyr::mutate(models = lapply(data, function(df)
  #   lm(tonnes_yr ~ year, data = df))) %>%
  # dplyr::mutate(lm_pred = map(models, ~ predict(., yrs))) %>%
  # dplyr::ungroup() %>%
  # tidyr::unnest(cols = c(lm_pred)) %>%
 
    
    
  food_feed_pathways_tmp <-
    harmonized_food_feed_data_targets_agg %>%
    dplyr::mutate(kt_yr = 1e-3 * tonnes_yr) %>%
    dplyr::select(-tonnes_yr) %>%
    dplyr::group_by(food_group, scenario, diet_plan, iso_alpha3) %>% 
    # filter(iso_alpha3 == "USA") %>% 
    tidyr::nest() %>%
    dplyr::mutate(splined = map(data, ~ mgcv::gam(kt_yr ~ s(
      year, k = 5, bs = "tp"
    ), data = .x))) %>%
    dplyr::mutate(augment_spline = map2(splined, data, ~ broom::augment(.x, newdata = .y))) %>%
    tidyr::unnest(augment_spline) %>%
    dplyr::ungroup()
  
    print(paste(netzero_target_year, timestamp(prefix = "--", suffix = "--"), sep = " | "))
  
    # dplyr::mutate(kt_yr_interp = spline(
    #   x = year,
    #   y = kt_yr,
    #   xout = year,
    #   ties = "ordered"
    # )$y) %>%
    # ungroup()
  
  food_feed_pathways <- food_feed_pathways_tmp %>% 
    dplyr::select(-data, -splined) %>% 
    dplyr::rename(
         kt_yr_fit = `.fitted`, 
      kt_yr_se = `.se.fit`, 
    ) %>% 
    dplyr::mutate(
      target_year = netzero_target_year
    )
  
  rm(food_feed_pathways_tmp, netzero_target_year)
  
  if(year == 2045) {
     Food_feed_pathways <- food_feed_pathways
  } else {
    Food_feed_pathways <- Food_feed_pathways %>% 
      dplyr::bind_rows(food_feed_pathways)
  }
  
}

```

Can investigate whether this is working with a quick test.
```{r}
ggplot(
  Food_feed_pathways %>% filter(
    iso_alpha3 == "USA",
    food_group == "animal products",
    scenario == "SSP3",
    diet_plan == "CNS-CFP", 
    target_year == 2065
  ),
  aes(x = year)
) +
  geom_line(aes(y = kt_yr)) +
  geom_line(aes(y = kt_yr_fit), colour = "blue") 
```

Looks good.

### Pathway Rates of Change

Now take first and second differences from pathways.
```{r}

Food_feed_pathways_curves <- Food_feed_pathways %>% 
  dplyr::filter(year >= 2023) %>% 
  dplyr::mutate(allowed = ifelse(year < target_year, 
                                 TRUE, 
                                 FALSE)) %>% 
  dplyr::filter(allowed != FALSE) %>% 
  dplyr::select(-allowed) %>% 
  dplyr::group_by(food_group, iso_alpha3, diet_plan, scenario, target_year) %>% 
  dplyr::mutate(
    diff1 = kt_yr_fit - lag(kt_yr_fit, n = 1L), 
    diff2 = diff1 - lag(diff1, n = 1L)
  ) %>% 
  dplyr::ungroup()

```

The `Food_feed_pathways_curves` df contains pathway ROCs, diff1, and dROCs, diff2 (pathway curvature).
```{r}
# Food_feed_pathways_curves %>% filter(!year %in% c(2023, 2024))
```

### Historical food balances

Back to historical balances.

```{r}
food_hist_summary <- food_countries %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::full_join(loc_map_reduced) %>% 
  dplyr::filter(iso_alpha3 %in% iso_list_harmonized) %>% 
  dplyr::mutate(source_group = ifelse(model_group %in% c("beef_lamb_pork", "meat_poultry", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products"))) %>% 
  dplyr::group_by(year, source_group) %>% 
  dplyr::summarise(t_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::filter(year <= 2018)

feed_hist_summary <- feed_countries %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::full_join(loc_map_reduced) %>% 
  dplyr::filter(iso_alpha3 %in% iso_list_harmonized) %>% 
  dplyr::mutate(source_group = ifelse(model_group %in% c("beef_lamb_pork", "meat_poultry", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products"))) %>% 
  dplyr::group_by(year, source_group) %>% 
  dplyr::summarise(t_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::filter(year <= 2018)
```


From FAO Food Balance data sheets.
```{r}
fb_hist_df <-
  readr::read_csv(
    file = paste0(
      data_path,
      "/FoodBalanceSheetsHistoric_E_All_Data_(Normalized).csv"
    ),
    col_types = cols(
      `Area Code` = col_double(),
      Area = col_character(),
      `Item Code` = col_double(),
      Item = col_character(),
      `Element Code` = col_double(),
      Element = col_character(),
      `Year Code` = col_double(),
      Year = col_double(),
      Unit = col_character(),
      Value = col_double(),
      Flag = col_character()
    )
  )
```

Standardize the header names.
```{r}
Fb_hist_df <- fb_hist_df %>% 
  dplyr::rename(area_code = `Area Code`, 
                area = Area, 
                item_code = `Item Code`, 
                element_code = `Element Code`, 
                value = Value, 
                unit = Unit,
                element = Element, 
                item = Item, 
                year = Year) %>% 
  dplyr::select(area_code, area, item_code, item, element_code, element, year, unit, value)
```

Map food model groups to the historical data.
```{r}
food_hist_df <- Fb_hist_df %>%
  dplyr::filter(element_code %in% c(5142)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na()

feed_hist_df <- Fb_hist_df %>%
  dplyr::filter(element_code %in% c(5521)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na()

```

Aggregate tonnes of food/feed by model_group.
```{r}

food_hist_countries <- food_hist_df %>% 
  dplyr::group_by(area_code, area, year, model_group) %>% 
  dplyr::summarise(kt_yr = sum(value, na.rm = TRUE), 
                   .groups = "drop")

feed_hist_countries <- feed_hist_df %>% 
  dplyr::group_by(area_code, area, year, model_group) %>% 
  dplyr::summarise(kt_yr = sum(value, na.rm = TRUE), 
                   .groups = "drop")

food_feed_hist_countries <- food_hist_countries %>% 
  dplyr::bind_rows(feed_hist_countries) %>% 
  dplyr::group_by(area_code, area, year, model_group) %>% 
  dplyr::summarise(kt_yr = sum(kt_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(food_group = ifelse(model_group %in% c("beef_lamb_pork", "chicken_poultry", "dairy", "eggs"), 
                                    "animal products", 
                                    ifelse(model_group %in% c("fish_seafood"), 
                                           "fish & seafood", 
                                           "plant products"))) %>% 
  dplyr::group_by(year, area_code, area, food_group) %>% 
  dplyr::summarise(kt_yr = sum(kt_yr, na.rm = "TRUE"), 
                   .groups = "drop")

```

Take first and second differences of the (smoothed) historical data. (I am smoothing the data by taking 3 year rolling means.)

```{r}

food_feed_curv <- food_feed_hist_countries %>%
  dplyr::group_by(area_code, area, food_group) %>%
  dplyr::arrange(year) %>%
  dplyr::mutate(kt_yr_smoothed = zoo::rollapply(kt_yr, 3, mean, fill = NA)) %>%
  dplyr::mutate(diff1 = kt_yr_smoothed - lag(kt_yr_smoothed, 1L),
                diff2 = diff1 - lag(diff1, 1L)) %>%
  dplyr::ungroup() %>%
  tidyr::drop_na() 

```

Map these to geographic subregions (groupings of countries that follow FAO pattern, sometimes continental-scale, sometimes sub-continental, sometimes super-continental). And filter for only those countries shared by future pathways.

```{r}

food_feed_curv_regions <- food_feed_curv %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::select(-area) %>% 
  dplyr::left_join(loc_map_reduced) %>% 
  tidyr::drop_na() %>% 
  dplyr::filter(iso_alpha3 %in% iso_list_harmonized)

```

The rate at which production rate changes in time is the curvature. Show the absolute curvatures for all regions below, in time series.

```{r}
p1 <- ggplot(food_feed_curv_regions %>% 
               dplyr::filter(abs(diff2) >= 1),
             aes(x = year,
                 y = abs(diff2))) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_point(aes(colour = subregionname), alpha = 0.2, alpha = 0.2) + 
  geom_smooth(se = FALSE, size = 0.7, alpha = 0.9) + 
  theme_bw() + 
  theme(legend.position = "none", 
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  labs(
    title = "Historical crop production absolute acceleration (pathway curvature)",
    subtitle = "Source: FAOSTAT (2022)",
    x = "year",
    y = "log absolute curvature (kt/yr/yr)"
  ) + 
  scale_y_log10() + 
  facet_wrap(~ subregionname)

p1
```

## Distribution Analysis

Find out how ROC distributions change globally, for all food types, scenarios, target years, and countries, as a function of diet plan.

```{r}
hist_density_averages <- Food_feed_curv_regions %>% 
  dplyr::select(-kt_yr, -diff2) %>% 
  dplyr::mutate(roc_sign = ifelse(diff1 > 0, 
                                  "pos", 
                                  ifelse(diff1 < 0, 
                                         "neg", 
                                         NA))) %>% 
  tidyr::drop_na() %>% 
  dplyr::group_by(food_group, roc_sign) %>% 
  dplyr::summarise(diff1_ave = mean(diff1, na.rm = TRUE), 
                   .groups = "drop")

pathway_density_averages <- Food_feed_pathways_curves %>% 
  dplyr::select(-kt_yr, -diff2) %>% 
  dplyr::mutate(roc_sign = ifelse(diff1 > 0, 
                                  "pos", 
                                  ifelse(diff1 < 0, 
                                         "neg", 
                                         NA))) %>% 
  tidyr::drop_na() %>% 
  dplyr::group_by(diet_plan, food_group, scenario, target_year, roc_sign) %>% 
  dplyr::summarise(diff1_ave = mean(diff1, na.rm = TRUE), 
                   .groups = "drop") 

pathway_density_ensemble_means <- pathway_density_averages %>% 
  dplyr::group_by(food_group, roc_sign) %>% 
  dplyr::summarise(diff1_em = mean(diff1_ave, na.rm = TRUE, 
                                   .groups = "drop"))

```

## Plot Figure 6

```{r}
cols <-
  c(
    "animal products" = "#F17EB8",
    "fish & seafood" = "#489ED3",
    "plant products" = "#EEAF35"
  )

p2_pos <- ggplot(Food_feed_pathways_curves %>% 
         dplyr::filter(diff1 > 0), 
       mapping = aes(x = diff1)) + 
  geom_density(mapping = aes(fill = food_group), 
               alpha = 0.4, 
               colour = NA) + 
  geom_density(data = Food_feed_curv_regions %>% 
         dplyr::filter(diff1 > 0), 
               mapping = aes(x = diff1), 
               fill = NA, 
         inherit.aes = FALSE) + 
  geom_vline(data = pathway_density_averages %>% 
               dplyr::filter(roc_sign == "pos"), 
             mapping = aes(xintercept = diff1_ave, 
                 colour = food_group), 
             linetype = 1, 
             alpha = 0.1) + 
  geom_vline(data = hist_density_averages %>% 
               dplyr::filter(roc_sign == "pos"), 
             mapping = aes(xintercept = diff1_ave), 
             linetype = 2) + 
   geom_vline(data = pathway_density_ensemble_means %>% 
               dplyr::filter(roc_sign == "pos"), 
             mapping = aes(xintercept = diff1_em), 
                 colour = "blue", 
             linetype = 4) + 
  scale_fill_manual(
    values = cols
  ) +
  scale_colour_manual(
    values = cols
  ) +
  theme_bw() + 
   theme(
    legend.title = element_blank(), 
    legend.position = "bottom", 
    legend.text = element_text(size = 12), 
    axis.title = element_text(size = 12), 
    strip.text = element_text(size = 12), 
    title = element_text(size = 14)
  ) + 
  scale_x_log10(
    breaks = scales::trans_breaks("log10", function(x)
      10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(10 ^
                                                                 .x))
  ) + 
  annotation_logticks(sides = "b", size = 0.4) + 
  coord_cartesian(xlim = c(1e-2, 1e4)) + 
  labs(
    title = "Positive ROC values", 
    x = "ROC (kt/yr)", 
    tag = "A"
  ) +  
  facet_wrap(~food_group)

p2_leg <- cowplot::get_legend(p2_pos) 

p2_pos <- p2_pos + 
  theme(
    legend.position = "none"
  )

p2_neg <- ggplot(Food_feed_pathways_curves %>% 
         dplyr::filter(diff1 < 0), 
       aes(x = abs(diff1))) + 
  geom_density(aes(fill = food_group), 
               alpha = 0.4, 
               colour = NA) + 
  geom_density(data = Food_feed_curv_regions %>% 
         dplyr::filter(diff1 < 0), 
               aes(x = abs(diff1)), 
               fill = NA) + 
  geom_vline(data = pathway_density_averages %>% 
               dplyr::filter(roc_sign == "neg"), 
             aes(xintercept = abs(diff1_ave), 
                 colour = food_group), 
             linetype = 1, 
             alpha = 0.1) + 
  geom_vline(data = hist_density_averages %>% 
               dplyr::filter(roc_sign == "neg"), 
             aes(xintercept = abs(diff1_ave)), 
             linetype = 2) + 
   geom_vline(data = pathway_density_ensemble_means %>% 
               dplyr::filter(roc_sign == "neg"), 
             aes(xintercept = abs(diff1_em)), 
                 colour = "blue", 
             linetype = 4) + 
  scale_fill_manual(
    values = cols
  ) +
  scale_colour_manual(
    values = cols
  ) +
  theme_bw() + 
  theme(
    legend.position = "none", 
    legend.text = element_text(size = 12), 
    axis.title = element_text(size = 12), 
    strip.text = element_text(size = 12), 
    title = element_text(size = 14)
  ) + 
  scale_x_log10(
    breaks = scales::trans_breaks("log10", function(x)
      10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(-10 ^
                                                                 .x))
  ) + 
  annotation_logticks(sides = "b", size = 0.4) + 
  coord_cartesian(xlim = c(1e-2, 1e4)) + 
  labs(
    title = "Negative ROC values", 
    x = "ROC (kt/yr)", 
    tag = "B"
  ) + 
  facet_wrap(~food_group)
```


```{r}

cowplot::plot_grid(p2_pos, p2_neg, p2_leg, ncol = 1, rel_heights = c(0.45, 0.45, 0.1)) 
grDevices::jpeg(filename = "Plots/figure_6.jpg", 
               width = 800, 
               height = 500, 
               units = "px", 
               quality = 1)
cowplot::plot_grid(p2_pos, p2_neg, p2_leg, ncol = 1, rel_heights = c(0.45, 0.45, 0.1)) 
dev.off()

```





Pathways and FAO historical data.

```{r}
Food_feed_pathways_curves_regions <- Food_feed_pathways_curves %>% 
  dplyr::full_join(loc_map_reduced, by = "iso_alpha3") %>% 
  dplyr::filter(!is.na(target_year))
Food_feed_curv_regions <- food_feed_curv_regions %>% 
  dplyr::mutate(diet_plan = "FAO data", 
                scenario = "FAO data")
```


```{r}
readr::write_csv(Food_feed_curv_regions, 
                 file = paste0(data_path, "/pathways_roc.csv"))
```


```{r}

scenar = "SSP3"

rate_palette <- RColorBrewer::brewer.pal(name="Blues", n=9)[5:9]

p_rate_pos <- ggplot(
  data = Food_feed_pathways_curves %>%
    dplyr::filter(diff1 >= 0) %>%
    dplyr::filter(abs(diff1) > threshold_rate, 
                  scenario == scenar),
  mapping = aes(x = diff1)
) +
  geom_density(aes(fill = as.factor(target_year), 
                   colour = as.factor(target_year)), 
               alpha = 0.8, 
               size = 1) + 
  geom_line(
    data = rate_pos_fao_data,
    mapping = aes(x = diff1, y = density), 
    size = 1.1, 
    alpha = 0.8, 
    colour = "red", 
    inherit.aes = FALSE
  ) +
  scale_fill_manual(values = rate_palette) +
  scale_color_manual(values = rate_palette) + 
  geom_vline(xintercept = threshold_rate, 
             linetype = 2, 
             colour = "firebrick", 
             alpha = 0.5) + 
  theme_bw() + 
  theme(
    legend.position = "top", 
    legend.title = element_blank(), 
    legend.text = element_text(size = 12), 
    axis.text.x = element_text(angle = 90, 
                               size = 10), 
    axis.title = element_text(size = 12), 
    strip.text = element_text(size = 12), 
    title = element_text(size = 14)
  ) + 
  labs(
    subtitle = paste0(scenar, ", year-to-year positive rate of change"), 
    x = "ROC (kt/yr)", 
    y = "density"
  ) + 
  coord_cartesian(xlim = c(0, 5e4)) +
  facet_wrap(~ diet_plan)

p_rate_legend <- cowplot::get_legend(p_rate_pos)

p_rate_pos <- p_rate_pos + 
  theme(
    legend.position = "none"
  )

p_rate_neg <- ggplot(
  data = Food_feed_pathways_curves %>%
    dplyr::filter(diff1 < 0) %>%
    dplyr::filter(abs(diff1) > threshold_rate, 
                  scenario == scenar),
  mapping = aes(x = diff1)
) +
  geom_density(aes(fill = as.factor(target_year), 
                   colour = as.factor(target_year)), 
               alpha = 0.8, 
               size = 1) + 
  geom_line(
    data = rate_neg_fao_data,
    mapping = aes(x = -diff1, y = density), 
    size = 1.1, 
    alpha = 0.8, 
    colour = "red", 
    inherit.aes = FALSE
  ) +
  scale_fill_manual(values = rate_palette) +
  scale_color_manual(values = rate_palette) + 
  geom_vline(xintercept = -threshold_rate, 
             linetype = 2, 
             colour = "firebrick", 
             alpha = 0.5) + 
  scale_x_reverse() + 
  theme_bw() + 
  theme(
    legend.position = "none", 
    legend.title = element_blank(), 
    axis.text.x = element_text(angle = 90, 
                               size = 10), 
    axis.title = element_text(size = 12), 
    strip.text = element_text(size = 12), 
    title = element_text(size = 14)
  ) + 
  labs(
    subtitle = paste0(scenar, ", year-to-year negative rate of change"), 
    x = "ROC (kt/yr)", 
    y = "density"
  ) + 
  coord_cartesian(xlim = c(0, -5e4)) +
  facet_wrap(~ diet_plan)


p_rate_pos_pathways <- ggplot_build(p_rate_pos)
p_rate_neg_pathways <- ggplot_build(p_rate_neg)

rate_pos_pathways <- p_rate_pos_pathways$data[[1]] %>%
  dplyr::mutate(diet_plan = ifelse(PANEL == 1,
                                   "CNS-CFP",
                                   ifelse(PANEL == 2,
                                          "ELA-PHD",
                                          "FDA-SDP")), 
                target_year = ifelse(fill == "#6BAED6", 
                                     2045, 
                                     ifelse(fill == "#4292C6", 
                                            2050, 
                                            ifelse(fill == "#2171B5", 
                                                   2055, 
                                                   ifelse(fill == "#08519C", 
                                                          2060, 
                                                                 2065)))), 
                diff1 = x, 
                scenario = scenar, 
                type = "pathway") %>% 
  dplyr::select(type, scenario, diet_plan, target_year, diff1, density) %>% 
  dplyr::mutate(density_rescaled = 1e4*density)

rate_neg_pathways <- p_rate_neg_pathways$data[[1]] %>%
  dplyr::mutate(diet_plan = ifelse(PANEL == 1,
                                   "CNS-CFP",
                                   ifelse(PANEL == 2,
                                          "ELA-PHD",
                                          "FDA-SDP")), 
                target_year = ifelse(fill == "#6BAED6", 
                                     2045, 
                                     ifelse(fill == "#4292C6", 
                                            2050, 
                                            ifelse(fill == "#2171B5", 
                                                   2055, 
                                                   ifelse(fill == "#08519C", 
                                                          2060, 
                                                                 2065)))), 
                diff1 = x, 
                scenario = scenar, 
                type = "pathway") %>% 
  dplyr::select(type, scenario, diet_plan, target_year, diff1, density)

```


```{r}
ggplot(
  data = rate_pos_pathways,
  mapping = aes(x = diff1, 
                y = density)) +
  geom_area(aes(fill = as.factor(target_year), 
                   colour = as.factor(target_year)), 
               alpha = 0.8, 
               size = 1) + 
  geom_line(
    data = rate_pos_fao_data,
    mapping = aes(x = diff1, y = density), 
    size = 1.1, 
    alpha = 0.8, 
    colour = "red", 
    inherit.aes = FALSE
  ) +
  scale_fill_manual(values = rate_palette) +
  scale_color_manual(values = rate_palette) + 
  geom_vline(xintercept = threshold_rate, 
             linetype = 2, 
             colour = "firebrick", 
             alpha = 0.5) + 
  # scale_y_log10() + 
  theme_minimal() + 
  theme(
    legend.position = "none",
    legend.title = element_blank(), 
    axis.text.x = element_text(angle = 90, 
                               size = 7)
  ) + 
  labs(
    subtitle = paste0(scenar, ", year-to-year positive rate of change"), 
    x = "ROC (kt/yr)", 
    y = "density"
  ) + 
  # coord_cartesian(xlim = c(0, 3.5e4)) +
  scale_x_log10(
    breaks = scales::trans_breaks("log10", function(x)
      10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(10 ^
                                                                 .x))
  ) +
  facet_wrap(~ diet_plan)
```


Use normalized histograms to do this test.

```{r}
diff1_hist <- Food_feed_curv_regions %>% 
  dplyr::arrange(diff1) %>% 
  dplyr::pull(diff1) %>% 
  na.omit()

diff2_hist <- Food_feed_curv_regions %>% 
  dplyr::arrange(diff2) %>% 
  dplyr::pull(diff2) %>% 
  na.omit()

```

Histogram these.

```{r}

p_fao_hist_diff1 <- ggplot(data.frame(values = diff1_hist), 
              aes(x = values)) + 
  geom_histogram(binwidth = 500)

fao_hist_data_diff1 <- ggplot_build(p_fao_hist_diff1)$data[[1]]

fao_hist_diff1_df <- fao_hist_data_diff1 %>% 
  dplyr::select(
    x, 
    count
  )


p_fao_hist_diff2 <- ggplot(data.frame(values = diff2_hist), 
              aes(x = values)) + 
  geom_histogram(binwidth = 100)

fao_hist_data_diff2 <- ggplot_build(p_fao_hist_diff2)$data[[1]]

fao_hist_diff2_df <- fao_hist_data_diff2 %>% 
  dplyr::select(
    x, 
    count
  )


```

```{r}

test <- expand.grid(
  scenario = c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5"),
  target_year = seq(2045, 2065, by = 5),
  diet_plan = c("ELA-PHD", "CNS-CFP", "FDA-SDP")
)

test <- data.frame(
  test, 
  index = seq(1, dim(test)[1], by = 1)
)

```

First differences. (This will throw some warnings about removing rows containing non-finite values.)

```{r, warning=FALSE}
# p_path_ls <- list()
Path_diff1_df <- data.frame()
for(scen in c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")) {
  for (yr in seq(2045, 2065, by = 5)) {
    for (diet in c("ELA-PHD", "CNS-CFP", "FDA-SDP")) {
      p_path <- ggplot(
        data = Food_feed_pathways_curves %>%
          dplyr::filter(diet_plan == diet,
                        scenario == scen,
                        target_year == yr),
        aes(x = diff1)
      ) +
        geom_histogram(binwidth = 500)
      
      path_data <- ggplot_build(p_path)$data[[1]]
      path_df <- path_data %>%
        dplyr::select(x,
                      count) %>% 
        dplyr::mutate(
          scenario = scen, 
          diet_plan = diet, 
          target_year = yr
        )
      
      # j <- test %>% 
      #   dplyr::filter(diet_plan == diet,
      #                   scenario == scen,
      #                   target_year == yr) %>% 
      #   dplyr::pull(index)
      # 
      # p_path_ls[[j]] <- p_path
      
      Path_diff1_df <- Path_diff1_df %>% 
        dplyr::bind_rows(path_df)
      
      rm(path_df, path_data)
    }
  }
}


```

Second differences.

```{r, warning=FALSE}
# p_path_ls <- list()
Path_diff2_df <- data.frame()
for(scen in c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")) {
  for (yr in seq(2045, 2065, by = 5)) {
    for (diet in c("ELA-PHD", "CNS-CFP", "FDA-SDP")) {
      p_path <- ggplot(
        data = Food_feed_pathways_curves %>%
          dplyr::filter(diet_plan == diet,
                        scenario == scen,
                        target_year == yr),
        aes(x = diff2)
      ) +
        geom_histogram(binwidth = 100)
      
      path_data <- ggplot_build(p_path)$data[[1]]
      path_df <- path_data %>%
        dplyr::select(x,
                      count) %>% 
        dplyr::mutate(
          scenario = scen, 
          diet_plan = diet, 
          target_year = yr
        )
      
      # j <- test %>% 
      #   dplyr::filter(diet_plan == diet,
      #                   scenario == scen,
      #                   target_year == yr) %>% 
      #   dplyr::pull(index)
      # 
      # p_path_ls[[j]] <- p_path
      
      Path_diff2_df <- Path_diff2_df %>% 
        dplyr::bind_rows(path_df)
      
      rm(path_df, path_data)
    }
  }
}


```

Normalise for area under histograms. I.e., find densities for discrete x-values.

All values

```{r}
# first differences
fao_hist_diff1_norm_df <- fao_hist_diff1_df %>% 
  # filter(x != 0) %>%
  mutate(counts_norm = count/sum(count), 
         cdf = cumsum(counts_norm))

Path_diff1_norm_df <- Path_diff1_df %>% 
  # filter(x != 0) %>%
  group_by(scenario, diet_plan, target_year) %>% 
  dplyr::mutate(counts_norm = count/sum(count), 
         cdf = cumsum(counts_norm)) %>% 
  dplyr::ungroup()

# second differences
fao_hist_diff2_norm_df <- fao_hist_diff2_df %>% 
  # filter(x != 0) %>%
  mutate(counts_norm = count/sum(count), 
         cdf = cumsum(counts_norm))

Path_diff2_norm_df <- Path_diff2_df %>% 
  # filter(x != 0) %>%
  group_by(scenario, diet_plan, target_year) %>% 
  dplyr::mutate(counts_norm = count/sum(count), 
         cdf = cumsum(counts_norm)) %>% 
  dplyr::ungroup()
```


```{r}
Path_diff1_norm_df <- Path_diff1_norm_df %>% 
  dplyr::mutate(diet_plan_f = ifelse(diet_plan == "ELA-PHD", 
                                     "ELA", 
                                     ifelse(diet_plan == "CNS-CFP", 
                                            "CNS", 
                                            "USDA")))
Path_diff1_norm_df$diet_plan_f <- factor(Path_diff1_norm_df$diet_plan_f, levels = c("ELA", "CNS", "USDA"))
```



```{r}

Path_diff1_norm_df <- Path_diff1_norm_df %>% 
  dplyr::mutate(
    diet_plan = if_else(diet_plan == "ELA-PHD", 
                          "ELA", 
                          if_else(diet_plan == "CNS-CFP", 
                                  "CNS", 
                                  "USDA"))
  )

Path_diff1_norm_df$diet_plan_f <- factor(Path_diff1_norm_df$diet_plan, levels = c("ELA", "CNS", "USDA"))

```


```{r}
fao_hist_diff1_pos <- fao_hist_diff1_norm_df %>% 
  filter(x >= 0) %>% 
  summarise(test = mean(counts_norm*x, 
                     na.rm = TRUE))

fao_hist_diff1_neg <- fao_hist_diff1_norm_df %>% 
  filter(x < 0) %>% 
  summarise(test = mean(counts_norm*x, 
                     na.rm = TRUE))

path_diff1_pos <- Path_diff1_norm_df %>% 
  filter(x >= 0) %>% 
  group_by(scenario, diet_plan_f, target_year) %>% 
  summarise(test = mean(counts_norm*x, 
                     na.rm = TRUE), 
            .groups = "drop")

path_diff1_neg <- Path_diff1_norm_df %>% 
  filter(x < 0) %>% 
  group_by(scenario, diet_plan_f, target_year) %>% 
  summarise(test = mean(counts_norm*x, 
                     na.rm = TRUE), 
            .groups = "drop")
```

### Plot Figure 7

```{r}

rate_palette <- brewer.pal(name="Blues", n=9)[5:9]

p_diff1_pos <- ggplot(path_diff1_pos, 
       aes(x = target_year, 
           y = test)) + 
  geom_line(aes(colour = scenario), 
            size = 1.2, 
            alpha = 0.7) + 
  geom_hline(yintercept = fao_hist_diff1_pos$test, 
             # colour = "firebrick", 
             size = 1, 
             linetype = 2) + 
  theme_minimal() + 
  theme(
    legend.title = element_blank(), 
    legend.position = "top", 
    legend.text = element_text(size = 14), 
    axis.text.x = element_text(size = 10), 
    axis.title.x = element_blank(), 
    axis.title.y = element_text(size = 12), 
    panel.spacing = unit(2, "lines"), 
    strip.text = element_text(size = 12), 
    title = element_text(size = 14)
  ) + 
  annotate("text", 
           label = "historical", 
           x = 2063, 
           y = 2, 
           size = 3, 
           colour = "#322F2E") + 
  labs(
    tag = "A", 
    title = "Positive ROC values", 
    y = "mean ROC (kt/yr)"
  ) + 
  scale_colour_manual(values = rate_palette) + 
  scale_y_continuous(labels = scales::label_number(accuracy = 0.01)) + 
  facet_wrap(~ diet_plan_f)

p_legend <- cowplot::get_legend(p_diff1_pos)
 
p_diff1_pos <- p_diff1_pos +
  theme(legend.position = "none")

p_diff1_neg <- ggplot(path_diff1_neg, 
       aes(x = target_year, 
           y = test)) + 
  geom_line(aes(colour = scenario), 
            size = 1.2, 
            alpha = 0.7) + 
  geom_hline(yintercept = fao_hist_diff1_neg$test, 
             # colour = "firebrick", 
             size = 1, 
             linetype = 2) + 
  theme_minimal() + 
  theme(
    legend.position = "none", 
    axis.text.x = element_text(size = 10), 
    axis.title.x = element_blank(), 
    axis.title.y = element_text(size = 12), 
    panel.spacing = unit(2, "lines"), 
    strip.text = element_text(size = 12), 
    title = element_text(size = 14)
  ) + 
  annotate("text", 
           label = "historical", 
           x = 2063, 
           y = -0.8, 
           size = 3, 
           colour = "#322F2E") + 
  labs(
    tag = "B", 
    title = "Negative ROC values", 
    x = "target year to reach the dietary goal", 
    y = "mean ROC (kt/yr)"
  ) + 
  scale_colour_manual(values = rate_palette) + 
  scale_y_continuous(labels = scales::label_number(accuracy = 0.01))  + 
  facet_wrap(~ diet_plan_f)
```

Save to disk.

```{r}
cowplot::plot_grid(p_legend, p_diff1_pos,p_diff1_neg, ncol = 1, rel_heights = c(0.1, 0.8, 0.85))

grDevices::jpeg(filename = "Plots/figure_7.jpg", 
               width = 800, 
               height = 500, 
               units = "px", 
               quality = 1)
cowplot::plot_grid(p_legend, p_diff1_pos,p_diff1_neg, ncol = 1, rel_heights = c(0.1, 0.8, 0.85))
dev.off()
```


```{r}
# readr::write_csv(Food_feed_pathways_curves, file = "~/Data/food_feed_pathways.csv")
# readr::write_csv(Food_feed_curv_regions, file = "~/Data/food_feed_fao_historical.csv")

```

